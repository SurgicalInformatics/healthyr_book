\PassOptionsToPackage{unicode=true}{hyperref} % options for packages loaded elsewhere
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames*,x11names*}{xcolor}
%
\documentclass[12pt,]{krantz}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provides euro and other symbols
\else % if luatex or xelatex
  \usepackage{unicode-math}
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
    \setmonofont[Mapping=tex-ansi,Scale=0.65]{Source Code Pro}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\usepackage{xcolor}
\usepackage{hyperref}
\hypersetup{
            pdftitle={HealthyR: R for healthcare data analysis},
            pdfauthor={Ewen Harrison and Riinu Ots},
            colorlinks=true,
            linkcolor=Maroon,
            filecolor=Maroon,
            citecolor=Blue,
            urlcolor=Blue,
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
% Fix footnotes in tables (requires footnote package)
\IfFileExists{footnote.sty}{\usepackage{footnote}\makesavenoteenv{longtable}}{}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\usepackage{booktabs}
\usepackage{longtable}
\usepackage[bf,singlelinecheck=off]{caption}

\usepackage{framed,color}
\definecolor{shadecolor}{RGB}{248,248,248}

\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.8}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\floatpagefraction}{0.75}

\renewenvironment{quote}{\begin{VF}}{\end{VF}}
\let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}

\makeatletter
\newenvironment{kframe}{%
\medskip{}
\setlength{\fboxsep}{.8em}
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\renewenvironment{Shaded}{\begin{kframe}}{\end{kframe}}

\usepackage{makeidx}
\makeindex

\urlstyle{tt}

\usepackage{amsthm}
\makeatletter
\def\thm@space@setup{%
  \thm@preskip=8pt plus 2pt minus 4pt
  \thm@postskip=\thm@preskip
}
\makeatother

\frontmatter
\usepackage[]{natbib}
\bibliographystyle{apalike}

\title{HealthyR: R for healthcare data analysis}
\author{Ewen Harrison and Riinu Ots}
\date{2019-07-25}

\usepackage{amsthm}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{lemma}{Lemma}[chapter]
\theoremstyle{definition}
\newtheorem{definition}{Definition}[chapter]
\newtheorem{corollary}{Corollary}[chapter]
\newtheorem{proposition}{Proposition}[chapter]
\theoremstyle{definition}
\newtheorem{example}{Example}[chapter]
\theoremstyle{definition}
\newtheorem{exercise}{Exercise}[chapter]
\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\newtheorem*{solution}{Solution}
\let\BeginKnitrBlock\begin \let\EndKnitrBlock\end
\begin{document}
\maketitle

% you may need to leave a few empty pages before the dedication page

%\cleardoublepage\newpage\thispagestyle{empty}\null
%\cleardoublepage\newpage\thispagestyle{empty}\null
%\cleardoublepage\newpage
\thispagestyle{empty}

\begin{center}
Never trust a data scientist - they are always plotting.
%\includegraphics{images/dedication.pdf}
\end{center}

\setlength{\abovedisplayskip}{-5pt}
\setlength{\abovedisplayshortskip}{-5pt}

{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}
\listoftables
\listoffigures
\hypertarget{preface}{%
\chapter*{Preface}\label{preface}}


Version 0.3.1

Contributors: Riinu Ots, Ewen Harrison, Tom Drake, Peter Hall, Kenneth
McLean.

This work is licensed under the Creative Commons
Attribution-NonCommercial-NoDerivs 3.0 United States License. To view a
copy of this license, visit
\url{http://creativecommons.org/licenses/by-nc-nd/3.0/us/}

\hypertarget{why-read-this-book}{%
\section*{Why read this book}\label{why-read-this-book}}


\begin{quote}
We are drowning in information but starved for knowledge.\\
John Naisbitt
\end{quote}

In this age of information, the manipulation, analysis and
interpretation of data has become paramount. Nowhere more so than in the
delivery of healthcare. From the understanding of disease and the
development of new treatments, to the diagnosis and management of
individual patients, the use of data and technology is now an integral
part of the business of healthcare.

Those working in healthcare interact daily with data, often without
realising it. The conversion of this avalanche of information to useful
knowledge is essential for high quality patient care. An important part
of this information revolution is the opportunity for everybody to
become involved in data analysis. This democratisation of data analysis
is driven in part by the open source software movement -- no longer do
we require expensive specialised software to do this.

The statistical programming language, R, is firmly at the heart of this!

This book will take an individual with little or no experience in data
analysis all the way through to performing sophisticated analyses. We
emphasise the importance of understanding the underlying data with
liberal use of plotting, rather than relying on opaque and possibly
poorly understand statistical tests. There are numerous examples
included that can be adapted for your own data, together with our own R
packages with easy-to-use functions.

We have a lot of fun teaching this course and focus on making the
material as accessible as possible. We banish equations in favour of
code and use examples rather than lengthy explanations. We are grateful
to the many individuals and students who have helped refine these and
welcome suggestions and bug reports via
\url{https://github.com/SurgicalInformatics}.

Ewen Harrison and Riinu Ots

August 2019

\hypertarget{structure-of-the-book}{%
\section*{Structure of the book}\label{structure-of-the-book}}


Chapter \ref{r-basics} introduces a new topic, and \ldots{}

\hypertarget{software-information-and-conventions}{%
\section*{Software information and
conventions}\label{software-information-and-conventions}}


I used the \textbf{knitr}\index{knitr} package \citep{xie2015} and the
\textbf{bookdown}\index{bookdown} package \citep{R-bookdown} to compile
my book. My R session information is shown below:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xfun}\OperatorTok{::}\KeywordTok{session_info}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## R version 3.4.4 (2018-03-15)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 16.04.5 LTS
## 
## Locale:
##   LC_CTYPE=en_GB.UTF-8      
##   LC_NUMERIC=C              
##   LC_TIME=en_GB.UTF-8       
##   LC_COLLATE=en_GB.UTF-8    
##   LC_MONETARY=en_GB.UTF-8   
##   LC_MESSAGES=en_GB.UTF-8   
##   LC_PAPER=en_GB.UTF-8      
##   LC_NAME=C                 
##   LC_ADDRESS=C              
##   LC_TELEPHONE=C            
##   LC_MEASUREMENT=en_GB.UTF-8
##   LC_IDENTIFICATION=C       
## 
## Package version:
##   base64enc_0.1.3  bookdown_0.7     compiler_3.4.4  
##   digest_0.6.20    evaluate_0.13    glue_1.3.1      
##   graphics_3.4.4   grDevices_3.4.4  highr_0.8       
##   htmltools_0.3.6  jsonlite_1.6     knitr_1.22      
##   magrittr_1.5     markdown_0.9     methods_3.4.4   
##   mime_0.6         Rcpp_1.0.2       rmarkdown_1.12.4
##   stats_3.4.4      stringi_1.4.3    stringr_1.4.0   
##   tinytex_0.11     tools_3.4.4      utils_3.4.4     
##   xfun_0.6         yaml_2.2.0
\end{verbatim}

Package names are in bold text (e.g., \textbf{rmarkdown}), and inline
code and filenames are formatted in a typewriter font (e.g.,
\texttt{knitr::knit(\textquotesingle{}foo.Rmd\textquotesingle{})}).
Function names are followed by parentheses (e.g.,
\texttt{bookdown::render\_book()}).

\hypertarget{acknowledgments}{%
\section*{Acknowledgments}\label{acknowledgments}}


A lot of people helped me when I was writing the book.

\BeginKnitrBlock{flushright}
Frida Gomam\\
on the Mars
\EndKnitrBlock{flushright}

\hypertarget{installation}{%
\section*{Installation}\label{installation}}


\begin{itemize}
\tightlist
\item
  Download R
\end{itemize}

\url{https://www.r-project.org/}

\begin{itemize}
\tightlist
\item
  Install RStudio
\end{itemize}

\url{https://www.rstudio.com/products/rstudio/}

\begin{itemize}
\tightlist
\item
  Install packages (copy these lines into the Console in RStudio):
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{install.packages}\NormalTok{(}\StringTok{"tidyverse"}\NormalTok{)}

\KeywordTok{install.packages}\NormalTok{(}\StringTok{"gapminder"}\NormalTok{)}

\KeywordTok{install.packages}\NormalTok{(}\StringTok{"gmodels"}\NormalTok{)}

\KeywordTok{install.packages}\NormalTok{(}\StringTok{"Hmisc"}\NormalTok{)}

\KeywordTok{install.packages}\NormalTok{(}\StringTok{"devtools"}\NormalTok{)}

\NormalTok{devtools}\OperatorTok{::}\KeywordTok{install_github}\NormalTok{(}\StringTok{"ewenharrison/finalfit"}\NormalTok{)}

\KeywordTok{install.packages}\NormalTok{(}\StringTok{"pROC"}\NormalTok{)}

\KeywordTok{install.packages}\NormalTok{(}\StringTok{"survminer"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

When working with data, don't copy or type code directly into the
Console. We will only be using the Console for viewing output, warnings,
and errors (and installing packages as in the previous section). All
code should be in a script and executed (=Run) using Control+Enter (line
or section) or Control+Shift+Enter (whole script). Make sure you are
always working in a project (the right-top corner of your RStudio
interface should say ``HealthyR'').

\includegraphics[width=5cm]{images/rstudio_vs_r}

\mainmatter

\hypertarget{part-data-wrangling-and-visualisation}{%
\part{Data wrangling and
visualisation}\label{part-data-wrangling-and-visualisation}}

\hypertarget{your-first-r-plots}{%
\chapter{Your first R plots}\label{your-first-r-plots}}

In this session, we will create five beautiful and colourful barplots in
less than an hour. Do not worry about understanding every single word or
symbol (e.g.~the pipe - \texttt{\%\textgreater{}\%}) in the R code you
are about to see. The purpose of this session is merely to

\begin{itemize}
\tightlist
\item
  gain familiarity with the RStudio interface:

  \begin{itemize}
  \tightlist
  \item
    to know what a script looks like,
  \item
    what is the Environment tab,
  \item
    where do your plots appear.
  \end{itemize}
\end{itemize}

\hypertarget{data}{%
\section{Data}\label{data}}

Load the example dataset which is already saved as an R-Data file
(recognisable by the file extension .rda or .RData):

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggplot2)}

\KeywordTok{source}\NormalTok{(}\StringTok{"1_source_theme.R"}\NormalTok{)}

\KeywordTok{load}\NormalTok{(}\StringTok{"global_burden_disease_long.rda"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

After loading the datasets, investigate your Environment tab
(top-right). You will see two things listed: \texttt{mydata} and
\texttt{mydata2013}, which is a subset of mydata.

Click on the name \texttt{mydata} and it will pop up next to where your
script is. Clicking on the blue button is not as useful (in this
session), but it doesn't do any harm either. Try it.

\hypertarget{first-plot}{%
\section{First plot}\label{first-plot}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }\CommentTok{#press Control-Shift-M to insert this symbol (pipe)}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x      =}\NormalTok{ year,}
             \DataTypeTok{y      =}\NormalTok{ deaths_millions,}
             \DataTypeTok{fill   =}\NormalTok{ cause,}
             \DataTypeTok{colour =}\NormalTok{ cause)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-2-1.pdf}

\texttt{ggplot()} stands for \textbf{grammar of graphics plot} - a user
friendly yet flexible alternative to \texttt{plot()}.

\texttt{aes()} stands for \textbf{aesthetics} - things we can see.

\texttt{geom\_()} stands for \textbf{geometric}.

\hypertarget{question}{%
\subsection{Question}\label{question}}

Why are there two closing brackets - \texttt{))} - after the last
aesthetic (colour)?

\hypertarget{exercise}{%
\subsection{Exercise}\label{exercise}}

Plot the number of deaths in Developed and Developing countries for the
year 2013:

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-3-1.pdf}

\newpage

\hypertarget{comparing-bars-of-different-height}{%
\section{Comparing bars of different
height}\label{comparing-bars-of-different-height}}

\hypertarget{stretch-each-bar-to-100}{%
\subsection{Stretch each bar to 100\%}\label{stretch-each-bar-to-100}}

\texttt{position="fill"} stretches the bars to show relative
contributions:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata2013 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x      =}\NormalTok{ location,}
             \DataTypeTok{y      =}\NormalTok{ deaths_millions,}
             \DataTypeTok{fill   =}\NormalTok{ cause,}
             \DataTypeTok{colour =}\NormalTok{ cause)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{(}\DataTypeTok{position =} \StringTok{"fill"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-4-1.pdf}

\hypertarget{plot-each-bar-next-to-each-other}{%
\subsection{Plot each bar next to each
other}\label{plot-each-bar-next-to-each-other}}

\texttt{position="dodge"} puts the different causes next to each rather
(the default is \texttt{position="stack"}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata2013 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x      =}\NormalTok{ location,}
             \DataTypeTok{y      =}\NormalTok{ deaths_millions,}
             \DataTypeTok{fill   =}\NormalTok{ cause,}
             \DataTypeTok{colour =}\NormalTok{ cause)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{(}\DataTypeTok{position =} \StringTok{"dodge"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-5-1.pdf}

\hypertarget{facets-panels}{%
\section{Facets (panels)}\label{facets-panels}}

Going back to the dataframe with all years (1990 -- 2015), add
\texttt{facet\_wrap(\textasciitilde{}year)} to plot all years at once:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x      =}\NormalTok{ location,}
             \DataTypeTok{y      =}\NormalTok{ deaths_millions,}
             \DataTypeTok{fill   =}\NormalTok{ cause,}
             \DataTypeTok{colour =}\NormalTok{ cause)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{year)}
\end{Highlighting}
\end{Shaded}

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-6-1.pdf}

\hypertarget{extra-using-aethetics-outside-of-the-aes}{%
\section{Extra: using aethetics outside of the
aes()}\label{extra-using-aethetics-outside-of-the-aes}}

\hypertarget{setting-a-constant-fill}{%
\subsection{Setting a constant fill}\label{setting-a-constant-fill}}

Using the \texttt{mydata2013} example again, what does the addition of
\texttt{fill\ =\ "black"} in this code do? Note that putting the
\texttt{ggplot(aes())} code all on one line does not affect the result.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata2013 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ location, }\DataTypeTok{y =}\NormalTok{ deaths_millions, }\DataTypeTok{fill =}\NormalTok{ cause, }\DataTypeTok{colour =}\NormalTok{ cause)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{(}\DataTypeTok{fill =} \StringTok{"black"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-7-1.pdf}

Setting aesthetics (x, y, fill, colour, etc.) outside of \texttt{aes()}
sets them to a constant value. R can recognise of a lot of colour names,
e.g., try ``cornflowerblue'', ``firebrick'', or just ``red'', ``green'',
``blue'', etc. For a full list, search Google for ``Colours in R''. R
also knows HEX codes, e.g. \texttt{fill\ =\ "\#fec3fc"} is pink.

\hypertarget{exercise-1}{%
\subsection{Exercise}\label{exercise-1}}

What is the difference between colour and fill in the context of a
barplot?

Hint: Use \texttt{colour\ =\ "black"} instead of
\texttt{fill\ =\ "black"} to investigate what \texttt{ggplot()} thinks a
colour is.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata2013 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ location, }\DataTypeTok{y =}\NormalTok{ deaths_millions, }\DataTypeTok{fill =}\NormalTok{ cause, }\DataTypeTok{colour =}\NormalTok{ cause))}\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"black"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{01_first_interaction_files/figure-latex/unnamed-chunk-8-1.pdf}

\hypertarget{exercise-2}{%
\subsection{Exercise}\label{exercise-2}}

Why are some of the words in our code quoted (e.g.
\texttt{fill\ =\ "black"}) whereas others are not (e.g.
\texttt{x\ =\ location})?

\hypertarget{two-geoms-for-barplots-geom_bar-or-geom_col}{%
\section{\texorpdfstring{Two geoms for barplots: \texttt{geom\_bar()} or
\texttt{geom\_col()}}{Two geoms for barplots: geom\_bar() or geom\_col()}}\label{two-geoms-for-barplots-geom_bar-or-geom_col}}

Both \texttt{geom\_bar()} and \texttt{geom\_col()} create barplots. If
you:

\begin{itemize}
\tightlist
\item
  Want to visualise the count of different lines in a dataset - use
  geom\_bar()

  \begin{itemize}
  \tightlist
  \item
    For example, if you are using a patient-level dataset (each line is
    a patient record):
    \texttt{mydata\ \%\textgreater{}\%\ \ \ \ \ ggplot(aes(x\ =\ sex))\ +\ \ \ \ geom\_bar()}
  \end{itemize}
\item
  Your dataset is already summarised - use geom\_col()

  \begin{itemize}
  \tightlist
  \item
    For example, in the GBD dataset we use here, each line already
    includes a summarised value (\texttt{deaths\_millions})
  \end{itemize}
\end{itemize}

If you have used R before you might have come across
\texttt{geom\_bar(stat\ =\ "identity")} which is the same as
\texttt{geom\_col()}.

\hypertarget{solutions}{%
\section{Solutions}\label{solutions}}

\textbf{1.2.1:} There is a double closing bracket because \texttt{aes()}
is wrapped inside \texttt{ggplot()} - \texttt{ggplot(aes())}.

\textbf{1.2.2:}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata2013 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x      =}\NormalTok{ location,}
             \DataTypeTok{y      =}\NormalTok{ deaths_millions,}
             \DataTypeTok{fill   =}\NormalTok{ cause,}
             \DataTypeTok{colour =}\NormalTok{ cause)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbf{1.5.2:}

On a barplot, the colour aesthetic outlines the fill. In a later session
we will see, however, that for points and lines, colour is the main
aesthetic to define.

\textbf{1.5.3:}

Words in quotes are generally something set to a constant value
(e.g.~make all outlines black, rather than colour them based on the
cause they are representing). Unquoted words are generally variables (or
functions). If the word ``function'' just threw you, Google "Jesse
Maegan: What the h*ck is a function"

\hypertarget{r-basics}{%
\chapter{R Basics}\label{r-basics}}

The aim of this chapter is to familiarise you with how R works. We will
read in data and start basic manipulations. We will be working with a
shorter version of the Global Burden of Disease dataset that we met
earlier.

\hypertarget{getting-help}{%
\section{Getting help}\label{getting-help}}

RStudio has a built in Help tab. To use the Help tab, click your cursor
on something in your code (e.g. \texttt{read\_csv()}) and press F1. This
will show you the definition and some examples. However, the Help tab is
only useful if you already know what you are looking for but can't
remember exactly how it works. For finding help on things you have not
used before, it is best to Google it. R has about 2 million users so
someone somewhere has had the same question or problem.

\hypertarget{objects-and-functions}{%
\section{Objects and functions}\label{objects-and-functions}}

The two fundamental concepts to understand about statistical programming
are objects and functions. As usual, in this book, we prefer introducing
new concepts using specific examples first. And then define things in
general terms after examples.

The most common data object you will be working with is a table - so
something with rows and columns. It should be regular, e.g., the made-up
example in Table \ref{tab:chap2-tab-examp1}. \footnote{Regular does not
  mean it can't have missing values. Missing values are denoted
  \texttt{NA} which stands for either \texttt{Not\ available} or
  \texttt{Not\ applicable}. In same contexts, these things can have a
  different meaning. For example, since \texttt{var2} is \texttt{NA} for
  all male subjects, it may mean ``Not applicable'', i.e.~something that
  can only be measured in females. Whereas in \texttt{var3}, \texttt{NA}
  is more likely to mean ``Not available'' so real missing data,
  e.g.~lost to follow-up.}

\begin{table}[t]

\caption{\label{tab:chap2-tab-examp1}Example of a table (=tibble once read into R), including missing values denoted NA (Not applicable/Not available).}
\centering
\fontsize{8}{10}\selectfont
\begin{tabular}{rlrrr}
\toprule
id & sex & var1 & var2 & var3\\
\midrule
1 & Male & 4 & NA & 2\\
2 & Female & 1 & 4 & 1\\
3 & Female & 2 & 5 & NA\\
4 & Male & 3 & NA & NA\\
\bottomrule
\end{tabular}
\end{table}

A table can live anywhere: on paper, in a Spreadsheet, in an SQL
database, or it can live in your R Session's Environment. And yes, R
sessions are as fun as they sound, almost as fun as, e.g., music
sessions. We usually initiate and interface R using RStudio, but
everything we talk about here (objects, functions, sessions,
environment) also work when RStudio is not available, but R is. This can
be the case if you are working on a supercomputer that can only serve
the R Console, and not an RStudio IDE (reminder from first chapter:
Integrated Development Environment). So, regularly shaped data in rows
and columns is called table when it lives outside R, but once you read
it into R (import it), we call it a tibble. \footnote{There used to be
  an older version of tables in R - they are called data frames. In most
  cases, \texttt{data\ frames} and \texttt{tibbles} work interchangeably
  (and both are R objects), but \texttt{tibbles} are newer and better.
  Another great alternative to base R's \texttt{data\ frames} are
  \texttt{data\ tables}. In this book, and for most of our day-to-day
  work these days, we use \texttt{tibbles} though.} When you are in one
of your very cool R sessions and read in some data, it goes into this
session's Environment. Everything in your Environment needs to have a
name as you can have multiple tibbles going on at the same time
(\texttt{tibble} is not a name, it is the class of an object). To keep
our code examples easy to follow, we call our example tibble
\texttt{mydata}. In real analysis, you should give your tibbles
meaningful names, e.g., \texttt{patient\_data}, \texttt{lab\_results},
\texttt{annual\_totals}, etc.

So, the tibble named \texttt{mydata} is example of an object that can be
in the Environment of your R Session:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     1 Male       4    NA     2
## 2     2 Female     1     4     1
## 3     3 Female     2     5    NA
## 4     4 Male       3    NA    NA
\end{verbatim}

An example of a function that can be applied on numeric data is
\texttt{mean()}. R functions always have round brackets after their
name. This is for two reasons. First, to easily differentiate them from
objects - which don't have round brackets after their name. Second, and
more important, we can put arguments in these brackets. Arguments can
also be thought of as input, and in data analysis, the most common input
for a function is data: we need to give \texttt{mean()} some data to
average over. It does not make sense (nor will it work) to feed it the
whole tibble that has multiple columns, including patient IDs and a
categorical variable (\texttt{sex}). To quickly extract a single column,
we use the \texttt{\$} symbol like this:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{var1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4 1 2 3
\end{verbatim}

You can ignore the \texttt{\#\#\ {[}1{]}} at the beginning of the
extracted values - this is something that becomes more useful when
printing multiple lines of data as the number in the square brackets
keeps count on how many values we are seeing.

We can then use \texttt{mydata\$var1} as the first argument of
\texttt{mean()} by putting it inside its brackets:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{mean}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{var1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.5
\end{verbatim}

Which tells us that the mean of \texttt{var1} (4, 1, 2, 3) is 2.5. In
this example, \texttt{mydata\$var1} is the first and only argument to
\texttt{mean()}. But what happens if we try to calculate the average
value of \texttt{var2} (NA, 4, 5, NA)?

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{mean}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{var2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] NA
\end{verbatim}

We get an \texttt{NA} (``Not applicable''). We would expect to see an
\texttt{NA} if we tried to, for example, calculate the average of
\texttt{sex}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{mean}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{sex)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in mean.default(mydata$sex): argument is not numeric or logical:
## returning NA
\end{verbatim}

\begin{verbatim}
## [1] NA
\end{verbatim}

In fact, in this case, R also gives us a pretty clear warning suggesting
it can't compute the mean of an argument that is not numeric or logical.
The sentence actually reads pretty fun, as if R was saying it was not
logical to calculate the mean of something that is not numeric. But what
R is actually saying that it is happy to calculate the mean of two types
of variables: numerics or logicals, but what you have passed it is
neither. \footnote{Logical is a data type with two potential values:
  TRUE or FALSE. We will come back to data types shortly.}

So \texttt{mean(mydata\$var2)} does not return an Error, but it also
doesn't return the mean of the numeric values included in this column.
That is because the column includes missing values (\texttt{NAs}), and R
does not want to average over NAs implicitly. It is being cautious -
what if you didn't know there were missing values for some patients? If
you wanted to compare the means of \texttt{var1} and \texttt{var2}
without any further filtering, you would be comparing samples of
different size. Which might be fine if the sample sizes are sufficiently
representative and the values are missing at random. Therefore, if you
decide to ignore the NAs and want to calculate the mean anyway, you can
do so by adding another argument to \texttt{mean()}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{mean}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{var2, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.5
\end{verbatim}

Adding \texttt{na.rm\ =\ TRUE} tells R that you are happy for it to
calculate the mean of any existing values (but to remove - \texttt{rm} -
the \texttt{NA} values). This `removal' excludes the NAs from the
calculation, it does not affect the actual tibble (\texttt{mydata})
holding the dataset. R is case sensitive, so it has look exactly how the
function expects it, so \texttt{na.rm}, not \texttt{NA.rm} etc. There
is, however, no need to memorise how the arguments of functions are
exactly spelled - this is what the Help tab (press \texttt{F1} when the
cursor is on the name of the function) can remind you of. Functions'
help pages are built into R, so an internet connection is not required
for this.

\begin{quote}
Make sure to separate multiple arguments with commas, or R will give you
an error of \texttt{Error:\ unexpected\ symbol}.
\end{quote}

Finally, some functions do not need any arguments to work. A good
example is the \texttt{Sys.time()} which returns the current time and
date. This is very useful when using R to generate and update reports
automatically. Including this means you can always be clear on when the
results were last updated.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{Sys.time}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "2019-07-25 20:43:22 BST"
\end{verbatim}

To summarise, objects and functions work hand in hand. Objects are both
an input as well as the output of a function (what the function
returns). The data values input into a function are usually its first
argument, further arguments can be used to specify a function's
behaviour. When we say ``the function returns'', we are referring to its
output (or an Error if it's one of those days). The returned object can
be different to its input object. In our \texttt{mean()} examples above,
the input object was a column (\texttt{mydata\$var1}: 4, 1, 2, 3),
whereas the output was a single value: 2.5.

\hypertarget{working-with-objects}{%
\section{Working with Objects}\label{working-with-objects}}

To create a new object into our Environment we use the equals sign:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a =}\StringTok{ }\DecValTok{103}
\end{Highlighting}
\end{Shaded}

This reads: the variable \texttt{a} is assigned value 103. You know that
the assignment worked when it shows up in the Environment tab. If we now
run \texttt{a} just on its own, it gets printed back to us:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 103
\end{verbatim}

Similarly, if we run a function without assignment to a variable, it
gets printed but not saved in your Environment:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{seq}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30
\end{verbatim}

\texttt{seq()} is a function that creates a sequence of numbers (+1 by
default) between the two arguments you pass to it in its brackets. We
can assign the result of \texttt{seq(15,\ 30)} into a variable, let's
call it \texttt{example\_sequence}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{example_sequence =}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Doing this creates \texttt{example\_sequence} in our Environment, but it
does not print it.

\begin{quote}
If you save the results of an R function in a variable, it does not get
printed. If you run a function without the assignment (\texttt{=}), its
results get printed, but not saved in a variable.
\end{quote}

You can call your variables (where you assigns new objects or the output
of functions in) pretty much anything you want, as long as it starts
with a letter. It can then include numbers as well, for example, we
could have named the new variable \texttt{sequence\_15\_to\_30}. Spaces
in variable names are not easy to work with, we tend to use underscores
in their place, but you could also use capitalisation, e.g.
\texttt{exampleSequence\ =\ seq(15,\ 30)}.

Finally, R doesn't mind overwriting an existing variable, for example
(notice how we then include the variable on a new line to get it printed
as well as overwritten):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{example_sequence =}\StringTok{ }\NormalTok{example_sequence}\OperatorTok{/}\DecValTok{2}

\NormalTok{example_sequence}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1]  7.5  8.0  8.5  9.0  9.5 10.0 10.5 11.0 11.5 12.0 12.5 13.0 13.5 14.0
## [15] 14.5 15.0
\end{verbatim}

\begin{quote}
Note that many people use \texttt{\textless{}-} instead of \texttt{=}.
They mean the same thing in R: both \texttt{=} and \texttt{\textless{}-}
save what is on the right into the variable name on the left. There is
also a left-to-right operator: \texttt{-\textgreater{}}.
\end{quote}

\hypertarget{pipe--}{%
\section{\texorpdfstring{Pipe -
\texttt{\%\textgreater{}\%}}{Pipe - \%\textgreater{}\%}}\label{pipe--}}

The pipe - denoted \texttt{\%\textgreater{}\%} - is probably the oddest
looking thing you'll see in this book. But please bear with, it is not
as scary as it looks! Furthermore, it is super useful. We use the pipe
to send objects into functions.

In the above examples, we calculated the mean of column \texttt{var1}
from \texttt{mydata} by \texttt{mean(mydata\$var1)}. With the pipe, we
can rewrite this as:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\NormalTok{mydata}\OperatorTok{$}\NormalTok{var1 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2.5
\end{verbatim}

Which reads: ``Working with \texttt{mydata}, we select a single column
called \texttt{var1} (with the \texttt{\$}) \textbf{and then} calculate
the \texttt{mean()}.'' The pipe becomes especially useful once the
analysis includes multiple steps applied one after another. A good way
to read and think of the pipe is \textbf{``and then''}. This piping
business is not standard R functionality and before using it in a
script, you need to tell R this is what you will be doing. The pipe
comes from the ``magrittr'' package (Figure \ref{fig:chap2-fig-pipe}),
but loading the tidyverse will also load the pipe. So library(tidyverse)
initialises everything you need (no need to include library(magrittr)
explicitly).

\begin{quote}
To insert a pipe \texttt{\%\textgreater{}\%}, use the keyboard shortcut
\texttt{Ctrl+Shift+M}.
\end{quote}

With or without the pipe, the general rule ``if the result gets printed
it doesn't get saved'' still applies. To save the result of the function
into a new variable (so it shows up in the Environment), you need to add
the name of the new variable with the assignment operator (\texttt{=}):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mean_result =}\StringTok{ }\NormalTok{mydata}\OperatorTok{$}\NormalTok{var1 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbackslash{}begin\{figure\}
\includegraphics[width=5.56in]{images/chapter02/magrittr}
\textbackslash{}caption\{This is not a pipe. RenÃ© Magritte inspired
artwork by Stefan Milton Bache (creator of \texttt{\%\textgreater{}\%}
in R). Image source:
\url{https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html}\}\label{fig:chap2-fig-pipe}
\textbackslash{}end\{figure\}

\hypertarget{reading-data-into-r}{%
\section{Reading data into R}\label{reading-data-into-r}}

We mentioned before that once a table (e.g.~from spreadsheet or
database) gets read into R we start calling it a \texttt{tibble}. The
most common format data comes to us in is CSV (comma separated values).
CSV is basically an uncomplicated spreadsheet with no formatting or
objects other than a single table with rows and columns (no worksheets
or formulas). Furthermore, you don't need special software to quickly
view a CSV file - a text editor will do, and that includes RStudio.

For example, look at ``example\_data.csv'' in the healthyr project's
folder in Figure \ref{fig:chap2-fig-examplecsv} (this is the Files pane
at the bottom-right corner of your RStudio).

\begin{figure}
\includegraphics[width=7.68in]{images/chapter02/files_csv_example} \caption{View or import a data file.}\label{fig:chap2-fig-examplecsv}
\end{figure}

Clicking on a data file gives us two options: \texttt{View\ File} or
\texttt{Import\ Dataset}. For very standard CSV files, we don't usually
bother with the Import interface and just type in (or copy from a
previous script):

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\NormalTok{example_data =}\StringTok{ }\KeywordTok{read_csv}\NormalTok{(}\StringTok{"example_data.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Without further arguments, \texttt{read\_csv()} defaults to:

\begin{itemize}
\tightlist
\item
  values are delimited by commas (e.g., \texttt{id,\ var1,\ var2,\ ...})
\item
  numbers use decimal point (e.g., \texttt{4.12}), rather than decimal
  comma (e.g., \texttt{4,12})
\item
  the first line has column names (it is a ``header'')
\item
  missing values are empty or denoted NA
\end{itemize}

If your file, however, is different to these, then the
\texttt{Import\ Dataset} interface (Figure
\ref{fig:chap2-fig-examplecsv}) is very useful as it will give you the
relevant \texttt{read\_()} syntax with all the extra arguments filled in
for you.

\begin{figure}
\includegraphics[width=20.44in]{images/chapter02/import_options} \caption{Import: Some of the special settings your data file might have.}\label{fig:chap02-fig-import-tool}
\end{figure}

\begin{figure}
\includegraphics[width=13.08in]{images/chapter02/code_preview} \caption{After using the Import Dataset window, copy-paste the resulting code into your script.}\label{fig:chap02-fig-import-code}
\end{figure}

After selecting the specific options for your import file (there is a
friendly preview window too, so you can immediately see whether R
understands the format of the your data file), DO NOT BE tempted to
press the \texttt{Import} button. Yes, this will read in your dataset
once, but means you have to redo the selections every time you come back
to RStudio. Do copy-paste the code it gives you (e.g., Figure
\ref{fig:chap02-fig-import-code}) into your R script - this way you can
use it over and over again. Making sure all steps are recorded in
scripts makes your workflow reproducible by your future self,
colleagues, supervisors, extraterrestrials.

\begin{quote}
The \texttt{Import\ Dataset} can also help you to read in Excel, SPSS,
Stata, or SAS files (instead of read\_csv(), it will give you
\texttt{read\_excel()}, \texttt{read\_sav()}, \texttt{read\_stata()}, or
`read\_sas()).
\end{quote}

If you've used R before or are trying to make sense of legacy scripts
passed on to you by colleagues, you might see \texttt{read.csv()} rather
than \texttt{read\_csv()}. In short: \texttt{read\_csv()} is faster and
better, and in all new scripts that's what you should use. But in
existing scripts that work and are tested, do not just start replacing
\texttt{read.csv()} with \texttt{read\_csv()}. The thing is,
\texttt{read\_csv()} handles categorical variables slightly differently
\footnote{It does not silently convert strings to factors, i.e., it
  defaults to \texttt{stringsAsFactors\ =\ FALSE}. For those not
  familiar with the terminology here - don't worry, we will cover this
  in just a few sections.}. This means that an R script written using
the \texttt{read.csv()} might not work as expected any more if just
replaced with \texttt{read\_csv()}.

\begin{quote}
Do not start updating and possibly breaking existing R scripts by
replacing base R functions with the tidyverse ones we show here. Do use
the modern functions in any new code you write.
\end{quote}

\hypertarget{reading-in-the-global-burden-of-disease-example-dataset-short-version}{%
\subsection{Reading in the Global Burden of Disease example dataset
(short
version)}\label{reading-in-the-global-burden-of-disease-example-dataset-short-version}}

In the next few chapters of this book, we will be using the Global
Burden of Disease datasets. The Global Burden of Disease Study (GBD) is
the most comprehensive worldwide observational epidemiological study to
date. It describes mortality and morbidity from major diseases, injuries
and risk factors to health at global, national and regional levels.
\footnote{Global Burden of Disease Collaborative Network. Global Burden
  of Disease Study 2017 (GBD 2017) Results. Seattle, United States:
  Institute for Health Metrics and Evaluation (IHME), 2018. Available
  from \url{http://ghdx.healthdata.org/gbd-results-tool}.}

GBD data are publicly available from their website. Table
\ref{tab:chap2-tab-gbd} and Figure \ref{fig:chap2-fig-gbd} show a very
high level version of the propject's data with just 3 variables: cause,
year, deaths (number of people who die of each cause every year). Later,
we will be using a longer dataset with different subgroups and we will
show you how to summarise comprehensive datasets yourself.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\NormalTok{gbd_short =}\StringTok{ }\KeywordTok{read_csv}\NormalTok{(}\StringTok{"data/global_burden_disease_SHORT.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}[t]

\caption{\label{tab:chap2-tab-gbd}Deaths per year from three broad disease categories (short version of the Global Burden of Disease example dataset).}
\centering
\fontsize{8}{10}\selectfont
\begin{tabular}{lcr}
\toprule
cause & year & deaths\\
\midrule
Communicable diseases & 1990 & 15,392,200\\
Injuries & 1990 & 4,260,493\\
Non-communicable diseases & 1990 & 26,825,621\\
\addlinespace
Communicable diseases & 1995 & 15,132,654\\
Injuries & 1995 & 4,543,803\\
Non-communicable diseases & 1995 & 29,407,049\\
\addlinespace
Communicable diseases & 2000 & 14,835,531\\
Injuries & 2000 & 4,568,246\\
Non-communicable diseases & 2000 & 31,138,228\\
\addlinespace
Communicable diseases & 2005 & 13,906,587\\
Injuries & 2005 & 4,500,881\\
Non-communicable diseases & 2005 & 33,015,795\\
\addlinespace
Communicable diseases & 2010 & 12,528,020\\
Injuries & 2010 & 4,718,076\\
Non-communicable diseases & 2010 & 35,592,216\\
\addlinespace
Communicable diseases & 2015 & 10,882,449\\
Injuries & 2015 & 4,486,745\\
Non-communicable diseases & 2015 & 39,452,999\\
\addlinespace
Communicable diseases & 2017 & 10,389,874\\
Injuries & 2017 & 4,484,722\\
Non-communicable diseases & 2017 & 41,071,133\\
\bottomrule
\end{tabular}
\end{table}

\begin{verbatim}
## Warning: Unknown or uninitialised column: 'year'.
\end{verbatim}

\begin{figure}
\centering
\includegraphics{02_basics_files/figure-latex/chap2-fig-gbd-1.pdf}
\caption{\label{fig:chap2-fig-gbd}Causes of death from the Global Burden of
Disease dataset (Table \ref{tab:chap2-tab-gbd}). Data on (B) is the same
as (A) but stacked to show the total (sum) of all causes.}
\end{figure}

\clearpage

\hypertarget{operators-for-filtering-data}{%
\section{Operators for filtering
data}\label{operators-for-filtering-data}}

Operators are symbols that tell R how to handle different pieces of data
or objects. We have already introduced three: \texttt{\$} (selects a
column), \texttt{=} (assignes values or results to a variable), and the
pipe - \texttt{\%\textgreater{}\%} (sends data into a function).

Other common operators are the ones we use for filtering data - these
are called comparison and logical operators. This may be for creating
subgroups, or for excluding outliers or incomplete cases.

The comparison operators that work with numeric data are relatively
straightforward:
\texttt{\textgreater{},\ \textless{},\ \textgreater{}=,\ \textless{}=}.
The first two check whether your values are greater or less than another
value, the last two check for ``greater than or equal to'' and "less
than or equal to. These opreators are most commonly spotted inside the
\texttt{filter()} function:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{<}\StringTok{ }\DecValTok{1995}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 3
##   cause                      year    deaths
##   <chr>                     <dbl>     <dbl>
## 1 Communicable diseases      1990 15392200.
## 2 Injuries                   1990  4260493.
## 3 Non-communicable diseases  1990 26825621.
\end{verbatim}

Here we send the data (\texttt{gbd\_short}) to the \texttt{filter()} and
ask it to retain all years that are less than 1995. The resulting tibble
only includes the year 1990. Now, if we use the \texttt{\textless{}=}
(less than or equal to) operator, both 1990 and 1995 pass the filter:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{<=}\StringTok{ }\DecValTok{1995}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 3
##   cause                      year    deaths
##   <chr>                     <dbl>     <dbl>
## 1 Communicable diseases      1990 15392200.
## 2 Injuries                   1990  4260493.
## 3 Non-communicable diseases  1990 26825621.
## 4 Communicable diseases      1995 15132654.
## 5 Injuries                   1995  4543803.
## 6 Non-communicable diseases  1995 29407049.
\end{verbatim}

Furthermore, the values either side of the operator could both be
variables, e.g.,
\texttt{mydata\ \%\textgreater{}\%\ filter(var2\ \textgreater{}\ var1)}.

To filter for values that are equal to something, we use the \texttt{==}
operator. For example, the first filtering example was actually
equivalent to:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{1995}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 3
##   cause                      year    deaths
##   <chr>                     <dbl>     <dbl>
## 1 Communicable diseases      1995 15132654.
## 2 Injuries                   1995  4543803.
## 3 Non-communicable diseases  1995 29407049.
\end{verbatim}

Accidentally using the single equals (\texttt{=} so the assignment
operator) is a very common mistake and still ocasionally happens to the
best of us. In fact, it happens so often that the error the
\texttt{filter()} function gives when using the wrong one also reminds
us what the correct one was

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\DataTypeTok{year =} \DecValTok{1995}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `year` (`year = 1995`) must not be named, do you need `==`?
\end{verbatim}

\begin{quote}
The answer to 'do you need ==?" is almost always ``Yes R, I do, thank
you''.
\end{quote}

But that's just because \texttt{filter()} is a clever cookie and used to
this very common mistake. There are other useful functions we use these
operators in, but they don't always know to tell us that we've just
confused \texttt{=} for \texttt{==}. So whenever checking for equality
of variables but the result is not what you expect (you'll get an Error,
but not necessary with the same wording as above), remember to check
your \texttt{==} operators first.

R also has two operators for combining multiple comparisons: \& and
\textbar{}, which stand for AND and OR, respectively. For example, we
can filter to only keep the earliest and latest years in the dataset:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{1995} \OperatorTok{|}\StringTok{ }\NormalTok{year }\OperatorTok{==}\StringTok{ }\DecValTok{2017}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 3
##   cause                      year    deaths
##   <chr>                     <dbl>     <dbl>
## 1 Communicable diseases      1995 15132654.
## 2 Injuries                   1995  4543803.
## 3 Non-communicable diseases  1995 29407049.
## 4 Communicable diseases      2017 10389874.
## 5 Injuries                   2017  4484722.
## 6 Non-communicable diseases  2017 41071133.
\end{verbatim}

This reads: take the GBD dataset, send it to the filter to keep rows
where year is equal to 1995 or year is equal to 2017. Using specific
values like we've done there (1995/2017) is called ``hard-coding'',
which is fine if we know for sure we don't want to apply the same script
on an updated dataset. But a cleverer way of achieving the same thing is
to use the \texttt{min()} and \texttt{max()} functions:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\KeywordTok{max}\NormalTok{(year) }\OperatorTok{|}\StringTok{ }\NormalTok{year }\OperatorTok{==}\StringTok{ }\KeywordTok{min}\NormalTok{(year))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 3
##   cause                      year    deaths
##   <chr>                     <dbl>     <dbl>
## 1 Communicable diseases      1990 15392200.
## 2 Injuries                   1990  4260493.
## 3 Non-communicable diseases  1990 26825621.
## 4 Communicable diseases      2017 10389874.
## 5 Injuries                   2017  4484722.
## 6 Non-communicable diseases  2017 41071133.
\end{verbatim}

\begin{table}[t]

\caption{\label{tab:chap2-tab-filtering-operators}Filtering operators.}
\centering
\fontsize{8}{10}\selectfont
\begin{tabular}{lc}
\toprule
Operators & Meaning\\
\midrule
== & Equal to\\
!= & Not equal to\\
< & Less than\\
> & Greater than\\
<= & Less than or equal to\\
>= & Greater then or equal to\\
\& & AND\\
\addlinespace
| & OR\\
\bottomrule
\end{tabular}
\end{table}

\begin{longtable}[]{@{}llll@{}}
\toprule
Symbol & What does & Example & Example result\tabularnewline
\midrule
\endhead
\texttt{\%\textgreater{}\%} & sends data into a function &
\texttt{x\ \%\textgreater{}\%\ print()} & 2\tabularnewline
\texttt{::} & indicates package & \texttt{dplyr::count()} &
\texttt{count()} fn. from the \texttt{dplyr} package\tabularnewline
\texttt{-\textgreater{}} & assigns & \texttt{2\ -\textgreater{}\ x} &
the value of x is now 2\tabularnewline
\bottomrule
\end{longtable}

\texttt{\%in\%} \textbar{} is value in list \textbar{}
\texttt{x\ \%in\%\ c(1,2,3)} \textbar{} TRUE \textbar{}\\
\texttt{\$} \textbar{} select a column \textbar{} \texttt{mydata\$year}
\textbar{} 1990,1996,\ldots{}\textbar{}\\
\texttt{c()} \textbar{} combines values \textbar{} \texttt{c(1,\ 2)}
\textbar{} 1, 2 \textbar{}\\
\texttt{\#} \textbar{} comment\textbar{} \texttt{\#Riinu\ changed\ this}
\textbar{} ignored by R \textbar{}

\hypertarget{worked-examples}{%
\subsection{Worked examples}\label{worked-examples}}

Filter the dataset to only include the year 2000. Save this in a new
variable using the assignment operator.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata_year2000 =}\StringTok{ }\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Let's practice combining multiple selections together.

Reminder: `\textbar{}' means OR and `\&' means AND.

From \texttt{gbd\_short}, select the lines where year is either 1990 or
2017 and cause is ``Communicable diseases'':

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{new_data_selection =}\StringTok{ }\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{((year }\OperatorTok{==}\StringTok{ }\DecValTok{1990} \OperatorTok{|}\StringTok{ }\NormalTok{year }\OperatorTok{==}\StringTok{ }\DecValTok{2013}\NormalTok{) }\OperatorTok{&}\StringTok{ }\NormalTok{cause }\OperatorTok{==}\StringTok{ "Communicable diseases"}\NormalTok{)}

\CommentTok{# Or we can get rid of the extra brackets around the years}
\CommentTok{# by moving cause into a new filter on a new line:}

\NormalTok{new_data_selection =}\StringTok{ }\NormalTok{gbd_short }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{1990} \OperatorTok{|}\StringTok{ }\NormalTok{year }\OperatorTok{==}\StringTok{ }\DecValTok{2013}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(cause }\OperatorTok{==}\StringTok{ "Communicable diseases"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{missing-values-nas-and-filters}{%
\section{Missing values (NAs) and
filters}\label{missing-values-nas-and-filters}}

Filtering for missing values (NAs) needs your special attention and
care. Remember the small example tibble from Table
\ref{tab:chap2-tab-examp1} - it has some NAs in columns \texttt{var2}
and \texttt{var3}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     1 Male       4    NA     2
## 2     2 Female     1     4     1
## 3     3 Female     2     5    NA
## 4     4 Male       3    NA    NA
\end{verbatim}

If we now want to filter for rows where \texttt{var2} is missing,
\texttt{filter(var2\ ==\ NA)} is not the way to do it, it will not work.
Since R is a programming language, it can be a bit stubborn with things
like these. When you ask R to do a comparison using \texttt{==} (or
\texttt{\textless{}}, \texttt{\textgreater{}}, etc.) it expects a value
on each side, but NA is not a value, it is the lack thereof. The way to
filter for missing values is using the \texttt{is.na()} function:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(var2))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 5
##      id sex    var1  var2  var3
##   <int> <chr> <dbl> <dbl> <dbl>
## 1     1 Male      4    NA     2
## 2     4 Male      3    NA    NA
\end{verbatim}

We send \texttt{mydata} to the filter and keep rows where \texttt{var2}
is \texttt{NA}. Note the double brackets at the end: that's because the
inner one belongs to \texttt{is.na()}, and the outer one to
\texttt{filter()}. Missing out a closing bracket is also a very common
source of (minor, easily fixed) mistakes, and it still happens to the
best of us.

If filtering for rows where \texttt{var2} is not missing, we do this:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\StringTok{ }\KeywordTok{is.na}\NormalTok{(var2))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     2 Female     1     4     1
## 2     3 Female     2     5    NA
\end{verbatim}

In R, the exclamation mark (!) means ``not''.

Sometimes you want to drop a specific value (e.g.~an outlier) from the
dataset like this. The small example tibble \texttt{mydata} has 4 rows,
with the values for \texttt{var2} as follows: NA, 4, 5, NA. We can
exclude the row where \texttt{var2} is equal to 5 by using the ``not
equals'' (\texttt{!=})\footnote{\texttt{filter(var2\ !=\ 5)\ is\ equivalent\ to\ filter(!\ var2\ ==\ 5)}}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(var2 }\OperatorTok{!=}\StringTok{ }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     2 Female     1     4     1
\end{verbatim}

However, you'll see that by doing this, R drops the rows where
\texttt{var2} is NA as well, as it can't be sure these missing values
were not equal to 5.

If you want to keep the missing values, you need to make use of the OR
(\texttt{\textbar{}}) operator and the \texttt{is.na()} function:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(var2 }\OperatorTok{!=}\StringTok{ }\DecValTok{5} \OperatorTok{|}\StringTok{ }\KeywordTok{is.na}\NormalTok{(var2))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     1 Male       4    NA     2
## 2     2 Female     1     4     1
## 3     4 Male       3    NA    NA
\end{verbatim}

Being caught out by missing values, either in filters or other functions
is very common (remember mydata\$var2 \%\textgreater{}\% mean() returns
NA unless you add \texttt{na.rm\ =\ TRUE}). This is also why we insist
that you always plot your data first - outliers will reveal themselves
and NA values usually become obivious too.

Another thing we do to stay safe around filters and missing values is
saving the results and making sure the number of rows still add up:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{subset1 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(var2 }\OperatorTok{==}\StringTok{ }\DecValTok{5}\NormalTok{)}

\NormalTok{subset2 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(}\OperatorTok{!}\StringTok{ }\NormalTok{var2 }\OperatorTok{==}\StringTok{ }\DecValTok{5}\NormalTok{)}

\NormalTok{subset1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     3 Female     2     5    NA
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{subset2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 5
##      id sex     var1  var2  var3
##   <int> <chr>  <dbl> <dbl> <dbl>
## 1     2 Female     1     4     1
\end{verbatim}

If the numbers are small, you can now quickly look at RStudio's
Environment tab and figure out whether the number of observations (rows)
in \texttt{subset1} and \texttt{subset2} add up to the whole dataset
(\texttt{mydata}). Or use the \texttt{nrow()} function to as R to tell
you what the number of rows is in each dataset:

Rows in \texttt{mydata}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{nrow}\NormalTok{(mydata)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4
\end{verbatim}

Rows in \texttt{subset1}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{nrow}\NormalTok{(subset1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

Rows in \texttt{subset2}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{nrow}\NormalTok{(subset2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1
\end{verbatim}

Asking R whether adding these two up equals the original size:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{nrow}\NormalTok{(subset1) }\OperatorTok{+}\StringTok{ }\KeywordTok{nrow}\NormalTok{(subset2) }\OperatorTok{==}\StringTok{ }\KeywordTok{nrow}\NormalTok{(mydata)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] FALSE
\end{verbatim}

\hypertarget{types-of-variables}{%
\section{Types of variables}\label{types-of-variables}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata =}\StringTok{ }\NormalTok{gbd_short}
\end{Highlighting}
\end{Shaded}

\textbf{consider structuring as per here:
\url{https://finalfit.org/articles/data_prep.html} - AGREED, will do
asap}

Like many other types of statistical software, R needs to know the
variable type of each column. The main types are:

\hypertarget{characters}{%
\subsection{Characters}\label{characters}}

\textbf{Characters} (sometimes referred to as \emph{strings} or
\emph{character strings}) in R are letters, words, or even whole
sentences (an example of this may be free text comments). We can specify
these using the \texttt{as.character()} function. Characters are
displayed in-between \texttt{""} (or
\texttt{\textquotesingle{}\textquotesingle{}}).

\hypertarget{factors}{%
\subsection{Factors}\label{factors}}

\textbf{Factors} are fussy characters. Factors are fussy because they
have something called levels. Levels are all the unique values this
variable could take - e.g.~like when we looked at
\texttt{mydata\$cause\ \%\textgreater{}\%\ unique()}. Using factors
rather than just characters can be useful because:

\begin{itemize}
\tightlist
\item
  The values factor levels can take is fixed. For example, if the levels
  of your column called \texttt{sex} are ``Male'' and ``Female'' and you
  try to add a new patient where sex is called just ``F'' you will get a
  warning from R. If \texttt{sex} was a character column rather than a
  factor R would have no problem with this and you would end up with
  ``Male'', ``Female'', and ``F'' in your column.
\item
  Levels have an order. When we plotted the different causes of death in
  the last session, R ordered them alphabetically (because
  \texttt{cause} was a character rather than a factor). But if you want
  to use a non-alphabetical order, e.g. ``Communicable
  diseases''-``Non-communicable diseases''-``Injuries'', we need make
  \texttt{cause} into a factor. Making a character column into a factor
  enables us to define and change the order of the levels. Furthermore,
  there are useful tools such as \texttt{fct\_inorder} or
  \texttt{fct\_infreq} that can order factor levels for us.
\end{itemize}

These can be huge benefits, especially as a lot of medical data analyses
include comparing different risks to a reference level. Nevertheless,
the fussiness of factors can sometimes be unhelpful or even frustrating.
For example, if you really did want to add a new level to your
\texttt{gender} column (e.g., ``Prefer not to say'') you will either
have to convert the column to a character, add it, and convert it back
to a factor, or use \texttt{fct\_expand} to add the level and then add
your new line.

\hypertarget{exercise-3}{%
\subsubsection{Exercise}\label{exercise-3}}

Temporarily type \texttt{fct\_inorder} anywhere in your script, then
press F1. Read the \textbf{Description} in the Help tab and discuss with
your neighbour how \texttt{fct\_inorder} and \texttt{fct\_infreq} would
order your factor levels.

\hypertarget{numbers}{%
\subsection{Numbers}\label{numbers}}

Self-explanatory! These are numbers. In R, we specify these using the
\texttt{as.numeric()} function. Numbers without decimal places are
sometimes called integers. Click on the blue arrow in front of
\texttt{mydata} in the Environment tab and see that \texttt{year} is an
\texttt{int} (integer) whereas \texttt{deaths} is a \texttt{num}
(numeric).

\hypertarget{specifying-variable-types}{%
\subsection{Specifying variable types}\label{specifying-variable-types}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{as.character}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{cause)}

\KeywordTok{as.numeric}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{year)}

\KeywordTok{factor}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{year)}

\CommentTok{#Lets save the cause as a factor}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause =}\StringTok{ }\KeywordTok{factor}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{cause)}

\CommentTok{#Now lets print it out}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause}
\end{Highlighting}
\end{Shaded}

\hypertarget{exercise-4}{%
\subsection{Exercise}\label{exercise-4}}

Change the order of the levels in \texttt{mydata\$cause} so that
``Non-communicable diseases'' come before ``Injuries''. Hint: use F1 to
investigate examples of how \texttt{fct\_relevel()} works.

\hypertarget{adding-columns-to-dataframes}{%
\section{Adding columns to
dataframes}\label{adding-columns-to-dataframes}}

If we wanted to add in a new column or variable to our data, we can
simply use the dollar sign `\$' to create a new variable inside a
pre-existing piece of data:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{new =}\StringTok{ }\DecValTok{1}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{new2 =}\StringTok{ }\DecValTok{1}\OperatorTok{:}\DecValTok{21}
\end{Highlighting}
\end{Shaded}

Run these lines and click on \texttt{mydata} in the Environment tab to
check this worked as expected.

Conversely, if we want to delete a specific variable or column we can
use the `NULL' function, or alternatively ask R to \texttt{select()} the
data without the new variable included.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{new =}\StringTok{ }\OtherTok{NULL}

\NormalTok{mydata =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{new2)}
\end{Highlighting}
\end{Shaded}

We can make new variables using calculations based on variables in the
data too.

The mutate function is useful here. All you have to specify within the
mutate function is the name of the variable (this can be new or
pre-existing) and where the new data should come from.

There are two equivalent ways of defining new columns based on a
calculation with a previous column:

\textbf{mutate formally introduced in later chapter. Need to think how
best to present this in book.}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# First option}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{years_from_}\DecValTok{1990}\NormalTok{ =}\StringTok{ }\NormalTok{mydata}\OperatorTok{$}\NormalTok{year }\OperatorTok{-}\StringTok{ }\DecValTok{1990} 
\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths_millions =}\StringTok{ }\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths}\OperatorTok{/}\DecValTok{1000000}

\CommentTok{# Second option (mutate() function)}

\NormalTok{mydata =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{years_from_1990 =}\NormalTok{ year}\DecValTok{-1990}\NormalTok{,}
         \DataTypeTok{deaths_millions =}\NormalTok{ deaths}\OperatorTok{/}\DecValTok{1000000}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

Throughout this course we will be using both of these ways to create or
modify columns. The first option (using the \texttt{\$}) can look neater
when changing a single variable, but when combining multiple ones you
will end up repeating \texttt{mydata\$}. \texttt{mutate()} removes the
duplication, but it does add a new line and brackets.

\hypertarget{rounding-numbers}{%
\section{Rounding numbers}\label{rounding-numbers}}

We can use \texttt{round()} to round the new variables to create
integers.

\hypertarget{exercise-5}{%
\subsection{Exercise}\label{exercise-5}}

Round the new column \texttt{deaths\_millions} to no decimals:

\begin{verbatim}
##  [1] 15  4 27 15  5 29 15  5 31 14  5 33 13  5 36 11  4 39 10  4 41
\end{verbatim}

\begin{itemize}
\item
  How would you round it to 2 decimals? Hint: use F1 to investigate
  \texttt{round()}.
\item
  What do \texttt{ceiling()} and \texttt{floor()} do? Hint: sometimes
  you want to round a number up or down.
\end{itemize}

\hypertarget{the-combine-function-c}{%
\section{The combine function: c()}\label{the-combine-function-c}}

The combine function combines several values: \texttt{c()}

The combine function can be used with numbers or characters (like words
or letters):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{examplelist =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Red"}\NormalTok{, }\StringTok{"Yellow"}\NormalTok{, }\StringTok{"Green"}\NormalTok{, }\StringTok{"Blue"}\NormalTok{)}

\CommentTok{# Ask R to print it by executing it on its own line}

\NormalTok{examplelist}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Red"    "Yellow" "Green"  "Blue"
\end{verbatim}

\hypertarget{exercise-6}{%
\subsection{Exercise}\label{exercise-6}}

There are 18 lines (observations) in mydata. Create a new variable using
\texttt{c()} with 18 values (numbers, words, whichever you like,
e.g.~like we created \texttt{examplelist}). Then add it as new column to
\texttt{mydata\$newlist}. Advanced version: do this using a combination
of \texttt{rep()} and \texttt{c()}.

\newpage

\hypertarget{the-paste-function}{%
\section{\texorpdfstring{The \texttt{paste()}
function}{The paste() function}}\label{the-paste-function}}

The \texttt{paste()} function is used to paste several words or numbers
into one character variable/sentence.

In the paste function we need to specify what we would like to combine,
and what should separate the components. By default, the separation is a
space, but we can change this using the \texttt{sep\ =} option within
the paste function.

So, for example if we wanted to make a sentence:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# }
\CommentTok{#paste("Edinburgh", "is", "Great")}

\CommentTok{# Lets add in full stops}


\KeywordTok{paste}\NormalTok{(}\StringTok{"Edinburgh"}\NormalTok{, }\StringTok{"is"}\NormalTok{, }\StringTok{"Great"}\NormalTok{, }\DataTypeTok{sep =} \StringTok{"."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Edinburgh.is.Great"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# separator needs to go in "" as it is a character}


\CommentTok{# If we really like Edinburgh}

\CommentTok{#paste("Edinburgh", "is", "Great", sep = "!")}

\CommentTok{# If we want to make it one word}

\CommentTok{#paste("Edinburgh", "is", "Great", sep = "") # no separator (still need the brackets)}
\end{Highlighting}
\end{Shaded}

We can also join two different variables together using
\texttt{paste()}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{paste}\NormalTok{(}\StringTok{"Year is"}\NormalTok{, mydata}\OperatorTok{$}\NormalTok{year)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "Year is 1990" "Year is 1990" "Year is 1990" "Year is 1995"
##  [5] "Year is 1995" "Year is 1995" "Year is 2000" "Year is 2000"
##  [9] "Year is 2000" "Year is 2005" "Year is 2005" "Year is 2005"
## [13] "Year is 2010" "Year is 2010" "Year is 2010" "Year is 2015"
## [17] "Year is 2015" "Year is 2015" "Year is 2017" "Year is 2017"
## [21] "Year is 2017"
\end{verbatim}

\hypertarget{exercise-7}{%
\subsection{Exercise}\label{exercise-7}}

Fix this code:

Hint: Think about characters and quotes!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{paste}\NormalTok{(Today is, }\KeywordTok{Sys.Date}\NormalTok{() )}
\end{Highlighting}
\end{Shaded}

\hypertarget{combining-two-dataframes}{%
\section{Combining two dataframes}\label{combining-two-dataframes}}

For combining dataframes based on shared variables we use the joins:
\texttt{left\_join()}, \texttt{right\_join()}, \texttt{inner\_join()},
or \texttt{full\_join()}. Let's split some of the variables in
\texttt{mydata} between two new dataframes: \texttt{first\_data} and
\texttt{second\_data}. For demonstrating the difference between the
different joins, we will only include a subset (first 6 rows) of the
dataset in \texttt{second\_data}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{first_data  =}\StringTok{ }\KeywordTok{select}\NormalTok{(mydata, year, cause, deaths_millions)}
\NormalTok{second_data =}\StringTok{ }\KeywordTok{select}\NormalTok{(mydata, year, cause, deaths_millions) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{slice}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{6}\NormalTok{)}

\CommentTok{# change the order of rows in first_data to demosntrate the join does not rely on the ordering of rows:}
\NormalTok{first_data =}\StringTok{ }\KeywordTok{arrange}\NormalTok{(first_data, deaths_millions)}

\NormalTok{combined_left  =}\StringTok{  }\KeywordTok{left_join}\NormalTok{(first_data, second_data)}
\NormalTok{combined_right =}\StringTok{ }\KeywordTok{right_join}\NormalTok{(first_data, second_data)}
\NormalTok{combined_inner =}\StringTok{ }\KeywordTok{inner_join}\NormalTok{(first_data, second_data)}
\NormalTok{combined_full  =}\StringTok{  }\KeywordTok{full_join}\NormalTok{(first_data, second_data)}
\end{Highlighting}
\end{Shaded}

Those who have used R before, or those who come across older scripts
will have seen \texttt{merge()} instead of the joins. \texttt{merge()}
works similarly to joins, but instead of having the four options defined
clearly at the front, you would have had to use the
\texttt{all\ =\ FALSE,\ all.x\ =\ all,\ all.y\ =\ all} arguments.

\includegraphics{images/databasejoke.jpg}

\hypertarget{exercise-8}{%
\subsection{Exercise}\label{exercise-8}}

Investigate the four new dataframes called \texttt{combined\_} using the
Environment tab and discuss how the different joins (left, right, inner,
full) work.

\hypertarget{the-summary-function}{%
\section{\texorpdfstring{The \texttt{summary()}
function}{The summary() function}}\label{the-summary-function}}

In R, the \texttt{summary()} function provides a quick way of
summarising both data or the results of statistical tests.

Lets get a quick summary of all the variables inside the Global Burden
of Disease dataset. It will work for whole datasets and single variables
too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     cause                year          deaths         years_from_1990
##  Length:21          Min.   :1990   Min.   : 4260493   Min.   : 0.00  
##  Class :character   1st Qu.:1995   1st Qu.: 4568246   1st Qu.: 5.00  
##  Mode  :character   Median :2005   Median :13906587   Median :15.00  
##                     Mean   :2005   Mean   :17196825   Mean   :14.57  
##                     3rd Qu.:2015   3rd Qu.:29407049   3rd Qu.:25.00  
##                     Max.   :2017   Max.   :41071133   Max.   :27.00  
##  deaths_millions
##  Min.   : 4.00  
##  1st Qu.: 5.00  
##  Median :14.00  
##  Mean   :17.19  
##  3rd Qu.:29.00  
##  Max.   :41.00
\end{verbatim}

This even works on statistical tests (we will learn more about these
later):

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# lm stands for linear model}
\KeywordTok{lm}\NormalTok{(deaths }\OperatorTok{~}\StringTok{ }\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ mydata) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = deaths ~ year, data = mydata)
## 
## Residuals:
##       Min        1Q    Median        3Q       Max 
## -14038792 -11631319  -3335985  13231927  22547620 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(>|t|)
## (Intercept) -196781313  616283136  -0.319    0.753
## year            106745     307436   0.347    0.732
## 
## Residual standard error: 13230000 on 19 degrees of freedom
## Multiple R-squared:  0.006305,   Adjusted R-squared:  -0.04599 
## F-statistic: 0.1206 on 1 and 19 DF,  p-value: 0.7322
\end{verbatim}

\hypertarget{when-pipe-sends-data-to-the-wrong-place}{%
\subsection{When pipe sends data to the wrong
place}\label{when-pipe-sends-data-to-the-wrong-place}}

Note that our usual way of doing things with the pipe would not work
here:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(deaths }\OperatorTok{~}\StringTok{ }\NormalTok{year) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

This is because the pipe tries to send data into the first place of the
function (first argument), but \texttt{lm()} wants the formula
(\texttt{deaths\ \textasciitilde{}\ year}) first, then the dataframe. We
can bypass this using \texttt{data\ =\ .} to tell the pipe where to put
mydata:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(deaths }\OperatorTok{~}\StringTok{ }\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ .) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{exercise-9}{%
\subsection{Exercise}\label{exercise-9}}

Try adding a new variable called \texttt{death\_over\_10m} which
indicates whether there were more than 10 million deaths for a cause.
The new variable should take the form `Yes' or `No'.

Then make it into a factor.

Then use \texttt{summary()} to find out about it!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{death_over_10m =} \KeywordTok{ifelse}\NormalTok{(deaths }\OperatorTok{>=}\StringTok{ }\DecValTok{10000000}\NormalTok{, }\StringTok{"Yes"}\NormalTok{, }\StringTok{"No"}\NormalTok{)) }\CommentTok{# Using ifelse}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{death_over_10m =}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{death_over_10m)}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{death_over_10m }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  No Yes 
##   7  14
\end{verbatim}

\hypertarget{extra-creating-a-dataframe-from-scratch}{%
\section{Extra: Creating a dataframe from
scratch}\label{extra-creating-a-dataframe-from-scratch}}

It is rare that you will need to create a data frame by hand as most of
the time you will be reading in a data from a .csv or similar. But in
some cases (e.g.~when creating special labels for a plot) it might be
useful, so this is how to create one:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{patient_id =}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{)}
\NormalTok{sex        =}\StringTok{ }\KeywordTok{rep}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"Female"}\NormalTok{, }\StringTok{"Male"}\NormalTok{), }\DecValTok{5}\NormalTok{)}
\NormalTok{age        =}\StringTok{ }\DecValTok{18}\OperatorTok{:}\DecValTok{27}

\NormalTok{newdata =}\StringTok{ }\KeywordTok{data_frame}\NormalTok{(patient_id, sex, age)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: `data_frame()` is deprecated, use `tibble()`.
## This warning is displayed once per session.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# same as}

\NormalTok{newdata      =}\StringTok{ }\KeywordTok{data_frame}\NormalTok{(}
  \DataTypeTok{patient_id =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\DecValTok{1}\OperatorTok{:}\DecValTok{10}\NormalTok{), }\CommentTok{#note the commas}
  \DataTypeTok{sex        =} \KeywordTok{rep}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\StringTok{"Female"}\NormalTok{, }\StringTok{"Male"}\NormalTok{), }\DecValTok{5}\NormalTok{),}
  \DataTypeTok{age        =} \DecValTok{18}\OperatorTok{:}\DecValTok{27}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

If we used \texttt{data.frame()} instead of \texttt{data\_frame()}, all
our character variables (\texttt{patient\_id}, \texttt{sex}) would
become factors automatically. This might make sense for \texttt{sex},
but it doesn't for \texttt{patient\_id}.

\hypertarget{exercise-10}{%
\subsection{Exercise}\label{exercise-10}}

Create a new dataframe called \texttt{my\_dataframe} that looks like
this:

Hint: Use the functions \texttt{paste0()}, \texttt{seq()} and
\texttt{rep()}

\begin{verbatim}
## # A tibble: 10 x 3
##    patient_id   age sex   
##    <chr>      <dbl> <chr> 
##  1 ID11          15 Male  
##  2 ID12          20 Male  
##  3 ID13          25 Male  
##  4 ID14          30 Male  
##  5 ID15          35 Male  
##  6 ID16          40 Female
##  7 ID17          45 Female
##  8 ID18          50 Female
##  9 ID19          55 Female
## 10 ID20          60 Female
\end{verbatim}

\hypertarget{solutions-1}{%
\section{Solutions}\label{solutions-1}}

\textbf{2.5.3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{names}\NormalTok{()}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{head}\NormalTok{()}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }\KeywordTok{str}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbf{2.5.4}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }\KeywordTok{length}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3
\end{verbatim}

\textbf{2.6.2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata_year2000 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{2.7.5}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause }\OperatorTok{%>%}\StringTok{ }\KeywordTok{fct_relevel}\NormalTok{(}\StringTok{"Injuries"}\NormalTok{, }\DataTypeTok{after =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{2.10.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths_millions =}\StringTok{ }\KeywordTok{round}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{deaths_millions)}

\CommentTok{# or}
\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths_millions =}\StringTok{ }\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths_millions }\OperatorTok{%>%}\StringTok{ }\KeywordTok{round}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbf{2.11.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{examplelist =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Red"}\NormalTok{, }\StringTok{"Yellow"}\NormalTok{, }\StringTok{"Green"}\NormalTok{, }\StringTok{"Blue"}\NormalTok{,}
                \StringTok{"Red"}\NormalTok{, }\StringTok{"Yellow"}\NormalTok{, }\StringTok{"Green"}\NormalTok{, }\StringTok{"Blue"}\NormalTok{,}
                \StringTok{"Red"}\NormalTok{, }\StringTok{"Yellow"}\NormalTok{, }\StringTok{"Green"}\NormalTok{, }\StringTok{"Blue"}\NormalTok{,}
                \StringTok{"Red"}\NormalTok{, }\StringTok{"Yellow"}\NormalTok{, }\StringTok{"Green"}\NormalTok{, }\StringTok{"Blue"}\NormalTok{,}
                \StringTok{"Red"}\NormalTok{, }\StringTok{"Yellow"}\NormalTok{, }\StringTok{"Green"}\NormalTok{, }\StringTok{"Blue"}\NormalTok{,}
                \StringTok{"Green"}\NormalTok{)}

\CommentTok{#Let's see what we've made by using print}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{newlist =}\StringTok{ }\NormalTok{examplelist}


\CommentTok{# using rep()}

\CommentTok{#examplelist2 = rep(c("Green", "Red"), 9)}
\end{Highlighting}
\end{Shaded}

\textbf{2.12.1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{paste}\NormalTok{(}\StringTok{"Today is"}\NormalTok{, }\KeywordTok{Sys.Date}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\textbf{2.15.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my_dataframe =}\StringTok{ }\KeywordTok{data_frame}\NormalTok{(}
  \DataTypeTok{patient_id =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\DecValTok{11}\OperatorTok{:}\DecValTok{20}\NormalTok{),}
  \DataTypeTok{age        =} \KeywordTok{seq}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{60}\NormalTok{, }\DecValTok{5}\NormalTok{),}
  \DataTypeTok{sex        =} \KeywordTok{c}\NormalTok{( }\KeywordTok{rep}\NormalTok{(}\StringTok{"Male"}\NormalTok{, }\DecValTok{5}\NormalTok{), }\KeywordTok{rep}\NormalTok{(}\StringTok{"Female"}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{summarising-data}{%
\chapter{Summarising data}\label{summarising-data}}

In this session we will get to know our three best friends for
summarising data: \texttt{group\_by()}, \texttt{summarise()}, and
\texttt{mutate()}.

\hypertarget{data-1}{%
\section{Data}\label{data-1}}

In Session 2, we used a very condensed version of the Global Burden of
Disease data. We are now going back to a longer one and we will learn
how to summarise it ourselves.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{source}\NormalTok{(}\StringTok{"healthyr_theme.R"}\NormalTok{)}
\KeywordTok{load}\NormalTok{(}\StringTok{"global_burden_disease_long.rda"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We were already using this longer dataset in Session 1, but with
\texttt{colour=cause} to hide the fact that the total deaths in each
year was made up of 12 groups of data (as the black lines on the bars
indicate):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ deaths_millions, }\DataTypeTok{fill =}\NormalTok{ cause))}\OperatorTok{+}\StringTok{ }
\StringTok{    }\KeywordTok{geom_col}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"black"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_summarising_files/figure-latex/unnamed-chunk-2-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{1990}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##      location                     cause    sex year deaths_millions
## 1  Developing Non-communicable diseases   Male 1990       9.2277141
## 2  Developing Non-communicable diseases Female 1990       8.0242455
## 3   Developed Non-communicable diseases   Male 1990       4.7692902
## 4   Developed Non-communicable diseases Female 1990       4.9722431
## 5  Developing                  Injuries   Male 1990       2.2039625
## 6  Developing                  Injuries Female 1990       1.2698308
## 7   Developed                  Injuries   Male 1990       0.5941184
## 8   Developed                  Injuries Female 1990       0.2578759
## 9  Developing     Communicable diseases   Male 1990       7.9819728
## 10 Developing     Communicable diseases Female 1990       7.5416376
## 11  Developed     Communicable diseases   Male 1990       0.3387820
## 12  Developed     Communicable diseases Female 1990       0.2870169
\end{verbatim}

\hypertarget{tidyverse-packages-ggplot2-dplyr-tidyr-etc.}{%
\section{Tidyverse packages: ggplot2, dplyr, tidyr,
etc.}\label{tidyverse-packages-ggplot2-dplyr-tidyr-etc.}}

Most of the functions introduced in this session come from the tidyverse
family (\url{http://tidyverse.org/}), rather than Base R. Including
\texttt{library(tidyverse)} in your script loads a list of packages:
ggplot2, dplyr, tidry, forcats, etc.

\includegraphics[width=20.71in]{images/library_vs_package}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\end{Highlighting}
\end{Shaded}

\hypertarget{basic-functions-for-summarising-data}{%
\section{Basic functions for summarising
data}\label{basic-functions-for-summarising-data}}

You can always pick a column and ask R to give you the \texttt{sum()},
\texttt{mean()}, \texttt{min()}, \texttt{max()}, etc. for it:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths_millions }\OperatorTok{%>%}\StringTok{ }\KeywordTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 309.4174
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{deaths_millions }\OperatorTok{%>%}\StringTok{ }\KeywordTok{mean}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4.297463
\end{verbatim}

But if you want to get the total number of deaths for each \texttt{year}
(or \texttt{cause}, or \texttt{sex}, whichever grouping variables you
have in your dataset) you can use \texttt{group\_by()} and
\texttt{summarise()} that make subgroup analysis very convenient and
efficient.

\hypertarget{subgroup-analysis-group_by-and-summarise}{%
\section{\texorpdfstring{Subgroup analysis: \texttt{group\_by()} and
\texttt{summarise()}}{Subgroup analysis: group\_by() and summarise()}}\label{subgroup-analysis-group_by-and-summarise}}

The \texttt{group\_by()} function tells R that you are about to perform
subgroup analysis on your data. It retains information about your
groupings and calculations are applied on each group separately. To go
back to summarising the whole dataset again use \texttt{ungroup()}. Note
that \texttt{summarise()} is different to the \texttt{summary()}
function we used in Session 2.

With \texttt{summarise()}, we can calculate the total number of deaths
per year:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_per_year =} \KeywordTok{sum}\NormalTok{(deaths_millions)) ->}
\StringTok{    }\NormalTok{summary_data1}


\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year, cause) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_per_cause =} \KeywordTok{sum}\NormalTok{(deaths_millions)) ->}
\StringTok{    }\NormalTok{summary_data2}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  \texttt{summary\_data1} includes the total number of deaths per year.
\item
  \texttt{summary\_data2} includes the number of deaths per cause per
  year.
\end{itemize}

\begin{tabular}{c|c}
\hline
year & total\_per\_year\\
\hline
1990 & 47\\
\hline
1995 & 50\\
\hline
2000 & 51\\
\hline
2005 & 52\\
\hline
2010 & 54\\
\hline
2013 & 55\\
\hline
\end{tabular}

\begin{tabular}{c|c|c}
\hline
year & cause & total\_per\_cause\\
\hline
1990 & Communicable diseases & 16\\
\hline
1990 & Injuries & 4\\
\hline
1990 & Non-communicable diseases & 27\\
\hline
1995 & Communicable diseases & 15\\
\hline
1995 & Injuries & 5\\
\hline
1995 & Non-communicable diseases & 30\\
\hline
\end{tabular}

\ldots{} remaining years omitted from printing.

\hypertarget{exercise-11}{%
\subsection{Exercise}\label{exercise-11}}

Compare the sizes - number of rows (observations) and number of columns
(variables) - of \texttt{mydata}, \texttt{summary\_data1}, and
\texttt{summary\_data2} (in the Environment tab).

\begin{itemize}
\tightlist
\item
  Convince yourself that for 1990, deaths by the three causes
  (\texttt{summary\_data2}) add up to total deaths per year
  (\texttt{summary\_data1}).
\item
  \texttt{summary\_data2} has exactly 3 times as many rows as
  \texttt{summary\_data1}. Why?
\item
  \texttt{mydata} has 5 variables, whereas the summarised dataframes
  have 2 and 3. Which variables got dropped? Why?
\end{itemize}

\hypertarget{exercise-12}{%
\subsection{Exercise}\label{exercise-12}}

For each cause, calculate its percentage to total deaths in each year.

Hint: Use \texttt{full\_join()} on \texttt{summary\_data1} and
\texttt{summary\_data2}.

Solution:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{alldata =}\StringTok{ }\KeywordTok{full_join}\NormalTok{(summary_data1, summary_data2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Joining, by = "year"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{alldata}\OperatorTok{$}\NormalTok{percentage =}\StringTok{ }\DecValTok{100}\OperatorTok{*}\NormalTok{alldata}\OperatorTok{$}\NormalTok{total_per_cause}\OperatorTok{/}\NormalTok{alldata}\OperatorTok{$}\NormalTok{total_per_year }\OperatorTok{%>%}\StringTok{ }\KeywordTok{round}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{table}[t]

\caption{\label{tab:unnamed-chunk-10}alldata}
\centering
\begin{tabular}{ccccc}
\toprule
year & total\_per\_year & cause & total\_per\_cause & percentage\\
\midrule
1990 & 47 & Communicable diseases & 16 & 34\\
1990 & 47 & Injuries & 4 & 9\\
1990 & 47 & Non-communicable diseases & 27 & 57\\
1995 & 50 & Communicable diseases & 15 & 31\\
1995 & 50 & Injuries & 5 & 9\\
\addlinespace
1995 & 50 & Non-communicable diseases & 30 & 60\\
\bottomrule
\end{tabular}
\end{table}

\texttt{round()} defaults to 0 digits. If you want to round to a
specified number of decimal places, use, e.g., round(digits = 2).

\hypertarget{mutate}{%
\section{\texorpdfstring{\texttt{mutate()}}{mutate()}}\label{mutate}}

Mutate works similarly to \texttt{summarise()} (as in it respects
groupings set with \texttt{group\_by()}), but it adds a new column into
the original data. \texttt{summarise()}, on the other hand, condenses
the data into a minimal table that only includes the variables
specifically asked for.

\hypertarget{exercise-13}{%
\subsection{Exercise}\label{exercise-13}}

Investigate these examples to learn how \texttt{summarise()} and
\texttt{mutate()} differ.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summarise_example =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_deaths =} \KeywordTok{sum}\NormalTok{(deaths_millions)) }

\NormalTok{mutate_example =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{total_deaths =} \KeywordTok{sum}\NormalTok{(deaths_millions))}
\end{Highlighting}
\end{Shaded}

\begin{table}[t]

\caption{\label{tab:unnamed-chunk-12}summarise example}
\centering
\begin{tabular}{c}
\toprule
total\_deaths\\
\midrule
309\\
\bottomrule
\end{tabular}
\end{table}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate_example }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{slice}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\NormalTok{knitr}\OperatorTok{::}\KeywordTok{kable}\NormalTok{(}\DataTypeTok{digits =} \DecValTok{0}\NormalTok{,}
               \DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{,}
               \DataTypeTok{caption =} \StringTok{"mutate}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{_example"}\NormalTok{,}
               \DataTypeTok{align =} \StringTok{"c"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}[t]

\caption{\label{tab:unnamed-chunk-13}mutate\_example}
\centering
\begin{tabular}{cccccc}
\toprule
location & cause & sex & year & deaths\_millions & total\_deaths\\
\midrule
Developing & Non-communicable diseases & Male & 1990 & 9 & 309\\
Developing & Non-communicable diseases & Female & 1990 & 8 & 309\\
Developed & Non-communicable diseases & Male & 1990 & 5 & 309\\
Developed & Non-communicable diseases & Female & 1990 & 5 & 309\\
Developing & Non-communicable diseases & Male & 1995 & 10 & 309\\
\bottomrule
\end{tabular}
\end{table}

You should see that \texttt{mutate()} adds the same total number (309)
to every line in the dataframe.

\hypertarget{optional-advanced-exercise}{%
\subsection{Optional advanced
exercise}\label{optional-advanced-exercise}}

Based on what we just observed on how \texttt{mutate()} adds a value to
each row, can you think of a way to redo \textbf{Exercise 3.4.2} without
using a join? Hint: instead of creating \texttt{summary\_data1} (total
deaths per year) as a separate dataframe which we then merge with
\texttt{summary\_data2} (total deaths for all causes per year), we can
use \texttt{mutate()} to add \texttt{total\_per\_year} to each row.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year, cause) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_per_cause =} \KeywordTok{sum}\NormalTok{(deaths_millions)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{total_per_year =} \KeywordTok{sum}\NormalTok{(total_per_cause)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \DecValTok{100}\OperatorTok{*}\NormalTok{total_per_cause}\OperatorTok{/}\NormalTok{total_per_year) ->}\StringTok{ }\NormalTok{alldata}
\end{Highlighting}
\end{Shaded}

\hypertarget{wide-vs-long-spread-and-gather}{%
\section{\texorpdfstring{Wide vs long: \texttt{spread()} and
\texttt{gather()}}{Wide vs long: spread() and gather()}}\label{wide-vs-long-spread-and-gather}}

\includegraphics[width=40.46in]{images/wide_long}

\hypertarget{wide-format}{%
\subsection{Wide format}\label{wide-format}}

Although having data in the long format is very convenient for R, for
publication tables, it makes sense to spread some of the values out into
columns:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{alldata }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \KeywordTok{paste0}\NormalTok{(}\KeywordTok{round}\NormalTok{(percentage, }\DecValTok{2}\NormalTok{), }\StringTok{"%"}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{select}\NormalTok{(year, cause, percentage) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{spread}\NormalTok{(cause, percentage)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 4
## # Groups:   year [6]
##    year `Communicable diseases` Injuries `Non-communicable diseases`
##   <int> <chr>                   <chr>    <chr>                      
## 1  1990 34.02%                  9.11%    56.87%                     
## 2  1995 30.91%                  9.28%    59.81%                     
## 3  2000 28.93%                  9.35%    61.72%                     
## 4  2005 26.53%                  9.23%    64.24%                     
## 5  2010 23.17%                  9.26%    67.57%                     
## 6  2013 21.53%                  8.73%    69.75%
\end{verbatim}

\begin{itemize}
\tightlist
\item
  \texttt{select()} pick the variables you want to keep. Try running the
  lines until \texttt{spread()} to see how it works.
\end{itemize}

\hypertarget{exercise-14}{%
\subsection{Exercise}\label{exercise-14}}

Calculate the percentage of male and female deaths for each year. Spread
it to a human readable form:

Hints:

\begin{itemize}
\tightlist
\item
  create \texttt{summary\_data3} that includes a variable called
  \texttt{total\_per\_sex}
\item
  merge \texttt{summary\_data1} and \texttt{summary\_data3} into a new
  data frame
\item
  calculate the percentage of \texttt{total\_per\_sex} to
  \texttt{total\_per\_year}
\item
  round, add \% labels
\item
  spread
\end{itemize}

Solution:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_per_year =} \KeywordTok{sum}\NormalTok{(deaths_millions)) ->}
\StringTok{    }\NormalTok{summary_data1}

\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year, sex) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_per_sex =} \KeywordTok{sum}\NormalTok{(deaths_millions)) ->}
\StringTok{    }\NormalTok{summary_data3}

\NormalTok{alldata =}\StringTok{ }\KeywordTok{full_join}\NormalTok{(summary_data1, summary_data3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Joining, by = "year"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result_spread =}\StringTok{ }\NormalTok{alldata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \KeywordTok{round}\NormalTok{(}\DecValTok{100}\OperatorTok{*}\NormalTok{total_per_sex}\OperatorTok{/}\NormalTok{total_per_year, }\DecValTok{0}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \KeywordTok{paste0}\NormalTok{(percentage, }\StringTok{"%"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(year, sex, percentage) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{spread}\NormalTok{(sex, percentage)}

\NormalTok{result_spread}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 3
##    year Female Male 
##   <int> <chr>  <chr>
## 1  1990 47%    53%  
## 2  1995 47%    53%  
## 3  2000 46%    54%  
## 4  2005 46%    54%  
## 5  2010 46%    54%  
## 6  2013 45%    55%
\end{verbatim}

And save it into a csv file using \texttt{write\_csv()}:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{write_csv}\NormalTok{(result_spread, }\StringTok{"gbd_genders_summarised.csv"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

You can open a csv file with Excel and copy the table into Word or
PowerPoint for presenting.

\hypertarget{long-format}{%
\subsection{Long format}\label{long-format}}

The opposite of \texttt{spread()} is \texttt{gather()}:

\begin{itemize}
\tightlist
\item
  The first argument is a name for the column that will include columns
  gathered from the wide columns (in this example, \texttt{Male} and
  \texttt{Female} are gathered into \texttt{sex}).
\item
  The second argument is a name for the column that will include the
  values from the wide-format columns (the values from \texttt{Male} and
  \texttt{Female} are gathered into \texttt{percentage}).
\item
  Any columns that already are condensed (e.g.~year was in one column,
  not spread out like in the pre-course example) must be included with a
  negative (i.e. -year).
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result_spread }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{gather}\NormalTok{(sex, percentage, }\OperatorTok{-}\NormalTok{year)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 12 x 3
##     year sex    percentage
##    <int> <chr>  <chr>     
##  1  1990 Female 47%       
##  2  1995 Female 47%       
##  3  2000 Female 46%       
##  4  2005 Female 46%       
##  5  2010 Female 46%       
##  6  2013 Female 45%       
##  7  1990 Male   53%       
##  8  1995 Male   53%       
##  9  2000 Male   54%       
## 10  2005 Male   54%       
## 11  2010 Male   54%       
## 12  2013 Male   55%
\end{verbatim}

\hypertarget{exercise-15}{%
\subsection{Exercise}\label{exercise-15}}

Test what happens when you

\begin{itemize}
\tightlist
\item
  Change the order of sex and percentage:
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result_spread }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{gather}\NormalTok{(percentage, sex, }\OperatorTok{-}\NormalTok{year)}
\end{Highlighting}
\end{Shaded}

Turns out in the above example, \texttt{percentage} and \texttt{sex}
were just label you assigned to the gathered columns. It could be
anything, e.g.:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result_spread }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{gather}\NormalTok{(}\StringTok{`}\DataTypeTok{look-I-gathered-sex}\StringTok{`}\NormalTok{, }\StringTok{`}\DataTypeTok{values-Are-Here}\StringTok{`}\NormalTok{, }\OperatorTok{-}\NormalTok{year)}
\end{Highlighting}
\end{Shaded}

\begin{itemize}
\tightlist
\item
  What happens if we omit \texttt{-year}:
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result_spread }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{gather}\NormalTok{(sex, percentage)}
\end{Highlighting}
\end{Shaded}

\texttt{-year} was telling R we don't want the year column to be
gathered together with Male and Female, we want to keep it as it is.

\hypertarget{sorting-arrange}{%
\section{\texorpdfstring{Sorting:
\texttt{arrange()}}{Sorting: arrange()}}\label{sorting-arrange}}

To reorder data ascendingly or descendingly, \texttt{use\ arrange()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total =} \KeywordTok{sum}\NormalTok{(deaths_millions))  }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{arrange}\NormalTok{(}\OperatorTok{-}\NormalTok{year) }\CommentTok{# reorder after summarise()}
\end{Highlighting}
\end{Shaded}

\newpage

\hypertarget{factor-handling}{%
\section{Factor handling}\label{factor-handling}}

We talked about the pros and cons of working with factors in Session 2.
Overall, they are extremely useful for the type of analyses done in
medical research.

\hypertarget{exercise-16}{%
\subsection{Exercise}\label{exercise-16}}

Explain how and why these two plots are different.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                                   }
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ deaths_millions, }\DataTypeTok{fill =}\NormalTok{ cause))}\OperatorTok{+}\StringTok{  }
\StringTok{    }\KeywordTok{geom_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_summarising_files/figure-latex/unnamed-chunk-24-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{factor}\NormalTok{(year), }\DataTypeTok{y =}\NormalTok{ deaths_millions, }\DataTypeTok{fill =}\NormalTok{ cause, }\DataTypeTok{colour =}\NormalTok{ cause))}\OperatorTok{+}\StringTok{ }
\StringTok{    }\KeywordTok{geom_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_summarising_files/figure-latex/unnamed-chunk-24-2.pdf}

What about these?

\includegraphics{03_summarising_files/figure-latex/unnamed-chunk-25-1.pdf}
\includegraphics{03_summarising_files/figure-latex/unnamed-chunk-25-2.pdf}

These illustrate why it might sometimes be useful to use numbers as
factors - on the second one we have used \texttt{fill\ =\ factor(year)}
as the fill, so each year gets a distinct colour, rather than a gradual
palette.

\hypertarget{fct_collapse---grouping-levels-together}{%
\subsection{\texorpdfstring{\texttt{fct\_collapse()} - grouping levels
together}{fct\_collapse() - grouping levels together}}\label{fct_collapse---grouping-levels-together}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause  }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_collapse}\NormalTok{(}\StringTok{"Non-communicable and injuries"}\NormalTok{ =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Non-communicable diseases"}\NormalTok{, }\StringTok{"Injuries"}\NormalTok{)) ->}
\StringTok{    }\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause2}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause }\OperatorTok{%>%}\StringTok{ }\KeywordTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Communicable diseases"     "Injuries"                 
## [3] "Non-communicable diseases"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause2 }\OperatorTok{%>%}\StringTok{ }\KeywordTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Communicable diseases"         "Non-communicable and injuries"
\end{verbatim}

\hypertarget{fct_relevel---change-the-order-of-levels}{%
\subsection{\texorpdfstring{\texttt{fct\_relevel()} - change the order
of
levels}{fct\_relevel() - change the order of levels}}\label{fct_relevel---change-the-order-of-levels}}

Another reason to sometimes make a numeric variable into a factor is
that we can then reorder it for the plot:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{year }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_relevel}\NormalTok{(}\StringTok{"2013"}\NormalTok{) ->}\StringTok{ }\CommentTok{#brings 2013 to the front}
\StringTok{    }\NormalTok{mydata}\OperatorTok{$}\NormalTok{year.factor}

\KeywordTok{source}\NormalTok{(}\StringTok{"1_source_theme.R"}\NormalTok{)}

\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x=}\NormalTok{year.factor, }\DataTypeTok{y=}\NormalTok{deaths_millions, }\DataTypeTok{fill=}\NormalTok{cause))}\OperatorTok{+}\StringTok{ }
\StringTok{    }\KeywordTok{geom_col}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{03_summarising_files/figure-latex/unnamed-chunk-27-1.pdf}

\hypertarget{fct_recode---rename-levels}{%
\subsection{\texorpdfstring{\texttt{fct\_recode()} - rename
levels}{fct\_recode() - rename levels}}\label{fct_recode---rename-levels}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{levels}\NormalTok{()  }\CommentTok{# levels() lists the factor levels of a column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Communicable diseases"     "Injuries"                 
## [3] "Non-communicable diseases"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{cause }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Deaths from injury"}\NormalTok{ =}\StringTok{ "Injuries"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Communicable diseases"     "Deaths from injury"       
## [3] "Non-communicable diseases"
\end{verbatim}

\hypertarget{converting-factors-to-numbers}{%
\subsection{Converting factors to
numbers}\label{converting-factors-to-numbers}}

MUST REMEMBER: factor needs to become \texttt{as.character()} before
converting to numeric or date! Factors are actually stored as labelled
integers (so like number codes), only the function
\texttt{as.character()} will turn a factor back into a collated format
which can then be converted into a number or date.

\hypertarget{exercise-17}{%
\subsection{Exercise}\label{exercise-17}}

Investigate the two examples converting the \texttt{year.factor}
variable back to a number.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{year.factor}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1990 1990 1990 1990 1995 1995 1995 1995 2000 2000 2000 2000 2005 2005
## [15] 2005 2005 2010 2010 2010 2010 2013 2013 2013 2013 1990 1990 1990 1990
## [29] 1995 1995 1995 1995 2000 2000 2000 2000 2005 2005 2005 2005 2010 2010
## [43] 2010 2010 2013 2013 2013 2013 1990 1990 1990 1990 1995 1995 1995 1995
## [57] 2000 2000 2000 2000 2005 2005 2005 2005 2010 2010 2010 2010 2013 2013
## [71] 2013 2013
## Levels: 2013 1990 1995 2000 2005 2010
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{year.factor }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{as.numeric}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 2 2 2 2 3 3 3 3 4 4 4 4 5 5 5 5 6 6 6 6 1 1 1 1 2 2 2 2 3 3 3 3 4 4 4
## [36] 4 5 5 5 5 6 6 6 6 1 1 1 1 2 2 2 2 3 3 3 3 4 4 4 4 5 5 5 5 6 6 6 6 1 1
## [71] 1 1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{year.factor }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{as.character}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{as.numeric}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1990 1990 1990 1990 1995 1995 1995 1995 2000 2000 2000 2000 2005 2005
## [15] 2005 2005 2010 2010 2010 2010 2013 2013 2013 2013 1990 1990 1990 1990
## [29] 1995 1995 1995 1995 2000 2000 2000 2000 2005 2005 2005 2005 2010 2010
## [43] 2010 2010 2013 2013 2013 2013 1990 1990 1990 1990 1995 1995 1995 1995
## [57] 2000 2000 2000 2000 2005 2005 2005 2005 2010 2010 2010 2010 2013 2013
## [71] 2013 2013
\end{verbatim}

\newpage

\hypertarget{long-exercise}{%
\section{Long Exercise}\label{long-exercise}}

This exercise includes multiple steps, combining all of the above.

First, create a new script called ``2\_long\_exercise.R''. Then Restart
your R session, add \texttt{library(tidyverse)} and load
\texttt{"global\_burden\_disease\_long.rda"}.

\begin{itemize}
\tightlist
\item
  Calculate the total number of deaths in Developed and Developing
  countries. Hint: use \texttt{group\_by(location)} and
  \texttt{summarise(new-column-name\ =\ sum(variable-to-sum))}.
\item
  Calculate the total number of deaths in Developed and Developing
  countries and for men and women. Hint: this is as easy as adding
  \texttt{,\ sex} to \texttt{group\_by()}.
\item
  Filter for 1990.
\item
  \texttt{spread()} the \texttt{location} column.
\end{itemize}

\begin{verbatim}
## # A tibble: 2 x 3
##   sex    Developed Developing
##   <fct>      <dbl>      <dbl>
## 1 Female      5.52       16.8
## 2 Male        5.70       19.4
\end{verbatim}

\hypertarget{extra-formatting-a-table-for-publication}{%
\section{Extra: formatting a table for
publication}\label{extra-formatting-a-table-for-publication}}

Creating a publication table with both the total numbers and percentages
(in brackets) + using \texttt{formatC()} to retain trailing zeros:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Let's use alldata from Exercise 5.2:}

\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year, cause) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_per_cause =} \KeywordTok{sum}\NormalTok{(deaths_millions)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{group_by}\NormalTok{(year) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{total_per_year =} \KeywordTok{sum}\NormalTok{(total_per_cause)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \DecValTok{100}\OperatorTok{*}\NormalTok{total_per_cause}\OperatorTok{/}\NormalTok{total_per_year) ->}\StringTok{ }\NormalTok{alldata}

\NormalTok{alldata }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{total_percentage =}   
                    \KeywordTok{paste0}\NormalTok{(}\KeywordTok{round}\NormalTok{(total_per_cause, }\DecValTok{1}\NormalTok{)  }\OperatorTok{%>%}\StringTok{ }\KeywordTok{formatC}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DataTypeTok{format =} \StringTok{"f"}\NormalTok{),}
                           \StringTok{" ("}\NormalTok{, }\KeywordTok{round}\NormalTok{(percentage, }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{formatC}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DataTypeTok{format =} \StringTok{"f"}\NormalTok{),}
                           \StringTok{"%)"}
\NormalTok{                           )}
\NormalTok{                    ) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{select}\NormalTok{(year, cause, total_percentage) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{spread}\NormalTok{(cause, total_percentage)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 4
## # Groups:   year [6]
##    year `Communicable diseases` Injuries   `Non-communicable diseases`
##   <int> <chr>                   <chr>      <chr>                      
## 1  1990 16.1 (34.0%)            4.3 (9.1%) 27.0 (56.9%)               
## 2  1995 15.4 (30.9%)            4.6 (9.3%) 29.9 (59.8%)               
## 3  2000 14.8 (28.9%)            4.8 (9.4%) 31.5 (61.7%)               
## 4  2005 13.9 (26.5%)            4.8 (9.2%) 33.6 (64.2%)               
## 5  2010 12.4 (23.2%)            5.0 (9.3%) 36.3 (67.6%)               
## 6  2013 11.8 (21.5%)            4.8 (8.7%) 38.3 (69.7%)
\end{verbatim}

\hypertarget{solution-long-exercise}{%
\section{Solution: Long Exercise}\label{solution-long-exercise}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{1990}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(location, sex) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{total_deaths =} \KeywordTok{sum}\NormalTok{(deaths_millions)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{spread}\NormalTok{(location, total_deaths)}
\end{Highlighting}
\end{Shaded}

\hypertarget{different-types-of-plots}{%
\chapter{Different types of plots}\label{different-types-of-plots}}

\hypertarget{data-2}{%
\section{Data}\label{data-2}}

We will be using the gapminder dataset:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(gapminder)}

\NormalTok{mydata =}\StringTok{ }\NormalTok{gapminder}

\KeywordTok{summary}\NormalTok{(mydata)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         country        continent        year         lifeExp     
##  Afghanistan:  12   Africa  :624   Min.   :1952   Min.   :23.60  
##  Albania    :  12   Americas:300   1st Qu.:1966   1st Qu.:48.20  
##  Algeria    :  12   Asia    :396   Median :1980   Median :60.71  
##  Angola     :  12   Europe  :360   Mean   :1980   Mean   :59.47  
##  Argentina  :  12   Oceania : 24   3rd Qu.:1993   3rd Qu.:70.85  
##  Australia  :  12                  Max.   :2007   Max.   :82.60  
##  (Other)    :1632                                                
##       pop              gdpPercap       
##  Min.   :6.001e+04   Min.   :   241.2  
##  1st Qu.:2.794e+06   1st Qu.:  1202.1  
##  Median :7.024e+06   Median :  3531.8  
##  Mean   :2.960e+07   Mean   :  7215.3  
##  3rd Qu.:1.959e+07   3rd Qu.:  9325.5  
##  Max.   :1.319e+09   Max.   :113523.1  
## 
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{year }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1952 1957 1962 1967 1972 1977 1982 1987 1992 1997 2002 2007
\end{verbatim}

\hypertarget{scatter-plotsbubble-plots---geom_point}{%
\section{\texorpdfstring{Scatter plots/bubble plots -
\texttt{geom\_point()}}{Scatter plots/bubble plots - geom\_point()}}\label{scatter-plotsbubble-plots---geom_point}}

Plot life expectancy against GDP per capita
(\texttt{x\ =\ gdpPercap,\ y=lifeExp}) at year 2007:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ gdpPercap, }\DataTypeTok{y=}\NormalTok{lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-2-1.pdf}

\hypertarget{exercise-18}{%
\subsection{Exercise}\label{exercise-18}}

Follow the step-by-step instructions to transform the grey plot just
above into this:

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-3-1.pdf}

\begin{itemize}
\tightlist
\item
  Add points: \texttt{geom\_point()}

  \begin{itemize}
  \tightlist
  \item
    Change point type: \texttt{shape\ =\ 1} (or any number from your
    Quickstart Sheet) inside the \texttt{geom\_point()}
  \end{itemize}
\item
  Colour each country point by its continent: \texttt{colour=continent}
  to aes()
\item
  Size each country point by its population: \texttt{size=pop} to aes()
\item
  Put the country points of each continent on a separate panel:
  \texttt{+\ facet\_wrap(\textasciitilde{}continent)}
\item
  Make the background white: \texttt{+\ theme\_bw()}
\end{itemize}

\hypertarget{line-charttimeplot---geom_line}{%
\section{\texorpdfstring{Line chart/timeplot -
\texttt{geom\_line()}}{Line chart/timeplot - geom\_line()}}\label{line-charttimeplot---geom_line}}

Plot life expectancy against year (\texttt{x\ =\ year,\ y=lifeExp}), add
\texttt{geom\_line()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y=}\NormalTok{lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-4-1.pdf}

The reason you now see this weird zig-zag is that, using the above code,
R does not know you want a connected line for each country. Specify how
you want data points grouped to lines: \texttt{group\ =\ country} in
\texttt{aes()}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y=}\NormalTok{lifeExp, }\DataTypeTok{group =}\NormalTok{ country)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-5-1.pdf}

\hypertarget{exercise-19}{%
\subsection{Exercise}\label{exercise-19}}

Follow the step-by-step instructions to transform the grey plot just
above into this:

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-6-1.pdf}

\begin{itemize}
\tightlist
\item
  Colour lines by continents: \texttt{colour=continent} to
  \texttt{aes()}
\item
  \emph{Similarly to what we did in \texttt{geom\_point()}, you can even
  size the line thicknesses by each country's population:
  \texttt{size=pop} to \texttt{aes()}}
\item
  Continents on separate panels:
  \texttt{+\ facet\_wrap(\textasciitilde{}continent)}
\item
  Make the background white: \texttt{+\ theme\_bw()}
\item
  Use a nicer colour scheme:
  \texttt{+\ scale\_colour\_brewer(palette\ =\ "Paired")}
\end{itemize}

\hypertarget{advanced-example}{%
\subsection{Advanced example}\label{advanced-example}}

For European countries only
(\texttt{filter(continent\ ==\ "Europe")\ \%\textgreater{}\%}), plot
life expectancy over time in grey colour for all countries, then add
United Kingdom as a red line:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Europe"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\CommentTok{#Europe only}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y=}\NormalTok{lifeExp, }\DataTypeTok{group =}\NormalTok{ country)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"grey"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\DataTypeTok{data =} \KeywordTok{filter}\NormalTok{(mydata, country }\OperatorTok{==}\StringTok{ "United Kingdom"}\NormalTok{), }\DataTypeTok{colour =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-7-1.pdf}

\hypertarget{advanced-exercise}{%
\subsection{Advanced Exercise}\label{advanced-exercise}}

As previous, but add a line for France in blue:

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-8-1.pdf}

\hypertarget{box-plot---geom_boxplot}{%
\section{\texorpdfstring{Box-plot -
\texttt{geom\_boxplot()}}{Box-plot - geom\_boxplot()}}\label{box-plot---geom_boxplot}}

Plot the distribution of life expectancies within each continent at year
2007:

\begin{itemize}
\tightlist
\item
  \texttt{filter(year\ ==\ 2007)\ \%\textgreater{}\%}
\item
  \texttt{x\ =\ continent,\ y\ =\ lifeExp}
\item
  \texttt{+\ geom\_boxplot()}
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent, }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-9-1.pdf}

\hypertarget{exercise-20}{%
\subsection{Exercise}\label{exercise-20}}

Add individual (country) points on top of the box plot:

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-10-1.pdf}

Hint: Use \texttt{geom\_jitter()} instead of \texttt{geom\_point()} to
reduce overlap by spreading the points horizontally. Include the
\texttt{width=0.3} option to reduce the width of the jitter.

\textbf{Optional:}

Include text labels for the highest life expectancy country of each
continent.

\textbf{Hint 1} Create a separate dataframe called \texttt{label\_data}
with the maximum countries for each continent:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{label_data =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\KeywordTok{max}\NormalTok{(year)) }\OperatorTok{%>%}\StringTok{ }\CommentTok{# same as year == 2007}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(lifeExp }\OperatorTok{==}\StringTok{ }\KeywordTok{max}\NormalTok{(lifeExp) )}
\end{Highlighting}
\end{Shaded}

\textbf{Hint 2} Add \texttt{geom\_label()} with appropriate
\texttt{aes()}:

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{+}\StringTok{ }\KeywordTok{geom_label}\NormalTok{(}\DataTypeTok{data =}\NormalTok{ label_data, }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{label=}\NormalTok{country), }\DataTypeTok{vjust =} \DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{dot-plot---geom_dotplot}{%
\subsection{\texorpdfstring{Dot-plot -
\texttt{geom\_dotplot()}}{Dot-plot - geom\_dotplot()}}\label{dot-plot---geom_dotplot}}

\texttt{geom\_dotplot(aes(fill=continent),\ binaxis\ =\ \textquotesingle{}y\textquotesingle{},\ stackdir\ =\ \textquotesingle{}center\textquotesingle{},\ alpha=0.6)}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-13-1.pdf}

\hypertarget{barplot---geom_bar-and-geom_col}{%
\section{\texorpdfstring{Barplot - \texttt{geom\_bar()} and
\texttt{geom\_col()}}{Barplot - geom\_bar() and geom\_col()}}\label{barplot---geom_bar-and-geom_col}}

In the first module, we plotted barplots from already summarised data
(using the \texttt{geom\_col}), but \texttt{geom\_bar()} is perfectly
happy to count up data for you. For example, we can plot the number of
countries in each continent without summarising the data beforehand:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Number of countries"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-14-1.pdf}

\hypertarget{exercise-21}{%
\subsection{Exercise}\label{exercise-21}}

Create this barplot of life expectancies in European countries (year
2007). Hint: \texttt{coord\_flip()} makes the bars horizontal,
\texttt{fill\ =\ NA} makes them empty, have a look at your QuickStar
sheet for different themes.

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-15-1.pdf}

\hypertarget{all-other-types-of-plots}{%
\section{All other types of plots}\label{all-other-types-of-plots}}

These are just some of the main ones, see this gallery for more options:
\url{http://www.r-graph-gallery.com/portfolio/ggplot2-package/}

And the \texttt{ggplot()} documentation: \url{http://docs.ggplot2.org/}

Remember that you can always combine different types of plots - i.e.~add
lines or points on bars, etc.

\hypertarget{specifying-aes-variables}{%
\section{\texorpdfstring{Specifying \texttt{aes()}
variables}{Specifying aes() variables}}\label{specifying-aes-variables}}

The \texttt{aes()} variables wrapped inside \texttt{ggplot()} will be
taken into account by all geoms. If you put
\texttt{aes(colour\ =\ lifeExp)} inside \texttt{geom\_point()}, only
points will be coloured:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Europe"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp, }\DataTypeTok{group =}\NormalTok{ country)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{colour =}\NormalTok{ lifeExp))}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-16-1.pdf}

\hypertarget{extra-optional-exercises}{%
\section{Extra: Optional exercises}\label{extra-optional-exercises}}

\hypertarget{exercise-22}{%
\subsection{Exercise}\label{exercise-22}}

Make this:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{dummy =}\StringTok{ }\DecValTok{1}  \CommentTok{# create a column called "dummy" that includes number 1 for each country}

\NormalTok{mydata2007 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year}\OperatorTok{==}\KeywordTok{max}\NormalTok{(year)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{country_number =} \KeywordTok{cumsum}\NormalTok{(dummy))  }\CommentTok{# create a column called "country_number" that}
  \CommentTok{# is a cumulative sum of the number of countries before it - basically indexing}


\NormalTok{mydata2007 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{colour=}\NormalTok{continent), }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_text}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ country_number, }\DataTypeTok{label=}\NormalTok{country), }\DataTypeTok{size=}\DecValTok{4}\NormalTok{, }\DataTypeTok{vjust=}\DecValTok{1}\NormalTok{, }\DataTypeTok{colour=}\StringTok{'black'}\NormalTok{)}\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_void}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-17-1.pdf}

\newpage

\hypertarget{exercise-23}{%
\subsection{Exercise}\label{exercise-23}}

Make this:

Hints: \texttt{coord\_flip()}, \texttt{scale\_color\_gradient(...)},
\texttt{geom\_segment(...)}, \texttt{annotate("text",\ ...)}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Europe"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{y =} \KeywordTok{fct_reorder}\NormalTok{(country, gdpPercap, }\DataTypeTok{.fun=}\NormalTok{max), }\DataTypeTok{x=}\NormalTok{lifeExp, }\DataTypeTok{colour=}\NormalTok{year)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{shape =} \DecValTok{15}\NormalTok{, }\DataTypeTok{size =} \DecValTok{2}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_colour_distiller}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Greens"}\NormalTok{, }\DataTypeTok{direction =} \DecValTok{1}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_segment}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{yend =} \StringTok{"Switzerland"}\NormalTok{, }\DataTypeTok{x =} \DecValTok{85}\NormalTok{, }\DataTypeTok{y =} \StringTok{"Bosnia and Herzegovina"}\NormalTok{, }\DataTypeTok{xend =} \DecValTok{85}\NormalTok{),}
               \DataTypeTok{colour =} \StringTok{"black"}\NormalTok{, }\DataTypeTok{size=}\DecValTok{1}\NormalTok{,}
               \DataTypeTok{arrow =} \KeywordTok{arrow}\NormalTok{(}\DataTypeTok{length =} \KeywordTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{))) }\OperatorTok{+}
\StringTok{  }\KeywordTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\DataTypeTok{y =} \StringTok{"Greece"}\NormalTok{, }\DataTypeTok{x=}\DecValTok{83}\NormalTok{, }\DataTypeTok{label =} \StringTok{"Higher GDP per capita"}\NormalTok{, }\DataTypeTok{angle =} \DecValTok{90}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{04_plotting_files/figure-latex/unnamed-chunk-18-1.pdf}

\hypertarget{solutions-2}{%
\section{Solutions}\label{solutions-2}}

\textbf{4.2.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(  }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ gdpPercap}\OperatorTok{/}\DecValTok{1000}\NormalTok{, }\CommentTok{#divide by 1000 to tidy the x-axis}
               \DataTypeTok{y=}\NormalTok{lifeExp,}
               \DataTypeTok{colour=}\NormalTok{continent,}
               \DataTypeTok{size=}\NormalTok{pop)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{shape =} \DecValTok{1}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{continent) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbf{4.3.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(  }\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y=}\NormalTok{lifeExp, }\DataTypeTok{group =}\NormalTok{ country, }\DataTypeTok{colour=}\NormalTok{continent)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\NormalTok{continent) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_colour_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Paired"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{which}

Add
\texttt{+\ \ geom\_line(data\ =\ filter(mydata,\ country\ ==\ "France"),\ colour\ =\ "blue")}

\textbf{4.4.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent, }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\DataTypeTok{outlier.shape =} \OtherTok{NA}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_jitter}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{colour=}\NormalTok{continent), }\DataTypeTok{width=}\FloatTok{0.3}\NormalTok{, }\DataTypeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\OperatorTok{+}\StringTok{ }\CommentTok{#width defaults to 0.8 of box width}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent, }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\DataTypeTok{outlier.shape =} \OtherTok{NA}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_jitter}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{colour=}\NormalTok{continent), }\DataTypeTok{width=}\FloatTok{0.3}\NormalTok{, }\DataTypeTok{alpha=}\FloatTok{0.8}\NormalTok{)}
  \KeywordTok{theme_bw}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\textbf{4.5.1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Europe"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ country, }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_col}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"#91bfdb"}\NormalTok{, }\DataTypeTok{fill =} \OtherTok{NA}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{coord_flip}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_classic}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{fine-tuning-plots}{%
\chapter{Fine tuning plots}\label{fine-tuning-plots}}

\hypertarget{data-and-initial-plot}{%
\section{Data and initial plot}\label{data-and-initial-plot}}

We can save a \texttt{ggplot()} object into a variable (usually called
\texttt{p} but can be any name). This then appears in the Environment
tab. To plot it it needs to be recalled on a separate line. Saving a
plot into a variable allows us to modify it later (e.g.,
\texttt{p\ +\ theme\_bw()}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(gapminder)}
\KeywordTok{library}\NormalTok{(tidyverse)}

\NormalTok{mydata =}\StringTok{ }\NormalTok{gapminder}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{year }\OperatorTok{%>%}\StringTok{ }\KeywordTok{unique}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] 1952 1957 1962 1967 1972 1977 1982 1987 1992 1997 2002 2007
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent, year) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ lifeExp, }\DataTypeTok{x =}\NormalTok{ gdpPercap, }\DataTypeTok{colour =}\NormalTok{ continent)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\DataTypeTok{alpha =} \FloatTok{0.3}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method =} \StringTok{"lm"}\NormalTok{, }\DataTypeTok{se =} \OtherTok{FALSE}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_colour_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Set1"}\NormalTok{)}

\NormalTok{p}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-1-1.pdf}

\hypertarget{scales}{%
\section{Scales}\label{scales}}

\hypertarget{logarithmic}{%
\subsection{Logarithmic}\label{logarithmic}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_x_log10}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-2-1.pdf}

\hypertarget{expand-limits}{%
\subsection{Expand limits}\label{expand-limits}}

Specify the value you want to be included:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{expand_limits}\NormalTok{(}\DataTypeTok{y =} \DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-3-1.pdf}

\newpage

Or two:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{expand_limits}\NormalTok{(}\DataTypeTok{y =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-4-1.pdf}

By default, \texttt{ggplot()} adds some padding around the included area
(see how the scale doesn't start from 0, but slightly before). You can
remove this padding with the expand option:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{expand_limits}\NormalTok{(}\DataTypeTok{y =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{expand =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-5-1.pdf}

\hypertarget{zoom-in}{%
\subsection{Zoom in}\label{zoom-in}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{85}\NormalTok{), }\DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(}\DecValTok{20000}\NormalTok{, }\DecValTok{40000}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-6-1.pdf}

\hypertarget{exercise-24}{%
\subsection{Exercise}\label{exercise-24}}

How is this one different to the previous?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_y_continuous}\NormalTok{(}\DataTypeTok{limits =} \KeywordTok{c}\NormalTok{(}\DecValTok{70}\NormalTok{, }\DecValTok{85}\NormalTok{)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_x_continuous}\NormalTok{(}\DataTypeTok{limits =} \KeywordTok{c}\NormalTok{(}\DecValTok{20000}\NormalTok{, }\DecValTok{40000}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Removed 114 rows containing non-finite values (stat_smooth).
\end{verbatim}

\begin{verbatim}
## Warning: Removed 114 rows containing missing values (geom_point).
\end{verbatim}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-7-1.pdf}

Answer: the first one zooms in, still retaining information about the
excluded points when calculating the linear regression lines. The second
one removes the data (as the warnings say), calculating the linear
regression lines only for the visible points.

\hypertarget{axis-ticks}{%
\subsection{Axis ticks}\label{axis-ticks}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{coord_cartesian}\NormalTok{(}\DataTypeTok{ylim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{), }\DataTypeTok{expand =} \DecValTok{0}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_y_continuous}\NormalTok{(}\DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\DecValTok{17}\NormalTok{, }\DecValTok{35}\NormalTok{, }\DecValTok{88}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-8-1.pdf}

\hypertarget{swap-the-axes}{%
\subsection{Swap the axes}\label{swap-the-axes}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{coord_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-9-1.pdf}

\hypertarget{colours}{%
\section{Colours}\label{colours}}

\hypertarget{using-the-brewer-palettes}{%
\subsection{Using the Brewer
palettes:}\label{using-the-brewer-palettes}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_color_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Paired"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-10-1.pdf}

\hypertarget{legend-title}{%
\subsection{Legend title}\label{legend-title}}

\texttt{scale\_colour\_brewer()} is also a conventient place to change
the legend title:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_color_brewer}\NormalTok{(}\StringTok{"Continent - }\CharTok{\textbackslash{}n}\StringTok{ one of 5"}\NormalTok{, }\DataTypeTok{palette =} \StringTok{"Paired"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-11-1.pdf}

Note the \texttt{\textbackslash{}n} inside the new legend title - new
line.

\hypertarget{choosing-colours-manually}{%
\subsection{Choosing colours manually}\label{choosing-colours-manually}}

Use words:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_color_manual}\NormalTok{(}\DataTypeTok{values =} \KeywordTok{c}\NormalTok{(}\StringTok{"red"}\NormalTok{, }\StringTok{"green"}\NormalTok{, }\StringTok{"blue"}\NormalTok{, }\StringTok{"purple"}\NormalTok{, }\StringTok{"pink"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-12-1.pdf}

Or HEX codes (either from \url{http://colorbrewer2.org/} or any other
resource):

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{scale_color_manual}\NormalTok{(}\DataTypeTok{values =} \KeywordTok{c}\NormalTok{(}\StringTok{"#e41a1c"}\NormalTok{, }\StringTok{"#377eb8"}\NormalTok{, }\StringTok{"#4daf4a"}\NormalTok{, }\StringTok{"#984ea3"}\NormalTok{, }\StringTok{"#ff7f00"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-13-1.pdf}

Note that \url{http://colorbrewer2.org/} also has options for
\emph{Colourblind safe} and \emph{Print friendly}.

\newpage

\hypertarget{titles-and-labels}{%
\section{Titles and labels}\label{titles-and-labels}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{labs}\NormalTok{(}\DataTypeTok{x =} \StringTok{"Gross domestic product per capita"}\NormalTok{,}
         \DataTypeTok{y =} \StringTok{"Life expectancy"}\NormalTok{,}
         \DataTypeTok{title =} \StringTok{"Health and economics"}\NormalTok{,}
         \DataTypeTok{subtitle =} \StringTok{"Gapminder dataset, 2007"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-14-1.pdf}

\hypertarget{annotation}{%
\subsection{Annotation}\label{annotation}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
           \DataTypeTok{x =} \DecValTok{25000}\NormalTok{,}
           \DataTypeTok{y =} \DecValTok{50}\NormalTok{,}
           \DataTypeTok{label =} \StringTok{"No points here!"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-15-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{annotate}\NormalTok{(}\StringTok{"label"}\NormalTok{,}
           \DataTypeTok{x =} \DecValTok{25000}\NormalTok{,}
           \DataTypeTok{y =} \DecValTok{50}\NormalTok{,}
           \DataTypeTok{label =} \StringTok{"No points here!"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-16-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{annotate}\NormalTok{(}\StringTok{"label"}\NormalTok{,}
           \DataTypeTok{x =} \DecValTok{25000}\NormalTok{, }
           \DataTypeTok{y =} \DecValTok{50}\NormalTok{,}
           \DataTypeTok{label =} \StringTok{"No points here!"}\NormalTok{, }
           \DataTypeTok{hjust =} \DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-17-1.pdf}

\texttt{hjust} stand for horizontal justification. It's default value is
0.5 (see how the label was centered at 25,000 - our chosen x location),
0 means the label goes to the right from 25,000, 1 would make it end at
25,000.

\hypertarget{annotation-with-a-superscript-and-a-variable}{%
\subsection{Annotation with a superscript and a
variable}\label{annotation-with-a-superscript-and-a-variable}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_glance =}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{r.squared =} \FloatTok{0.7693465}\NormalTok{)}


\NormalTok{plot_rsquared =}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}
  \StringTok{"R^2 == "}\NormalTok{,}
\NormalTok{  fit_glance}\OperatorTok{$}\NormalTok{r.squared }\OperatorTok{%>%}\StringTok{ }\KeywordTok{round}\NormalTok{(}\DecValTok{2}\NormalTok{))}


\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{,}
           \DataTypeTok{x =} \DecValTok{25000}\NormalTok{, }
           \DataTypeTok{y =} \DecValTok{50}\NormalTok{,}
           \DataTypeTok{label =}\NormalTok{ plot_rsquared, }\DataTypeTok{parse =} \OtherTok{TRUE}\NormalTok{,}
           \DataTypeTok{hjust =} \DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-18-1.pdf}

\hypertarget{text-size}{%
\section{Text size}\label{text-size}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{axis.text.y =} \KeywordTok{element_text}\NormalTok{(}\DataTypeTok{size =} \DecValTok{16}\NormalTok{),}
        \DataTypeTok{axis.text.x =} \KeywordTok{element_text}\NormalTok{(}\DataTypeTok{colour =} \StringTok{"red"}\NormalTok{, }\DataTypeTok{angle =} \DecValTok{45}\NormalTok{, }\DataTypeTok{vjust =} \FloatTok{0.5}\NormalTok{),}
        \DataTypeTok{axis.title =} \KeywordTok{element_text}\NormalTok{(}\DataTypeTok{size =} \DecValTok{16}\NormalTok{, }\DataTypeTok{colour =} \StringTok{"darkgreen"}\NormalTok{)}
\NormalTok{        )}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-19-1.pdf}

\hypertarget{legend-position}{%
\subsection{Legend position}\label{legend-position}}

Use the following words: \texttt{"right",\ "left",\ "top",\ "bottom"},
or \texttt{"none"} to remove the legend.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-20-1.pdf}

Or use relative coordinates (0--1) to give it an -y location:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position      =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{),}
        \DataTypeTok{legend.justification =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{)) }\CommentTok{#bottom-right corner}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-21-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"top"}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{guides}\NormalTok{(}\DataTypeTok{colour =} \KeywordTok{guide_legend}\NormalTok{(}\DataTypeTok{ncol =} \DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{05_fine_tuning_plots_files/figure-latex/unnamed-chunk-22-1.pdf}

\hypertarget{saving-your-plot}{%
\section{Saving your plot}\label{saving-your-plot}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ggsave}\NormalTok{(p, }\DataTypeTok{file =} \StringTok{"my_saved_plot.png"}\NormalTok{, }\DataTypeTok{width =} \DecValTok{5}\NormalTok{, }\DataTypeTok{height =} \DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{part-data-analysis}{%
\part{Data analysis}\label{part-data-analysis}}

In the second part of this book, we focus specifically on the business
of data analysis. That is, formulating clear questions and seeking to
answer them using available datasets.

Again, we emphasise the importance of understanding the underlying data
through visualisation, rather than relying on statistical tests or,
heaven forbid, the p-value alone.

There are five chapters. Testing for continuous outcome variables (6)
leads naturally into Linear regression (7). We would expect the majority
of actual analysis done by readers to be using the methods in chapter 7
rather than 6. Similarly, Testing for categorical outcome variables (8)
leads naturally to Logistic regression (9), where we would expect the
majority of work to focus. Chapters 6 and 8 however do provide helpful
reminders of how to prepare data for these analyses and shouldn't be
skipped. Time-to-event data introduces survival analysis and includes
sections on the manipulation of dates.

\hypertarget{tests-for-continuous-outcome-variables}{%
\chapter{Tests for continuous outcome
variables}\label{tests-for-continuous-outcome-variables}}

\index{continuous data@\textbf{continuous data}}

\begin{quote}
Continuous data can be measured.\\
Categorical data can be counted.
\end{quote}

\hypertarget{continuous-data}{%
\section{Continuous data}\label{continuous-data}}

Continuous data is everywhere in healthcare. From physiological measures
in patients such as systolic blood pressure or pulmonary function tests,
through to populations measures like life expectancy or disease
incidence, the analysis of continuous outcome measures is common and
important.

Our goal in most health data questions, is to draw a conclusion on a
comparison between groups. For instance, understanding differences life
expectancy between the year 2002 and 2007 or between the Africa and
Europe, is usually more useful than simply describing the average life
expectancy across the entire world across all of time.

The basis for comparisons between continuous measures is the
distribution of the data. That word, as many which have a statistical
flavour, brings on the sweats in a lot of people. It needn't. By
distribution, we are simply referring to the shape of the data.

\hypertarget{the-question}{%
\section{The Question}\label{the-question}}

The examples in this chapter all use the data introduced previously from
the amazing \href{https://www.gapminder.org/}{Gapminder project}. We
will start by looking at the life expectancy of populations over time
and in different geographical regions.

\hypertarget{get-the-data}{%
\section{Get the data}\label{get-the-data}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Load packages}
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(finalfit)}
\KeywordTok{library}\NormalTok{(gapminder)}

\CommentTok{# Create object mydata from object gapminder}
\NormalTok{mydata =}\StringTok{ }\NormalTok{gapminder}
\end{Highlighting}
\end{Shaded}

\hypertarget{check-the-data}{%
\section{Check the data}\label{check-the-data}}

It is vital that data is carefully inspected when first read. The three
functions below provide a clear summary allowing errors or miscoding to
be quickly identified. It is particularity important to ensure that any
missing data is identified. If you don't do this you will regret it!
There are many times when an analysis has got to a relatively advanced
stage before research realised the dataset was incomplete.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{glimpse}\NormalTok{(mydata) }\CommentTok{# each variable as line, variable type, first values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Observations: 1,704
## Variables: 6
## $ country   <fct> Afghanistan, Afghanistan, Afghanistan, Afghanistan, ...
## $ continent <fct> Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia...
## $ year      <int> 1952, 1957, 1962, 1967, 1972, 1977, 1982, 1987, 1992...
## $ lifeExp   <dbl> 28.801, 30.332, 31.997, 34.020, 36.088, 38.438, 39.8...
## $ pop       <int> 8425333, 9240934, 10267083, 11537966, 13079460, 1488...
## $ gdpPercap <dbl> 779.4453, 820.8530, 853.1007, 836.1971, 739.9811, 78...
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{missing_glimpse}\NormalTok{(mydata) }\CommentTok{# missing data for each variable}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               label var_type    n missing_n missing_percent
## country     country    <fct> 1704         0             0.0
## continent continent    <fct> 1704         0             0.0
## year           year    <int> 1704         0             0.0
## lifeExp     lifeExp    <dbl> 1704         0             0.0
## pop             pop    <int> 1704         0             0.0
## gdpPercap gdpPercap    <dbl> 1704         0             0.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{ff_glimpse}\NormalTok{(mydata) }\CommentTok{# summary statistics for each variable}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Continuous
##               label var_type    n missing_n missing_percent       mean
## year           year    <int> 1704         0             0.0     1979.5
## lifeExp     lifeExp    <dbl> 1704         0             0.0       59.5
## pop             pop    <int> 1704         0             0.0 29601212.3
## gdpPercap gdpPercap    <dbl> 1704         0             0.0     7215.3
##                    sd     min quartile_25    median quartile_75
## year             17.3  1952.0      1965.8    1979.5      1993.2
## lifeExp          12.9    23.6        48.2      60.7        70.8
## pop       106157896.7 60011.0   2793664.0 7023595.5  19585221.8
## gdpPercap      9857.5   241.2      1202.1    3531.8      9325.5
##                    max
## year            2007.0
## lifeExp           82.6
## pop       1318683096.0
## gdpPercap     113523.1
## 
## Categorical
##               label var_type    n missing_n missing_percent levels_n
## country     country    <fct> 1704         0             0.0      142
## continent continent    <fct> 1704         0             0.0        5
##                                                      levels
## country                                                   -
## continent "Africa", "Americas", "Asia", "Europe", "Oceania"
##                     levels_count               levels_percent
## country                        -                            -
## continent 624, 300, 396, 360, 24 36.6, 17.6, 23.2, 21.1,  1.4
\end{verbatim}

\index{functions!glimpse} \index{functions!missing\_glimpse}
\index{functions!ff\_glimpse}

As can be seen, there are 6 variables, 4 are continuous and 2 are
categorical. The categorical variables are already identified as
\texttt{factors}. There are no missing data.

\hypertarget{plot-the-data}{%
\section{Plot the data}\label{plot-the-data}}

We will start by comparing life expectancy between the 5 continents of
the world in two different years. Always plot your data first. Never
skip this step! We are particularly interested in the distribution.
There's that word again. The shape of the data. Is it normal? Is it
skewed? Does it differ between regions and years?

There are three useful plots which can help here:

\begin{itemize}
\tightlist
\item
  Histograms: examine shape of data and compare groups;
\item
  Q-Q plots: are data normally distributed?
\item
  Box-plots: identify outliers, compare shape and groups.
\end{itemize}

\hypertarget{histogram}{%
\subsection{Histogram}\label{histogram}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2002}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{       }\CommentTok{# remember aes()}
\StringTok{    }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{20}\NormalTok{) }\OperatorTok{+}\StringTok{      }\CommentTok{# histogram with 20 bars}
\StringTok{    }\KeywordTok{facet_grid}\NormalTok{(year }\OperatorTok{~}\StringTok{ }\NormalTok{continent)     }\CommentTok{# add scale="free" for axes to vary                                 }
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-4-1.pdf}
\caption{\label{fig:unnamed-chunk-4}Histogram: country life expectancy by
continent and year}
\end{figure}

\index{functions!filter} \index{plotting!geom\_histogram}
\index{plotting!facet\_grid}

What can we see? That life expectancy in Africa is lower than in other
regions. That we have little data for Oceania given there are only two
countries included, Australia and New Zealand. That Africa and Asia have
great variability in life expectancy by country than in the Americas or
Europe. That the data follow a reasonably normal shape, with Africa 2002
a little right skewed.

\hypertarget{q-q-plot}{%
\subsection{Q-Q plot}\label{q-q-plot}}

A quantile-quantile sounds complicated but is not. It is simply a
graphical method for comparing the distribution (think shape) of our own
data to a theoretical distribution, such as the normal distribution. In
this context, quantiles are just cut points which divide our data into
bins each containing the same number of observations. For example, if we
have the life expectancy for 100 countries, then quartiles (note the
quar-) for life expectancy are the three ages which split the
observations into 4 groups each containing 25 countries. A Q-Q plot
simply plots the quantiles for our data against the theoretical
quantiles for a particular distributions (default below is normal). If
our data follow that distribution (e.g.~normal), then we get a 45 degree
line on the plot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2002}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{sample =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{      }\CommentTok{# Q-Q plot requires `sample}
\StringTok{  }\KeywordTok{geom_qq}\NormalTok{() }\OperatorTok{+}\StringTok{                          }\CommentTok{# defaults to normal distribution}
\StringTok{  }\KeywordTok{geom_qq_line}\NormalTok{() }\OperatorTok{+}\StringTok{                     }\CommentTok{# add 45 degree line}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(year }\OperatorTok{~}\StringTok{ }\NormalTok{continent)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-5-1.pdf}
\caption{\label{fig:unnamed-chunk-5}Q-Q plot: country life expectancy by
continent and year}
\end{figure}

\index{functions!filter} \index{plotting!geom\_qq}
\index{plotting!geom\_qq\_line} \index{plotting!facet\_grid}

What can we see. We are looking to see if the data follow the 45 degree
line which is included in the plot. These do reasonably, except for
Africa which is curved upwards at each end, suggesting a skew.

We are frequently asked about performing a hypothesis test to check the
assumption of normality, such as the Shapiro-Wilk normality test. We do
not recommend this, simply because it is often non-significant when the
number of observations is small but the data look skewed, and often
significant when the number of observations is high but the data look
reasonably normal on inspection of plots. It is therefore not useful in
practice - common sense should prevail.

\hypertarget{boxplot}{%
\subsection{Boxplot}\label{boxplot}}

Boxplots are our preferred method for comparing a continuous variable
such as life expectancy with a categorical explanatory variable. It is
much better than a bar plot, or a bar plot with error bars, sometimes
called a dynamite plot.

The box represents the median and interquartile range (where 50\% of the
data sits). The lines (whiskers) by default are 1.5 times the
interquartile range. Outliers are represented as points.

Thus it contains information, not only on central tenancy (median), but
on the variation in the data and the distribution of the data, for
instance a skew should be obvious.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2002}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent, }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{year)                    }\CommentTok{# spread by year, note `.`}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-6-1.pdf}
\caption{\label{fig:unnamed-chunk-6}Boxplot: country life expectancy by
continent and year}
\end{figure}

\index{functions!filter} \index{plotting!geom\_boxplot}
\index{plotting!facet\_grid}

What can we see? The median life expectancy is lower in Africa than in
any other continent. The variation in life expectancy is greatest in
Africa and smallest in Oceania. The data in Africa looks skewed,
particularly in 2002 - the lines/whiskers are unequal lengths.

We can add further arguments

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{  }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2002}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{factor}\NormalTok{(year), }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =}\NormalTok{ continent)) }\OperatorTok{+}\StringTok{     }\CommentTok{# add colour to boxplots}
\StringTok{  }\KeywordTok{geom_jitter}\NormalTok{(}\DataTypeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\OperatorTok{+}\StringTok{                }\CommentTok{# alpha = transparency}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{continent) }\OperatorTok{+}\StringTok{               }\CommentTok{# spread by year, note `.`}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\OperatorTok{+}\StringTok{         }\CommentTok{# remove legend}
\StringTok{  }\KeywordTok{xlab}\NormalTok{(}\StringTok{"Year"}\NormalTok{) }\OperatorTok{+}\StringTok{                            }\CommentTok{# label x-axis}
\StringTok{  }\KeywordTok{ylab}\NormalTok{(}\StringTok{"Life expectancy (years)"}\NormalTok{) }\OperatorTok{+}\StringTok{         }\CommentTok{# label y-axis}
\StringTok{  }\KeywordTok{ggtitle}\NormalTok{(}
    \StringTok{"Life expectancy by continent in 2002 v 2007"}\NormalTok{) }\CommentTok{# add title}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-7-1.pdf}
\caption{\label{fig:unnamed-chunk-7}Boxplot with jitter points: country life
expectancy by continent and year}
\end{figure}

\index{functions!filter} \index{plotting!geom\_boxplot}
\index{plotting!geom\_jitter} \index{plotting!facet\_grid}
\index{plotting!theme} \index{plotting!xlab} \index{plotting!ylab}
\index{plotting!ggtitle}

\hypertarget{compare-the-means-of-two-groups}{%
\section{Compare the means of two
groups}\label{compare-the-means-of-two-groups}}

\hypertarget{t-test}{%
\subsection{T-test}\label{t-test}}

\index{t-test@\textbf{t-test}} A \emph{t}-test is used to compare the
means of two groups of continuous variables. Volumes have been written
about this else where, and we won't rehearse it here.

There are various variations on the \emph{t}-test. We will use two here.
The most useful in our context is a two-sample test if independent
groups (first figure). Repeated-measures data such as comparing the same
countries between years can be analysed using a paired \emph{t}-test
(second figure)

\hypertarget{two-sample-t-tests}{%
\subsection{\texorpdfstring{Two-sample
\emph{t}-tests}{Two-sample t-tests}}\label{two-sample-t-tests}}

\index{t-test@\textbf{t-test}!two-sample}

Referring to the first figure, let's compare life expectancy between
Asia and Europe for 2007. What is imperative, is that you decide what
sort of difference exists by looking at the boxplot, rather than relying
on the \emph{t}-test output. The median for Europe is clearly higher
than in Asia. The distributions overlap, but it looks likely that Europe
has a higher life expectancy than Asia.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ttest_data =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                      }\CommentTok{# save as object testdata}
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{                   }\CommentTok{# 2007 only}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Asia"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{)) }\CommentTok{# Asia/Europe only}

\NormalTok{ttest_result =}\StringTok{ }
\StringTok{  }\KeywordTok{t.test}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{continent, }\DataTypeTok{data =}\NormalTok{ ttest_data) }\CommentTok{# Base R t.test}
\NormalTok{ttest_result}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  lifeExp by continent
## t = -4.6468, df = 41.529, p-value = 3.389e-05
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -9.926525 -3.913705
## sample estimates:
##   mean in group Asia mean in group Europe 
##             70.72848             77.64860
\end{verbatim}

\index{functions!filter} \index{functions!t.test}

The Welch two-sample t-test is the most flexible and copes with
differences in variance (variability) between groups, as in this
example. The difference in means is provided at the bottom of the
output. The \emph{t}-value, degrees of freedom (df) and p-value are all
provided. The p-value is 0.00003.

The base R output is not that easy to utilise. For reference, the
results can be explored and exported. However, more straightforward
methods are provided below.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{names}\NormalTok{(ttest_result)  }\CommentTok{# Names of elements of result object}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "statistic"   "parameter"   "p.value"     "conf.int"    "estimate"   
## [6] "null.value"  "alternative" "method"      "data.name"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{str}\NormalTok{(ttest_result)    }\CommentTok{# Details of result object}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## List of 9
##  $ statistic  : Named num -4.65
##   ..- attr(*, "names")= chr "t"
##  $ parameter  : Named num 41.5
##   ..- attr(*, "names")= chr "df"
##  $ p.value    : num 3.39e-05
##  $ conf.int   : atomic [1:2] -9.93 -3.91
##   ..- attr(*, "conf.level")= num 0.95
##  $ estimate   : Named num [1:2] 70.7 77.6
##   ..- attr(*, "names")= chr [1:2] "mean in group Asia" "mean in group Europe"
##  $ null.value : Named num 0
##   ..- attr(*, "names")= chr "difference in means"
##  $ alternative: chr "two.sided"
##  $ method     : chr "Welch Two Sample t-test"
##  $ data.name  : chr "lifeExp by continent"
##  - attr(*, "class")= chr "htest"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ttest_result}\OperatorTok{$}\NormalTok{p.value }\CommentTok{# Extracted element of result object}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.38922e-05
\end{verbatim}

The \texttt{broom} package provides useful methods for `tidying' common
model outputs into a \texttt{tibble}.\\
The whole analysis can be constructed as a single piped function.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(broom)}
\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{                        }\CommentTok{# 2007 only}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Asia"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{  }\CommentTok{# Asia/Europe only}
\StringTok{  }\KeywordTok{t.test}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{continent, }\DataTypeTok{data =}\NormalTok{ .) }\OperatorTok{%>%}\StringTok{  }
\StringTok{  }\KeywordTok{tidy}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 10
##   estimate estimate1 estimate2 statistic p.value parameter conf.low
##      <dbl>     <dbl>     <dbl>     <dbl>   <dbl>     <dbl>    <dbl>
## 1    -6.92      70.7      77.6     -4.65 3.39e-5      41.5    -9.93
## # ... with 3 more variables: conf.high <dbl>, method <chr>,
## #   alternative <chr>
\end{verbatim}

\index{functions!filter} \index{functions!tidy}

\hypertarget{paired-t-tests}{%
\subsection{\texorpdfstring{Paired
\emph{t}-tests}{Paired t-tests}}\label{paired-t-tests}}

\index{t-test@\textbf{t-test}!paired}

Consider that we want to compare the difference in life expectancy in
Asian countries between 2002 and 2007. The overall difference is not
impressive in the boxplot.

We can plot differences at the country level directly.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{paired_data =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{               }\CommentTok{# save as object paired_data}
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{2002}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}\StringTok{  }\CommentTok{# 2002 and 2007 only}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Asia"}\NormalTok{)          }\CommentTok{# Asia only}

\NormalTok{paired_data }\OperatorTok{%>%}\StringTok{      }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp, }
             \DataTypeTok{group =}\NormalTok{ country)) }\OperatorTok{+}\StringTok{       }\CommentTok{# for individual country lines}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-11-1.pdf}
\caption{\label{fig:unnamed-chunk-11}Line plot: Change in life expectancy in
Asian countries from 2002 to 2007}
\end{figure}

\index{functions!filter} \index{plotting!geom\_line}

What is the difference in life expectancy for each individual country.
We don't usually have to produce this directly, but here is one method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{paired_table =}\StringTok{ }\NormalTok{paired_data }\OperatorTok{%>%}\StringTok{        }\CommentTok{# save object paired_data}
\StringTok{  }\KeywordTok{select}\NormalTok{(country, year, lifeExp) }\OperatorTok{%>%}\StringTok{  }\CommentTok{# select vars interest}
\StringTok{  }\KeywordTok{spread}\NormalTok{ (year, lifeExp) }\OperatorTok{%>%}\StringTok{          }\CommentTok{# make wide table}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}
    \DataTypeTok{dlifeExp =} \StringTok{`}\DataTypeTok{2007}\StringTok{`} \OperatorTok{-}\StringTok{ `}\DataTypeTok{2002}\StringTok{`}        \CommentTok{# difference in means}
\NormalTok{  )}

\NormalTok{paired_table}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 33 x 4
##    country          `2002` `2007` dlifeExp
##    <fct>             <dbl>  <dbl>    <dbl>
##  1 Afghanistan        42.1   43.8    1.70 
##  2 Bahrain            74.8   75.6    0.84 
##  3 Bangladesh         62.0   64.1    2.05 
##  4 Cambodia           56.8   59.7    2.97 
##  5 China              72.0   73.0    0.933
##  6 Hong Kong, China   81.5   82.2    0.713
##  7 India              62.9   64.7    1.82 
##  8 Indonesia          68.6   70.6    2.06 
##  9 Iran               69.5   71.0    1.51 
## 10 Iraq               57.0   59.5    2.50 
## # ... with 23 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Mean of difference in years}
\NormalTok{paired_table }\OperatorTok{%>%}\StringTok{ }\KeywordTok{summarise}\NormalTok{( }\KeywordTok{mean}\NormalTok{(dlifeExp) )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 1
##   `mean(dlifeExp)`
##              <dbl>
## 1             1.49
\end{verbatim}

\index{functions!select} \index{functions!spread}
\index{functions!mutate} \index{functions!summarise}

On average, therefore, there is an increase in life expectancy of 1.5
years in Asian countries between 2002 and 2007. Let's test whether this
number differs from zero with a paired \emph{t}-test.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{paired_data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{t.test}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ .) }\CommentTok{# Include paired = TRUE}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  lifeExp by year
## t = -0.74294, df = 63.839, p-value = 0.4602
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -5.513722  2.524510
## sample estimates:
## mean in group 2002 mean in group 2007 
##           69.23388           70.72848
\end{verbatim}

\index{functions!t.test}

The results show a highly significant difference. As an exercise you can
repeat this analysis simply comparing the means in an unpaired manner.
The resulting p-value is
\texttt{R\ paired\_data\ \%\textgreater{}\%\ t.test(lifeExp\ \textasciitilde{}\ year,\ data\ =\ .)\$p.value}.
Why is there such a difference between the two approaches? This
emphasises just how important it is to plot the data first. The average
difference of 1.5 years is highly consistent between countries, as show
on the line plot, and this differs from zero. It is up to you the
investigator to interpret the effect size of 1.5 y in reporting the
finding.

\hypertarget{compare-the-mean-of-one-group}{%
\section{Compare the mean of one
group}\label{compare-the-mean-of-one-group}}

\hypertarget{one-sample-t-tests}{%
\subsection{\texorpdfstring{One sample
\emph{t}-tests}{One sample t-tests}}\label{one-sample-t-tests}}

\index{t-test@\textbf{t-test}!one-sample}

We can use a \emph{t}-test to determine whether the mean of a
distribution is different to a specific value.

The paired \emph{t}-test above is is equivalent to a one-sample
\emph{t}-test on the calculated difference in life expectancy being
different to zero.

\begin{Shaded}
\begin{Highlighting}[]
  \KeywordTok{t.test}\NormalTok{(paired_table}\OperatorTok{$}\NormalTok{dlifeExp)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  One Sample t-test
## 
## data:  paired_table$dlifeExp
## t = 14.338, df = 32, p-value = 1.758e-15
## alternative hypothesis: true mean is not equal to 0
## 95 percent confidence interval:
##  1.282271 1.706941
## sample estimates:
## mean of x 
##  1.494606
\end{verbatim}

We can compare to values other than zero. For instance, we can test
whether the mean life expectancy in each continent was significantly
different to 77 years in 2007. We have included some extra code here to
demonstrate how to run multiple base R tests in one pipe function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{          }\CommentTok{# 2007 only}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent) }\OperatorTok{%>%}\StringTok{           }\CommentTok{# split by continent}
\StringTok{  }\KeywordTok{do}\NormalTok{(                               }\CommentTok{# dplyr function}
    \KeywordTok{t.test}\NormalTok{(.}\OperatorTok{$}\NormalTok{lifeExp, }\DataTypeTok{mu =} \DecValTok{77}\NormalTok{) }\OperatorTok{%>%}\StringTok{  }\CommentTok{# compare mean to 77 years }
\StringTok{      }\KeywordTok{tidy}\NormalTok{()                        }\CommentTok{# tidy into tibble}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 9
## # Groups:   continent [5]
##   continent estimate statistic  p.value parameter conf.low conf.high method
##   <fct>        <dbl>     <dbl>    <dbl>     <dbl>    <dbl>     <dbl> <chr> 
## 1 Africa        54.8    -16.6  3.15e-22        51     52.1      57.5 One S~
## 2 Americas      73.6     -3.82 8.32e- 4        24     71.8      75.4 One S~
## 3 Asia          70.7     -4.52 7.88e- 5        32     67.9      73.6 One S~
## 4 Europe        77.6      1.19 2.43e- 1        29     76.5      78.8 One S~
## 5 Oceania       80.7      7.22 8.77e- 2         1     74.2      87.3 One S~
## # ... with 1 more variable: alternative <chr>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{           }\CommentTok{# 2007 only}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent) }\OperatorTok{%>%}\StringTok{            }\CommentTok{# split by continent}
\StringTok{  }\KeywordTok{group_modify}\NormalTok{(                      }\CommentTok{# dplyr function}
    \OperatorTok{~}\StringTok{ }\KeywordTok{t.test}\NormalTok{(.}\OperatorTok{$}\NormalTok{lifeExp, }\DataTypeTok{mu =} \DecValTok{77}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\CommentTok{# compare mean to 77 years }
\StringTok{      }\KeywordTok{tidy}\NormalTok{()                         }\CommentTok{# tidy into tibble}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 9
## # Groups:   continent [5]
##   continent estimate statistic  p.value parameter conf.low conf.high method
##   <fct>        <dbl>     <dbl>    <dbl>     <dbl>    <dbl>     <dbl> <chr> 
## 1 Africa        54.8    -16.6  3.15e-22        51     52.1      57.5 One S~
## 2 Americas      73.6     -3.82 8.32e- 4        24     71.8      75.4 One S~
## 3 Asia          70.7     -4.52 7.88e- 5        32     67.9      73.6 One S~
## 4 Europe        77.6      1.19 2.43e- 1        29     76.5      78.8 One S~
## 5 Oceania       80.7      7.22 8.77e- 2         1     74.2      87.3 One S~
## # ... with 1 more variable: alternative <chr>
\end{verbatim}

\index{functions!filter} \index{functions!group\_by}
\index{functions!do} \index{functions!t.test} \index{functions!tidy}

The mean life expectancy for Europe and Oceania do not differ from 77,
while the others to to varying degrees. In particular, look at the
confidence intervals of the tables and whether they include or exclude
77.

\hypertarget{compare-the-means-of-more-than-two-groups}{%
\section{Compare the means of more than two
groups}\label{compare-the-means-of-more-than-two-groups}}

It may be that our question is set around a hypothesis involving more
than two groups. For example, we may be interested in comparing life
expectancy across 3 continents such as the Americas, Europe and Asia.

\hypertarget{plot-the-data-1}{%
\subsection{Plot the data}\label{plot-the-data-1}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }
\StringTok{             }\KeywordTok{c}\NormalTok{(}\StringTok{"Americas"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{, }\StringTok{"Asia"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ continent, }\DataTypeTok{y=}\NormalTok{lifeExp)) }\OperatorTok{+}
\StringTok{    }\KeywordTok{geom_boxplot}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-17-1.pdf}
\caption{\label{fig:unnamed-chunk-17}Boxplot: Life expectancy in selected
continents for 2007}
\end{figure}

\index{functions!filter} \index{plotting!geom\_boxplot}

\hypertarget{anova}{%
\subsection{ANOVA}\label{anova}}

\index{analysis of variance (ANOVA)}

Analysis of variance is a collection of statistical tests which can be
used to test the difference in means between two or more groups.

In base R form, it produces an ANOVA table which includes an F-test.
This so-called omnibus test tells you whether there are any differences
in the comparison of means of the included groups. Again, it is
important to plot carefully and be clear what question you are asking.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aov_data =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Americas"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{, }\StringTok{"Asia"}\NormalTok{))}

\NormalTok{fit =}\StringTok{ }\KeywordTok{aov}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{continent, }\DataTypeTok{data =}\NormalTok{ aov_data) }
\KeywordTok{summary}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##             Df Sum Sq Mean Sq F value   Pr(>F)    
## continent    2  755.6   377.8   11.63 3.42e-05 ***
## Residuals   85 2760.3    32.5                     
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
\end{verbatim}

\index{functions!aov} \index{functions!summary}

We can conclude from this, that there is a difference in the means
between at least two pairs of the included continents. As above, the
output can be neatened up using the \texttt{tidy} function.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(broom)}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Americas"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{, }\StringTok{"Asia"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{aov}\NormalTok{(lifeExp}\OperatorTok{~}\NormalTok{continent, }\DataTypeTok{data =}\NormalTok{ .) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{tidy}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 6
##   term         df sumsq meansq statistic    p.value
##   <chr>     <dbl> <dbl>  <dbl>     <dbl>      <dbl>
## 1 continent     2  756.  378.       11.6  0.0000342
## 2 Residuals    85 2760.   32.5      NA   NA
\end{verbatim}

\index{functions!filter} \index{functions!aov} \index{functions!tidy}

\hypertarget{assumptions}{%
\subsection{Assumptions}\label{assumptions}}

As with the normality assumption of the \emph{t}-test, there are
assumptions of the ANOVA model). These are covered in detail in the
linear regression chapter and will not be repeated here. Suffice to say
that diagnostic plots can be produced to check that the assumptions are
fulfilled.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow=}\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{))}
\KeywordTok{plot}\NormalTok{(fit)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-20-1.pdf}
\caption{\label{fig:unnamed-chunk-20}Diagnostic plots: ANOVA model of life
expectancy by continent for 2007}
\end{figure}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{par}\NormalTok{(}\DataTypeTok{mfrow=}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{pairwise-testing-and-multiple-comparisons}{%
\subsection{Pairwise testing and multiple
comparisons}\label{pairwise-testing-and-multiple-comparisons}}

\index{pairwise testing}

When the F-test is significant, we will often want to proceed to try and
determine where the differences lie. This should of course be obvious
from the boxplot you have made. However, some are fixated on the
p-value!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{pairwise.t.test}\NormalTok{(aov_data}\OperatorTok{$}\NormalTok{lifeExp, aov_data}\OperatorTok{$}\NormalTok{continent, }
                \DataTypeTok{p.adjust.method =} \StringTok{"bonferroni"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pairwise comparisons using t tests with pooled SD 
## 
## data:  aov_data$lifeExp and aov_data$continent 
## 
##        Americas Asia   
## Asia   0.180    -      
## Europe 0.031    1.9e-05
## 
## P value adjustment method: bonferroni
\end{verbatim}

\index{functions!pairwise.t.test}

A matrix of pairwise p-values is produced. Here we can that there is
good evidence of a difference in means between Europe and Asia.

The p-values are corrected for multiple comparisons. When performing a
hypothesis test at the 5\% level (alpha = 0.05), there is a 5\% chance
of a type 1 error. That is, a 1 in 20 chance of concluding a difference
exists when it in fact does not (formally, this is rejection of a true
null hypothesis). As more simultaneous statistical tests are performed,
the chance of a type 1 error increases.

There are three approaches to this. The first, is to no perform any
correction at all. Some advocate that the best approach is simply to
present the results of all the tests that were performed, and let the
sceptical reader make adjustments themselves. This is attractive, but
presupposes a sophisticated readership who will take the time to
consider the results in their entirety.

The second and classical approach, is to control for the so-called
family-wise error rate. The ``Bonferroni'' correction is probably the
most famous and most conservative, where the threshold for significance
is lowered in proportion to the number of comparisons made. For example,
if three comparisons are made, the threshold for significance is lowered
to 0.017. Equivalently, any particular p-value can be multiples by 3 and
the value compared to a threshold of 0.05, as is done above. The
Bonferroni method is particular conservative, meaning that type 2 errors
may occur (failure to identify true differences, or false negatives) in
favour or minimising type 1 errors (false positives).

The third newer approach controls false-discovery rate. The development
of these methods has been driven in part by the needs of areas of
science where many different statistical tests are performed at the same
time, for instance, examining the influence of 1000 genes
simultaneously. In these hypothesis-generating settings, a higher
tolerance to type 1 errors may be preferable to missing potential
findings through type 2 errors. You can see in our example, that the
p-values are lower with the \texttt{fdr} correction when compared to the
\texttt{Bonferroni} correction.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{pairwise.t.test}\NormalTok{(aov_data}\OperatorTok{$}\NormalTok{lifeExp, aov_data}\OperatorTok{$}\NormalTok{continent, }
                \DataTypeTok{p.adjust.method =} \StringTok{"fdr"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pairwise comparisons using t tests with pooled SD 
## 
## data:  aov_data$lifeExp and aov_data$continent 
## 
##        Americas Asia   
## Asia   0.060    -      
## Europe 0.016    1.9e-05
## 
## P value adjustment method: fdr
\end{verbatim}

\index{functions!pairwise.t.test}

Try not to get too hung up on this. Be sensible. Plot the data and look
for differences. Focus on effect size, for instance, the actual
difference in life expectancy in years, rather than the p-value of a
comparison test. Choose a method which fits with your overall aims. If
you are generating hypotheses which you will proceed to test with other
methods, the \texttt{fdr} approach may be preferable. If you are trying
to capture robust effect and want to minimise type 2 errors, use a
family-wise approach.

\hypertarget{non-parametric-data}{%
\section{Non-parametric data}\label{non-parametric-data}}

\index{non-parametric tests@\textbf{non-parametric tests}}

What if your data is different shape to normal or the ANOVA assumptions
are not fulfilled (see linear regression chapter). As always, be
sensible! Would your data be expected to be normally distributed given
the data-generating process? For instance, if you examining length of
hospital stay it is likely that your data are highly right skewed - most
patients are discharged from hospital in a few days while a smaller
number stay for a long time. Is a comparison of means ever going to be
the correct approach here? Perhaps you should consider a time-to-event
analysis for instance (see chapter x).

If a comparison of means approach is reasonable, but the normality
assumption are not fulfilled there are two approaches,

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Transform the data;
\item
  Perform non-parametric tests.
\end{enumerate}

\hypertarget{transforming-data}{%
\subsection{Transforming data}\label{transforming-data}}

\index{tranformations}

Remember, the Welch \emph{t}-test is reasonably robust to divergence
from the normality assumption, so small deviations can be safely
ignored.

Otherwise, the data can be transformed to another scale to deal with a
skew. A natural \texttt{log} scale is most common.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{africa_data =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                }\CommentTok{# save as africa_data}
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2002}\NormalTok{) }\OperatorTok{%>%}\StringTok{              }\CommentTok{# only 2002}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Africa"}\NormalTok{) }\OperatorTok{%>%}\StringTok{     }\CommentTok{# only Africa}
\StringTok{  }\KeywordTok{select}\NormalTok{(country, lifeExp) }\OperatorTok{%>%}\StringTok{          }\CommentTok{# only these variables}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}
    \DataTypeTok{lifeExp_log =} \KeywordTok{log}\NormalTok{(lifeExp)          }\CommentTok{# log life expectancy}
\NormalTok{  )}
\KeywordTok{head}\NormalTok{(africa_data)                       }\CommentTok{# inspect}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 3
##   country      lifeExp lifeExp_log
##   <fct>          <dbl>       <dbl>
## 1 Algeria         71.0        4.26
## 2 Angola          41.0        3.71
## 3 Benin           54.4        4.00
## 4 Botswana        46.6        3.84
## 5 Burkina Faso    50.6        3.92
## 6 Burundi         47.4        3.86
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{africa_data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{gather}\NormalTok{(key, lifeExp, }\OperatorTok{-}\NormalTok{country) }\OperatorTok{%>%}\StringTok{     }\CommentTok{# gather vals to same column}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{             }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{15}\NormalTok{) }\OperatorTok{+}\StringTok{            }\CommentTok{# make histogram}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{key, }\DataTypeTok{scales =} \StringTok{"free"}\NormalTok{)   }\CommentTok{# facet & axes free to vary}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-23-1.pdf}
\caption{\label{fig:unnamed-chunk-23}Histogram: Log transformation of life
expectancy for countries in Africa 2002}
\end{figure}

\index{functions!filter} \index{functions!select}
\index{functions!mutate} \index{functions!head} \index{functions!gather}
\index{plotting!geom\_histogram} \index{plotting!facet\_grid}

This has worked well here. The right skew on the Africa data has been
dealt with by the transformation. A parametric test such as a
\emph{t}-test can now be performed.

\hypertarget{non-parametric-test-for-comparing-two-groups}{%
\subsection{Non-parametric test for comparing two
groups}\label{non-parametric-test-for-comparing-two-groups}}

\index{non-parametric tests@\textbf{non-parametric tests}!Mann-Whitney U}
\index{non-parametric tests@\textbf{non-parametric tests}!Wilcoxon rank sum}

The Mann-Whitney U test is also called the Wilcoxon rank-sum test and
uses a rank-based method to compare two groups (note the Wilcoxon
signed-rank test is for paired data). We can use if to test for a
difference in life expectancies for African countries between 1982 and
2007. Let's do a histogram, Q-Q plot and boxplot first.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{africa_plot =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                          }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1982}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}\StringTok{      }\CommentTok{# only 1982 and 2007}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Africa"}\NormalTok{))       }\CommentTok{# only Africa}

\NormalTok{p1 =}\StringTok{ }\NormalTok{africa_plot }\OperatorTok{%>%}\StringTok{                       }\CommentTok{# save plot as p1}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{15}\NormalTok{) }\OperatorTok{+}
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{year)}

\NormalTok{p2 =}\StringTok{ }\NormalTok{africa_plot }\OperatorTok{%>%}\StringTok{                       }\CommentTok{# save plot as p2}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{sample =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{          }\CommentTok{# `sample` for Q-Q plot}
\StringTok{  }\KeywordTok{geom_qq}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_qq_line}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{year)}

\NormalTok{p3 =}\StringTok{ }\NormalTok{africa_plot }\OperatorTok{%>%}\StringTok{                       }\CommentTok{# save plot as p3}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{factor}\NormalTok{(year),}
             \DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{               }\CommentTok{# change year to factor}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \KeywordTok{factor}\NormalTok{(year))) }\OperatorTok{+}\StringTok{ }\CommentTok{# colour boxplot}
\StringTok{  }\KeywordTok{geom_jitter}\NormalTok{(}\DataTypeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\OperatorTok{+}\StringTok{               }\CommentTok{# add data points}
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)          }\CommentTok{# remove legend}

\KeywordTok{library}\NormalTok{(patchwork)                         }\CommentTok{# great for combining plots}
\NormalTok{p1 }\OperatorTok{/}\StringTok{ }\NormalTok{p2 }\OperatorTok{|}\StringTok{ }\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-24-1.pdf}
\caption{\label{fig:unnamed-chunk-24}Panels plots: histogram, Q-Q, boxplot
for life expectancy in Africa 1992 v 2007}
\end{figure}

\index{functions!filter} \index{plotting!geom\_boxplot}
\index{plotting!facet\_grid} \index{plotting!geom\_qq}
\index{plotting!geom\_qq\_line} \index{plotting!geom\_jitter}
\index{plotting!patchwork} \index{plotting!theme}

The data is a little skewed based on the histograms and Q-Q plots. The
difference between 1982 and 2007 is not particularly striking on the
boxplot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{africa_plot }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{wilcox.test}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ .)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Wilcoxon rank sum test with continuity correction
## 
## data:  lifeExp by year
## W = 1130, p-value = 0.1499
## alternative hypothesis: true location shift is not equal to 0
\end{verbatim}

\index{functions!wilcox.test}

\hypertarget{non-parametric-test-for-comparing-more-than-two-groups}{%
\subsection{Non-parametric test for comparing more than two
groups}\label{non-parametric-test-for-comparing-more-than-two-groups}}

\index{non-parametric tests@\textbf{non-parametric tests}!!Kruskal-Wallis}

The non-parametric equivalent to ANOVA, is the Kruskal-Wallis test. It
can be used in base R, or via the finalfit package below.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(broom)}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Americas"}\NormalTok{, }\StringTok{"Europe"}\NormalTok{, }\StringTok{"Asia"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kruskal.test}\NormalTok{(lifeExp}\OperatorTok{~}\NormalTok{continent, }\DataTypeTok{data =}\NormalTok{ .) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{tidy}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 4
##   statistic   p.value parameter method                      
##       <dbl>     <dbl>     <int> <chr>                       
## 1      21.6 0.0000202         2 Kruskal-Wallis rank sum test
\end{verbatim}

\index{functions!filter} \index{functions!kruskal.test}
\index{functions!tidy}

\hypertarget{finalfit-approach}{%
\section{Finalfit approach}\label{finalfit-approach}}

The finalfit package provides an easy to use interface for performing
non-parametric hypothesis tests. Any number of explanatory variables can
be tested against a so-called dependent variable. In this case, this is
equivalent to a typical Table 1 in healthcare study.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent =}\StringTok{ "year"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"lifeExp"}\NormalTok{, }\StringTok{"pop"}\NormalTok{, }\StringTok{"gdpPercap"}\NormalTok{)}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                          }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1982}\NormalTok{, }\DecValTok{2007}\NormalTok{)) }\OperatorTok{%>%}\StringTok{       }\CommentTok{# only 1982 and 2007}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Africa"}\NormalTok{) }\OperatorTok{%>%}\StringTok{         }\CommentTok{# only Africa}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}
    \DataTypeTok{year =} \KeywordTok{factor}\NormalTok{(year)                     }\CommentTok{# change year to factor}
\NormalTok{  ) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summary_factorlist}\NormalTok{(dependent, explanatory,}
                     \DataTypeTok{cont =} \StringTok{"median"}\NormalTok{, }\DataTypeTok{p =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\NormalTok{knitr}\OperatorTok{::}\KeywordTok{kable}\NormalTok{(}\DataTypeTok{row.names =} \OtherTok{FALSE}\NormalTok{, }\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{, }
               \DataTypeTok{align =} \KeywordTok{c}\NormalTok{(}\StringTok{"l"}\NormalTok{, }\StringTok{"l"}\NormalTok{, }\StringTok{"r"}\NormalTok{, }\StringTok{"r"}\NormalTok{, }\StringTok{"r"}\NormalTok{, }\StringTok{"r"}\NormalTok{),}
               \DataTypeTok{caption =} \StringTok{"Life expectancy, population and GDPperCap in Africa 1982 v 2007"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}[t]

\caption{\label{tab:unnamed-chunk-27}Life expectancy, population and GDPperCap in Africa 1982 v 2007}
\centering
\begin{tabular}{llrrr}
\toprule
label & levels & 1982 & 2007 & p\\
\midrule
lifeExp & Median (IQR) & 50.8 (11.0) & 52.9 (11.6) & 0.150\\
pop & Median (IQR) & 5668228.5 (8218654.0) & 10093310.5 (16454428.0) & 0.032\\
gdpPercap & Median (IQR) & 1323.7 (1958.9) & 1452.3 (3130.6) & 0.506\\
\bottomrule
\end{tabular}
\end{table}

\index{functions!filter} \index{functions!mutate}
\index{functions!summary\_factorlist}

\hypertarget{conclusions}{%
\section{Conclusions}\label{conclusions}}

Continuous data is frequently encountered in a healthcare setting.
Liberal use of plotting is required to really understand the underlying
data. Comparisons can easily made between two or more groups of data,
but always remember what you are actually trying to analyse and don't
become fixated on the p-value. In the next chapter, we will explore the
comparison of two continuous variables together with multivariable
models of datasets.

\hypertarget{exercises}{%
\section{Exercises}\label{exercises}}

\hypertarget{exercise-1-1}{%
\subsection{Exercise 1}\label{exercise-1-1}}

Make a histogram, Q-Q plot, and a box-plot for the life expectancy for a
continent of your choice, but for all years. Do the data appear normally
distributed?

\hypertarget{exercise-2-1}{%
\subsection{Exercise 2}\label{exercise-2-1}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Select any 2 years in any continent and perform a \emph{t}-test to
  determine whether mean life expectancy is significantly different.
  Remember to plot your data first.
\item
  Extract only the p-value from your \texttt{t.test()} output.
\end{enumerate}

\hypertarget{exercise-3-1}{%
\subsection{Exercise 3}\label{exercise-3-1}}

In 2007, in which continents did mean life expectancy differ from 70.

\hypertarget{exercise-4-1}{%
\subsection{Exercise 4}\label{exercise-4-1}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Use ANOVA to determine if the population changed significantly through
  the 1990s/2000s in individual continents.
\end{enumerate}

\hypertarget{exercise-solutions}{%
\section{Exercise solutions}\label{exercise-solutions}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Exerise 1 }
\CommentTok{## Make a histogram, Q-Q plot, and a box-plot for the life expectancy}
\CommentTok{## for a continent of your choice, but for all years. }
\CommentTok{## Do the data appear normally distributed?}

\NormalTok{asia_plot =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                          }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Asia"}\NormalTok{))              }

\NormalTok{p1 =}\StringTok{ }\NormalTok{asia_plot }\OperatorTok{%>%}\StringTok{                              }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{15}\NormalTok{) }\CommentTok{#+                 }
  \CommentTok{#facet_grid(. ~ year)                         # no facet}

\NormalTok{p2 =}\StringTok{ }\NormalTok{asia_plot }\OperatorTok{%>%}\StringTok{                          }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{sample =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{               }\CommentTok{# `sample` for Q-Q plot}
\StringTok{  }\KeywordTok{geom_qq}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_qq_line}\NormalTok{() }\CommentTok{#+ }
  \CommentTok{#facet_grid(. ~ year)                         # no facet}

\NormalTok{p3 =}\StringTok{ }\NormalTok{asia_plot }\OperatorTok{%>%}\StringTok{                              }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{factor}\NormalTok{(year), }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{  }\CommentTok{# year as factor}
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \KeywordTok{factor}\NormalTok{(year))) }\OperatorTok{+}\StringTok{      }
\StringTok{  }\KeywordTok{geom_jitter}\NormalTok{(}\DataTypeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\OperatorTok{+}\StringTok{                    }
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)               }

\KeywordTok{library}\NormalTok{(patchwork)                              }
\NormalTok{p1 }\OperatorTok{/}\StringTok{ }\NormalTok{p2 }\OperatorTok{|}\StringTok{ }\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-28-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Exercise 2}
\CommentTok{## Select any 2 years in any continent and perform a *t*-test to }
\CommentTok{## determine whether mean life expectancy is significantly different. }
\CommentTok{## Remember to plot your data first.}

\NormalTok{asia_years =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                          }
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Asia"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{          }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\DecValTok{1952}\NormalTok{, }\DecValTok{1972}\NormalTok{))              }

\NormalTok{p1 =}\StringTok{ }\NormalTok{asia_years }\OperatorTok{%>%}\StringTok{                             }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\DataTypeTok{bins =} \DecValTok{15}\NormalTok{) }\OperatorTok{+}\StringTok{                 }
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{year)                          }

\NormalTok{p2 =}\StringTok{ }\NormalTok{asia_years }\OperatorTok{%>%}\StringTok{                            }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{sample =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{              }
\StringTok{  }\KeywordTok{geom_qq}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_qq_line}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{year)                        }

\NormalTok{p3 =}\StringTok{ }\NormalTok{asia_years }\OperatorTok{%>%}\StringTok{                             }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{factor}\NormalTok{(year), }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =} \KeywordTok{factor}\NormalTok{(year))) }\OperatorTok{+}\StringTok{      }
\StringTok{  }\KeywordTok{geom_jitter}\NormalTok{(}\DataTypeTok{alpha =} \FloatTok{0.4}\NormalTok{) }\OperatorTok{+}\StringTok{                    }
\StringTok{  }\KeywordTok{theme}\NormalTok{(}\DataTypeTok{legend.position =} \StringTok{"none"}\NormalTok{)               }

\KeywordTok{library}\NormalTok{(patchwork)                              }
\NormalTok{p1 }\OperatorTok{/}\StringTok{ }\NormalTok{p2 }\OperatorTok{|}\StringTok{ }\NormalTok{p3}
\end{Highlighting}
\end{Shaded}

\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-29-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{asia_years }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{t.test}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ .)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  lifeExp by year
## t = -4.7007, df = 63.869, p-value = 1.428e-05
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -15.681981  -6.327769
## sample estimates:
## mean in group 1952 mean in group 1972 
##           46.31439           57.31927
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Exercise 3}
\CommentTok{## In 2007, in which continents did mean life expectancy differ from 70}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{==}\StringTok{ }\DecValTok{2007}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_modify}\NormalTok{(}
    \OperatorTok{~}\StringTok{ }\KeywordTok{t.test}\NormalTok{(.}\OperatorTok{$}\NormalTok{lifeExp, }\DataTypeTok{mu =} \DecValTok{70}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{tidy}\NormalTok{() }\CommentTok{# Somtimes awkward in the tidyverse}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 9
## # Groups:   continent [5]
##   continent estimate statistic  p.value parameter conf.low conf.high method
##   <fct>        <dbl>     <dbl>    <dbl>     <dbl>    <dbl>     <dbl> <chr> 
## 1 Africa        54.8   -11.4   1.33e-15        51     52.1      57.5 One S~
## 2 Americas      73.6     4.06  4.50e- 4        24     71.8      75.4 One S~
## 3 Asia          70.7     0.525 6.03e- 1        32     67.9      73.6 One S~
## 4 Europe        77.6    14.1   1.76e-14        29     76.5      78.8 One S~
## 5 Oceania       80.7    20.8   3.06e- 2         1     74.2      87.3 One S~
## # ... with 1 more variable: alternative <chr>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Exercise 4}
\CommentTok{## Use Kruskal-Wallis to determine if the mean population changed }
\CommentTok{## significantly through the 1990s/2000s in individual continents. }

\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{>=}\DecValTok{1990}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =} \KeywordTok{factor}\NormalTok{(year), }\DataTypeTok{y =}\NormalTok{ pop)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_boxplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{facet_grid}\NormalTok{(. }\OperatorTok{~}\StringTok{ }\NormalTok{continent)}
\end{Highlighting}
\end{Shaded}

\includegraphics{06_tests_continuous_files/figure-latex/unnamed-chunk-31-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(year }\OperatorTok{>=}\DecValTok{1990}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(continent) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_modify}\NormalTok{(}
    \OperatorTok{~}\StringTok{ }\KeywordTok{kruskal.test}\NormalTok{(pop }\OperatorTok{~}\StringTok{ }\KeywordTok{factor}\NormalTok{(year), }\DataTypeTok{data =}\NormalTok{ .) }\OperatorTok{%>%}\StringTok{ }\KeywordTok{tidy}\NormalTok{()}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 5
## # Groups:   continent [5]
##   continent statistic p.value parameter method                      
##   <fct>         <dbl>   <dbl>     <int> <chr>                       
## 1 Africa        2.10    0.553         3 Kruskal-Wallis rank sum test
## 2 Americas      0.847   0.838         3 Kruskal-Wallis rank sum test
## 3 Asia          1.57    0.665         3 Kruskal-Wallis rank sum test
## 4 Europe        0.207   0.977         3 Kruskal-Wallis rank sum test
## 5 Oceania       1.67    0.644         3 Kruskal-Wallis rank sum test
\end{verbatim}

\hypertarget{linear-regression}{%
\chapter{Linear regression}\label{linear-regression}}

\hypertarget{regression}{%
\section{Regression}\label{regression}}

Regression is a method with which we can determine the existence and
strength of the relationship between two or more variables. This can be
thought of as drawing lines, ideally straight lines, through data
points.

Linear regression is our method of choice for examining continuous
outcome variables. Broadly, there are often two separate goals in
regression:

\begin{itemize}
\tightlist
\item
  Prediction: fitting a predictive model to an observed dataset. Using
  that model to make predictions about an outcome from a new set of
  explanatory variables;
\item
  Explanation: fit a model to explain the inter-relationships between a
  set of variables.
\end{itemize}

Figure \ref{fig:chap07-fig-regression} unifies the terms we will use
throughout. A clear scientific question should define our
\texttt{explanatory\ variable\ of\ interest} (\emph{x}), which sometimes
gets called a exposure, predictor, or independent variable. Our outcome
of interest will be referred to as the \texttt{dependent} variable
(\emph{y}), sometimes referred to as the response. In simple linear
regression, there is a single explanatory variable and a dependent
variable, and we will sometimes refer to this as \emph{univariable
linear regression}. When there is more than one explanatory variable, we
will call this \emph{multivariable regression}. Avoid the term
\emph{multivariate regression}, which suggests more than one dependent
variable. We don't use this method and we suggest you don't either!

Note that the dependent variable is always continuous, it cannot be a
categorical variable. The explanatory variables can be either continuous
or categorical.

\hypertarget{the-question-1}{%
\section{The Question (1)}\label{the-question-1}}

We will illustrate our examples of linear regression using a classical
question which is important to many of us! This is the relationship
between coffee consumption and blood pressure (and therefore
cardiovascular events, such as myocardial infarction and stroke). There
has been a lot of backwards and forwards over decades about whether
coffee is harmful, has no effect, or is in fact beneficial. Figure
\ref{fig:chap07-fig-regression} shows a linear regression example. Each
point is a person and average number of cups of coffee per day is the
explanatory variable of interest (\emph{x}) and systolic blood pressure
as the dependent variable (\emph{y}). This next bit is important! These
data are made up, fake, randomly generated, fabricated, not real. So
please do not alter your coffee habit on the basis of these plots!

\begin{figure}
\centering
\includegraphics{images/chapter07/1_regression_terms.pdf}
\caption{\label{fig:chap07-fig-regression}The anatomy of a regression plot.}
\end{figure}

\hypertarget{fitting-a-regression-line}{%
\section{Fitting a regression line}\label{fitting-a-regression-line}}

Simple linear regression uses the \emph{ordinary least squares} method
for fitting. The details of this are beyond the scope here, but if you
want to get out the linear algebra/matrix maths you did in high school,
an enjoyable afternoon can be spent proving to yourself how it actually
works.

Figure \ref{fig:chap07-fig-residuals} aims to make this easy to
understand. The maths defines a line which best fits the data provided.
For the line to fit best, the distances between it and the observed data
should be as small as possible. The distance from each observed point to
the line is called a \emph{residual} - one of those statistical terms
that bring on the sweats. It just refers to the ``residual error'' left
over after the line is fitted.

You can use the
\href{https://argoshare.is.ed.ac.uk/simple_regression}{simple regression
shiny app} to explore the concept. We want the residuals to be as small
as possible. We can square each residual (to get rid of minuses and
penalise further away points) and add them up. If this number is as
small as possible, the line is fitting as best it can. Or in more formal
language, we want to minimise the sum of squared residuals.

\begin{figure}
\centering
\includegraphics{images/chapter07/2_residuals.pdf}
\caption{\label{fig:chap07-fig-residuals}How a regression line is fitted.}
\end{figure}

\hypertarget{when-the-line-fits-well}{%
\section{When the line fits well}\label{when-the-line-fits-well}}

Linear regression modelling has four main assumptions:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Linear relationship;
\item
  Independence of residuals;
\item
  Normal distribution of residuals;
\item
  Equal variance of residuals.
\end{enumerate}

You can use the
\href{https://argoshare.is.ed.ac.uk/simple_regression_diagnostics}{simple
regression diagnostics shiny app} to get a handle on these.

Figure \ref{fig:chap07-fig-diags} shows diagnostic plots from the app,
which we will run ourselves below.

\hypertarget{linear-relationship}{%
\subsection{Linear relationship}\label{linear-relationship}}

A simple scatter plot should show a linear relationship between the
explanatory and the dependent variable, as in figure
\ref{fig:chap07-fig-diags}A. If the data describe a non-linear pattern
(figure \ref{fig:chap07-fig-diags}B), then a straight line is not going
to fit it very well. In this situation, an alternative model should be
considered, such as including a quadratic (x\textsuperscript{2}) or
polynomial term.

\hypertarget{independence-of-residuals}{%
\subsection{Independence of residuals}\label{independence-of-residuals}}

The observations and therefore the residuals should be independent. This
is more commonly a problem in time series data, where observations may
be correlated across time with each other (autocorrelation).

\hypertarget{normal-distribution-of-residuals}{%
\subsection{Normal distribution of
residuals}\label{normal-distribution-of-residuals}}

The observations should be normally distributed around the fitted line.
This means that the residuals should show a normal distribution with a
mean of zero (figure \ref{fig:chap07-fig-diags}A). If the observations
are not equally distributed around the line, the histogram of residuals
will be skewed and a normal Q-Q plot will show residuals diverging from
the 45 degree line (figure \ref{fig:chap07-fig-diags}B). See \emph{Q-Q
plot ref}.

\hypertarget{equal-variance-of-residuals}{%
\subsection{Equal variance of
residuals}\label{equal-variance-of-residuals}}

The distribution of the observations around the fitted line should be
the same on the left side of the scatter plot as they are on the right
side. Look at the fan-shaped data on the
\href{https://argoshare.is.ed.ac.uk/simple_regression_diagnostics}{simple
regression diagnostics shiny app}. This should be obvious on the
residuals vs.~fitted values plot, as well as the histogram and normal
Q-Q plot.

This is really all about making sure that the line you draw through your
data points is valid. It is about ensuring that the regression line is
valid across the range of the explanatory variable and dependent
variable. It is really about understanding the underlying data, rather
than relying on a fancy statistical test that gives you a p-value.

\begin{figure}
\centering
\includegraphics{images/chapter07/3_diags.pdf}
\caption{\label{fig:chap07-fig-diags}Regression diagnostics.}
\end{figure}

\hypertarget{the-fitted-line-and-the-linear-equation}{%
\section{The fitted line and the linear
equation}\label{the-fitted-line-and-the-linear-equation}}

We promised to keep the equations to a minimum, but this one is so
important it needs to be included. But it is easy to understand, so fear
not.

Figure \ref{fig:chap07-fig-equation} links the fitted line, the linear
equation, and the output from R. Some of this will likely be already
familiar to you.

Figure \ref{fig:chap07-fig-equation}A shows a scatter plot with fitted
lines from a multivariable linear regression model. The plot is taken
from the
\href{https://argoshare.is.ed.ac.uk/multi_regression/}{multivariable
regression shiny app}. Remember, these data are simulated and are not
real. This app will really help you understand different regression
models, more on this below. The app allows us to specify ``the truth''
with the sliders on the left hand side. For instance, we can set the
intercept=1, meaning that when all \(x=0\), the value of the dependent
variable, \(\hat{y}=1\).

Our model has a continuous explanatory variable of interest (average
coffee consumption) and a further categorical variable (smoking). In the
example the truth is set as \(intercept=1\), \(\beta_1=1\) (true effect
of coffee on blood pressure, gradient/slope of line), and \(\beta_2=2\)
(true effect of smoking on blood pressure). The points on the plot are
simulated following the addition of random noise.

Figure \ref{fig:chap07-fig-equation}B shows the default output in R for
this linear regression model. Look carefully and make sure you are clear
how the fitted lines, the linear equation, and the R output fit
together. In this example, the random sample from our true population
specified above shows \(intercept=0.67\), \(\beta_1=1.00\) (coffee), and
\(\beta_2=2.48\) (smoking). A \emph{p}-value is provided
(\(Pr(> \left| t \right|)\)), which is the result of a null hypothesis
significance test for the gradient of the line being equal to zero. Said
another way, this is the probability that the gradient of the particular
line is equal to zero.

\begin{figure}
\centering
\includegraphics{images/chapter07/4_equation.pdf}
\caption{\label{fig:chap07-fig-equation}Linking the fitted line, regression
equation and R output.}
\end{figure}

\hypertarget{effect-modification}{%
\section{Effect modification}\label{effect-modification}}

Effect modification occurs when the size of the effect of the
explanatory variable of interest (exposure) on the outcome (dependent
variable) differs depending on the level of a third variable. Said
another way, this is a situation in which an explanatory variable
differentially (positively or negatively) modifies the observed effect
of another explanatory variable on the outcome.

Again, this is best thought about using the concrete example provided in
the \href{https://argoshare.is.ed.ac.uk/multi_regression/}{multivariable
regression shiny app}.

Figure \ref{fig:chap07-fig-dags} shows three potential causal pathways.

In the first, smoking is not associated with the outcome (blood
pressure) or our explanatory variable of interest (coffee consumption).

In the second, smoking is associated with elevated blood pressure, but
not with coffee consumption. This is an example of effect modification.

In the third, smoking is associated with elevated blood pressure and
with coffee consumption. This is an example of confounding.

\begin{figure}
\centering
\includegraphics{images/chapter07/5_dags.pdf}
\caption{\label{fig:chap07-fig-dags}Causal pathways, effect modification and
confounding.}
\end{figure}

\hypertarget{additive-vs.multiplicative-effect-modification-interaction}{%
\subsection{Additive vs.~multiplicative effect modification
(interaction)}\label{additive-vs.multiplicative-effect-modification-interaction}}

Depending on the field you work, will depend on which set of terms you
use. Effect modification can be additive or multiplicative. We refer to
multiplicative effect modification as simply including a statistical
interaction.

Figure \ref{fig:chap07-fig-types} should make it clear exactly how these
work. The data have been set-up to include an interaction term. What
does this mean?

\begin{itemize}
\tightlist
\item
  \(intercept=1\): the blood pressure (\(\hat{y}\)) for non-smokers who
  drink no coffee (all \(x=0\));
\item
  \(\beta_1=1\) (\texttt{coffee}): the additional blood pressure for
  each cup of coffee drunk by non-smokers (slope of the line when
  \(x_2=0\);
\item
  \(\beta_2=1\) (\texttt{smoking}): the difference in blood pressure
  between non-smokers and smokers who drink no coffee (\(x_1=0\));
\item
  \(\beta_3=1\) (\texttt{coffee:smoking} interaction): the blood
  pressure (\(\hat{y}\)) in addition to \(\beta_1\) and \(\beta_2\), for
  each cup of coffee drunk by smokers (\(x_2=1)\).
\end{itemize}

You may have to read that a couple of times in combination with looking
at Figure \ref{fig:chap07-fig-types}.

With the additive model, the fitted lines for non-smoking vs smoking are
constrained to be parallel. Look at the equation in Figure
\ref{fig:chap07-fig-types}B and convince yourself that the lines can
never be anything other than parallel.

A statistical interaction (or multiplicative effect modification) is a
situation where the effect of an explanatory variable on the outcome is
modified in non-additive manner. In other words using our example, the
fitted lines are no longer constrained to be parallel.

If we had not checked for an interaction effect, we would have
inadequately described the true relationship between these three
variables.

What does this mean back in reality? Well it may be biologically
plausible for the effect of smoking on blood pressure to increase
multiplicatively due to a a chemical interaction between cigarette smoke
and caffeine, for example.

Note, we are just trying to find a model which best describes the
underlying data. All models are approximations of reality.

\begin{figure}
\centering
\includegraphics{images/chapter07/6_types.pdf}
\caption{\label{fig:chap07-fig-types}Multivariable linear regression with
additive and multiplicative effect modification.}
\end{figure}

\hypertarget{r-squared-and-model-fit}{%
\section{R-squared and model fit}\label{r-squared-and-model-fit}}

Figure \ref{fig:chap07-fig-types} includes a further metric from the R
output: \texttt{Adjusted\ R-squared}.

R-squared is another measure of how close the data are to the fitted
line. It is also known as the coefficient of determination and
represents proportion of the dependent variable which is explained by
the explanatory variable(s). So 0.0 indicates that none of the
variability in the dependent is explained by the explanatory (no
relationship between data points and fitted line) and 1.0 indicates that
the model explains all of the variability in the dependent (fitted line
follows data points exactly).

R provides the \texttt{R-squared} and the \texttt{Adjusted\ R-squared}.
The adjusted R-squared includes a penalty the more explanatory variables
are included in the model. So if the model includes variables which do
not contribute to the description of the dependent variable, the
adjusted R-squared will be lower.

Looking again at Figure \ref{fig:chap07-fig-types}, in A, a simple model
of coffee alone does not describe the data well (adjusted R-squared
0.38). Add smoking to the model improves the fit as can be seen by the
fitted lines (0.87). But a true interaction exists in the actual data.
By including this interaction in the model, the fit is very good indeed
(0.93).

\hypertarget{confounding}{%
\section{Confounding}\label{confounding}}

The last important concept to mention here is confounding. Confounding
is a situation in which the association between an explanatory variable
(exposure) and outcome (dependent variable) is distorted by the presence
of another explanatory variable.

In our example, confounding exists if there is an association between
smoking and blood pressure AND smoking and coffee consumption (Figure
\ref{fig:chap07-fig-dags}C). This exists simply if smokers drink more
coffee than non-smokers.

Figure \ref{fig:chap07-fig-confounding} shows this really clearly. The
underlying data have been altered so that those who drink more than two
cups of coffee per day also smoke and those who drink fewer than two
cups per day do not smoke. A true effect of smoking on blood pressure is
entered, but NO effect of coffee on blood pressure.

If we simply fit blood pressure by coffee consumption (Figure
\ref{fig:chap07-fig-confounding}A), then we may mistakenly conclude a
relationship between coffee consumption and blood pressure. But this
does not exist, because the ground truth we have set is that no
relationship exists between coffee and blood pressure. We are simply
seeing the effect of smoking on blood pressure, which is confounding the
effect of coffee on blood pressure.

If we include the confounder in the model by adding smoking, the true
relationship becomes apparent. Two parallel flat lines indicating no
effect of coffee on blood pressure, but a relationship between smoking
and blood pressure. This procedure is often referred to as controlling
for or adjusting for confounders.

\begin{figure}
\centering
\includegraphics{images/chapter07/7_confounding.pdf}
\caption{\label{fig:chap07-fig-confounding}Multivariable linear regression
with confounding of coffee drinking by smoking.}
\end{figure}

\hypertarget{summary}{%
\section{Summary}\label{summary}}

We have intentionally spent some time going through the principles and
applications of linear regression because it is so important. A firm
grasp of these concepts lead to an easy understanding of other
regression procedures, such as logistic regression and Cox Proportional
Hazards regression.

We will now perform all this ourselves in R using a gapminder dataset
which you are familiar with from preceding chapters.

\hypertarget{fitting-simple-models}{%
\section{Fitting simple models}\label{fitting-simple-models}}

\hypertarget{the-question-2}{%
\subsection{The Question (2)}\label{the-question-2}}

We are interested in modelling the change in life expectancy for
different countries over the past 60 years.

\hypertarget{get-the-data-1}{%
\subsection{Get the data}\label{get-the-data-1}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(gapminder) }\CommentTok{# dataset}
\KeywordTok{library}\NormalTok{(lubridate) }\CommentTok{# handles dates}
\KeywordTok{library}\NormalTok{(finalfit)}
\KeywordTok{library}\NormalTok{(broom)}

\KeywordTok{theme_set}\NormalTok{(}\KeywordTok{theme_bw}\NormalTok{())}
\NormalTok{mydata =}\StringTok{ }\NormalTok{gapminder}
\end{Highlighting}
\end{Shaded}

\hypertarget{check-the-data-1}{%
\subsection{Check the data}\label{check-the-data-1}}

Always check a new dataset, as described in 06-1

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{glimpse}\NormalTok{(mydata) }\CommentTok{# each variable as line, variable type, first values}
\KeywordTok{missing_glimpse}\NormalTok{(mydata) }\CommentTok{# missing data for each variable}
\KeywordTok{ff_glimpse}\NormalTok{(mydata) }\CommentTok{# summary statistics for each variable}
\end{Highlighting}
\end{Shaded}

\hypertarget{plot-the-data-2}{%
\subsection{Plot the data}\label{plot-the-data-2}}

Let's plot the life expectancies in European countries over the past 60
years, focussing on the UK and Turkey.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{                         }\CommentTok{# save as object p}
\StringTok{  }\KeywordTok{filter}\NormalTok{(continent }\OperatorTok{==}\StringTok{ "Europe"}\NormalTok{) }\OperatorTok{%>%}\StringTok{    }\CommentTok{# Europe only}
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp)) }\OperatorTok{+}\StringTok{ }\CommentTok{# lifeExp~year  }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() }\OperatorTok{+}\StringTok{                       }\CommentTok{# plot points}
\StringTok{  }\KeywordTok{facet_wrap}\NormalTok{(}\OperatorTok{~}\StringTok{ }\NormalTok{country) }\OperatorTok{+}\StringTok{              }\CommentTok{# facet by country}
\StringTok{  }\KeywordTok{scale_x_continuous}\NormalTok{(}
    \DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\DecValTok{1960}\NormalTok{, }\DecValTok{1980}\NormalTok{, }\DecValTok{2000}\NormalTok{))      }\CommentTok{# adjust x-axis   }
\NormalTok{p                                      }\CommentTok{# view result}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-3-1.pdf}
\caption{\label{fig:unnamed-chunk-3}Scatterplot: Life expectancy by year in
European countries}
\end{figure}

We can add in simple best fit lines using \texttt{ggplot} directly

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method =} \StringTok{"lm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\centering
\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-4-1.pdf}
\caption{\label{fig:unnamed-chunk-4}Scatter and line plot: Life expectancy
by year in European countries with best fit simple linear regression
line.}
\end{figure}

\hypertarget{simple-linear-regression}{%
\subsection{Simple linear regression}\label{simple-linear-regression}}

As you can see, \texttt{ggplot()} is very happy to run and plot linear
regression models for us. While this is sometimes convenient, we usually
want to build, run, and explore these models ourselves. We can then
investigate the intercepts and the slope coefficients (linear increase
per year):

First let's plot two countries to compare, Turkey and United Kingdom

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(country }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Turkey"}\NormalTok{, }\StringTok{"United Kingdom"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp, }\DataTypeTok{colour =}\NormalTok{ country)) }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-5-1.pdf}

The two non-parallel lines may make you think of what has been discussed
above.

First, let's model the two countries separately.

United Kingdom:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_uk =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(country }\OperatorTok{==}\StringTok{ "United Kingdom"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp}\OperatorTok{~}\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ .)}

\NormalTok{fit_uk }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = lifeExp ~ year, data = .)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.69767 -0.31962  0.06642  0.36601  0.68165 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -2.942e+02  1.464e+01  -20.10 2.05e-09 ***
## year         1.860e-01  7.394e-03   25.15 2.26e-10 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.4421 on 10 degrees of freedom
## Multiple R-squared:  0.9844, Adjusted R-squared:  0.9829 
## F-statistic: 632.5 on 1 and 10 DF,  p-value: 2.262e-10
\end{verbatim}

Turkey:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_turkey =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(country }\OperatorTok{==}\StringTok{ "Turkey"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp}\OperatorTok{~}\NormalTok{year, }\DataTypeTok{data =}\NormalTok{ .)}

\NormalTok{fit_turkey }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summary}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = lifeExp ~ year, data = .)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.4373 -0.3457  0.1653  0.9008  1.1033 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(>|t|)    
## (Intercept) -924.58989   37.97715  -24.35 3.12e-10 ***
## year           0.49724    0.01918   25.92 1.68e-10 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.147 on 10 degrees of freedom
## Multiple R-squared:  0.9853, Adjusted R-squared:  0.9839 
## F-statistic: 671.8 on 1 and 10 DF,  p-value: 1.681e-10
\end{verbatim}

\emph{Probably covered enough already -\textgreater{}}

\hypertarget{when-pipe-sends-data-to-the-wrong-place-use-data-.-to-direct-it}{%
\subsection{\texorpdfstring{When pipe sends data to the wrong place: use
\texttt{,\ data\ =\ .} to direct
it}{When pipe sends data to the wrong place: use , data = . to direct it}}\label{when-pipe-sends-data-to-the-wrong-place-use-data-.-to-direct-it}}

In the code above, the \texttt{,\ data\ =\ .} bit is necessary because
the pipe usually sends data to the beginning of function brackets. So
\texttt{mydata\ \%\textgreater{}\%\ lm(lifeExp\textasciitilde{}year)}
would be equivalent to
\texttt{lm(mydata,\ lifeExp\textasciitilde{}year)}. However, this is not
an order that \texttt{lm()} will accept. \texttt{lm()} wants us to
specify the variables first
(\texttt{dependent\textasciitilde{}explanatory}), and then wants the
data these variables are present in. So we have to use the \texttt{.} to
tell the pipe to send the data to the second argument of \texttt{lm()},
not the first.

\hypertarget{accessing-the-coefficients-of-linear-regression}{%
\subsubsection{Accessing the coefficients of linear
regression}\label{accessing-the-coefficients-of-linear-regression}}

A simple linear regression model will return two coefficients - the
intercept and the slope (the second returned value). Compare this to the
\texttt{summary()} output above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_uk}\OperatorTok{$}\NormalTok{coefficients}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  (Intercept)         year 
## -294.1965876    0.1859657
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_turkey}\OperatorTok{$}\NormalTok{coefficients}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  (Intercept)         year 
## -924.5898865    0.4972399
\end{verbatim}

In this example, the intercept is telling us that life expectancy at
year 0 in the United Kingdom (some 2000 years ago) was -294 years. While
this is mathematically correct (based on the data we have), it makes no
sense in practice. It is important at all stages of data analysis, to
keep ``sense checking'' your results.

To make the intercepts meaningful, we will add in a new column called
\texttt{year\_from1952} and re-run \texttt{fit\_uk} and
\texttt{fit\_turkey} using \texttt{year\_from1952} instead of
\texttt{year}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{year_from1952 =}\NormalTok{ year }\OperatorTok{-}\StringTok{ }\DecValTok{1952}\NormalTok{)}

\NormalTok{fit_uk =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(country }\OperatorTok{==}\StringTok{ "United Kingdom"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year_from1952, }\DataTypeTok{data =}\NormalTok{ .)}

\NormalTok{fit_turkey =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{filter}\NormalTok{(country }\OperatorTok{==}\StringTok{ "Turkey"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year_from1952, }\DataTypeTok{data =}\NormalTok{ .)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_uk}\OperatorTok{$}\NormalTok{coefficients}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   (Intercept) year_from1952 
##    68.8085256     0.1859657
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_turkey}\OperatorTok{$}\NormalTok{coefficients}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   (Intercept) year_from1952 
##    46.0223205     0.4972399
\end{verbatim}

Now, the updated results tell us that in year 1952, the life expectancy
in the United Kingdom was 68 years. Note that the slope (0.18) does not
change. There was nothing wrong with the original model and the results
were correct, the intercept was just not very useful.

\hypertarget{accesing-all-model-information-tidy-and-glance}{%
\subsubsection{\texorpdfstring{Accesing all model information
\texttt{tidy()} and
\texttt{glance()}}{Accesing all model information tidy() and glance()}}\label{accesing-all-model-information-tidy-and-glance}}

In the fit\_uk and fit\_turkey examples above, we were using
\texttt{fit\_uk\ \%\textgreater{}\%\ summary()} to get R to print out a
summary of the model. This summary is not, however, in a rectangular
shape so we can't easily access the values or put them in a table/use as
information on plot labels.

We use the \texttt{tidy()} function from \texttt{library(broom)} to get
the explanatory variable specific values in a nice tibble:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_uk }\OperatorTok{%>%}\StringTok{ }\KeywordTok{tidy}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 5
##   term          estimate std.error statistic  p.value
##   <chr>            <dbl>     <dbl>     <dbl>    <dbl>
## 1 (Intercept)     68.8     0.240       287.  6.58e-21
## 2 year_from1952    0.186   0.00739      25.1 2.26e-10
\end{verbatim}

In the \texttt{tidy()} output, the column \texttt{estimate} includes
both the intercepts and slopes.

And we use the \texttt{glance()} function to get overall model
statistics (mostly the r.squared).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_uk }\OperatorTok{%>%}\StringTok{ }\KeywordTok{glance}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 11
##   r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC
##       <dbl>         <dbl> <dbl>     <dbl>    <dbl> <int>  <dbl> <dbl> <dbl>
## 1     0.984         0.983 0.442      633. 2.26e-10     2  -6.14  18.3  19.7
## # ... with 2 more variables: deviance <dbl>, df.residual <int>
\end{verbatim}

\hypertarget{multivariable-linear-regression}{%
\subsection{Multivariable linear
regression}\label{multivariable-linear-regression}}

Multivariable linear regression includes more than one explanatory
variable. There are a few ways to include more variables, depending on
whether they should share the intercept and how they interact:

Simple linear regression (exactly one predictor variable):

\texttt{myfit\ =\ lm(lifeExp\ \textasciitilde{}\ year,\ data\ =\ mydata)}

Multivariable linear regression (additive):

\texttt{myfit\ =\ lm(lifeExp\ \textasciitilde{}\ year\ +\ country,\ data\ =\ mydata)}

Multivariable linear regression (interaction):

\texttt{myfit\ =\ lm(lifeExp\ \textasciitilde{}\ year\ *\ country,\ data\ =\ mydata)}

This equivalent to:
\texttt{myfit\ =\ lm(lifeExp\ \textasciitilde{}\ year\ +\ country\ +\ year:country,\ data\ =\ mydata)}

These examples of multivariable regression include two variables:
\texttt{year} and \texttt{country}, but we could include more by adding
them with \texttt{+}.

In this particular setting, it will become obvious which model is
appropriate. So we have complete control over the model being fitted, we
will use the \texttt{predict()} function directly to obtain our fitted
line, rather than leaving it up to \texttt{ggplot}.

\hypertarget{model-1-year-only}{%
\subsubsection{Model 1: year only}\label{model-1-year-only}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata_UK_T =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(country }\OperatorTok{%in%}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Turkey"}\NormalTok{, }\StringTok{"United Kingdom"}\NormalTok{))}

\NormalTok{fit_both1 =}\StringTok{ }\NormalTok{mydata_UK_T }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year_from1952, }\DataTypeTok{data =}\NormalTok{ .)}
\NormalTok{fit_both1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = lifeExp ~ year_from1952, data = .)
## 
## Coefficients:
##   (Intercept)  year_from1952  
##       57.4154         0.3416
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pred_both1 =}\StringTok{ }\KeywordTok{predict}\NormalTok{(fit_both1)}

\NormalTok{mydata_UK_T }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{bind_cols}\NormalTok{(}\DataTypeTok{pred_both =}\NormalTok{ pred_both1) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp, }\DataTypeTok{colour =}\NormalTok{ country)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ pred_both))}
\end{Highlighting}
\end{Shaded}

\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-15-1.pdf}

By fitting year only, the model ignores country. This gives us a fitted
line which is the average of life expectancy in the UK and Turkey. This
may be desirable, depending on the question. But here we want to best
describe the data.

\hypertarget{model-2-year-country}{%
\subsubsection{Model 2: year + country}\label{model-2-year-country}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_both2 =}\StringTok{ }\NormalTok{mydata_UK_T }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year_from1952 }\OperatorTok{+}\StringTok{ }\NormalTok{country, }\DataTypeTok{data =}\NormalTok{ .)}
\NormalTok{fit_both2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = lifeExp ~ year_from1952 + country, data = .)
## 
## Coefficients:
##           (Intercept)          year_from1952  countryUnited Kingdom  
##               50.3023                 0.3416                14.2262
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pred_both2 =}\StringTok{ }\KeywordTok{predict}\NormalTok{(fit_both2)}

\NormalTok{mydata_UK_T }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{bind_cols}\NormalTok{(}\DataTypeTok{pred_both =}\NormalTok{ pred_both2) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp, }\DataTypeTok{colour =}\NormalTok{ country)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ pred_both, }\DataTypeTok{colour =}\NormalTok{ country))}
\end{Highlighting}
\end{Shaded}

\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-16-1.pdf}

This is better, by including country in the model, we now have fitted
lines better represent the data. However, the lines are constrained to
be parallel. This is discussed in detail above. We need to include an
interaction term to allow the effect of year on life expectancy to vary
by country in a non-additive manner.

\hypertarget{model-3-year-country}{%
\subsubsection{Model 3: year * country}\label{model-3-year-country}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit_both3 =}\StringTok{ }\NormalTok{mydata_UK_T }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{lm}\NormalTok{(lifeExp }\OperatorTok{~}\StringTok{ }\NormalTok{year_from1952 }\OperatorTok{*}\StringTok{ }\NormalTok{country, }\DataTypeTok{data =}\NormalTok{ .)}
\NormalTok{fit_both3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## lm(formula = lifeExp ~ year_from1952 * country, data = .)
## 
## Coefficients:
##                         (Intercept)                        year_from1952  
##                             46.0223                               0.4972  
##               countryUnited Kingdom  year_from1952:countryUnited Kingdom  
##                             22.7862                              -0.3113
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pred_both3 =}\StringTok{ }\KeywordTok{predict}\NormalTok{(fit_both3)}

\NormalTok{mydata_UK_T }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{bind_cols}\NormalTok{(}\DataTypeTok{pred_both =}\NormalTok{ pred_both3) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{() }\OperatorTok{+}\StringTok{ }
\StringTok{  }\KeywordTok{geom_point}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ lifeExp, }\DataTypeTok{colour =}\NormalTok{ country)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_line}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ year, }\DataTypeTok{y =}\NormalTok{ pred_both, }\DataTypeTok{colour =}\NormalTok{ country))}
\end{Highlighting}
\end{Shaded}

\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-17-1.pdf}

This fits the data much better than the previous two models. You can
check the R-squared using `summary(fit\_both1)

\emph{Pro tip}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(purrr)}
\KeywordTok{list}\NormalTok{(fit_both1, fit_both2, fit_both3) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{map_df}\NormalTok{(glance, }\DataTypeTok{.id =} \StringTok{"fit"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 3 x 12
##   fit   r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC
##   <chr>     <dbl>         <dbl> <dbl>     <dbl>    <dbl> <int>  <dbl> <dbl>
## 1 1         0.373         0.344 7.98       13.1 1.53e- 3     2  -82.9 172. 
## 2 2         0.916         0.908 2.99      114.  5.18e-12     3  -58.8 126. 
## 3 3         0.993         0.992 0.869     980.  7.30e-22     4  -28.5  67.0
## # ... with 3 more variables: BIC <dbl>, deviance <dbl>, df.residual <int>
\end{verbatim}

\hypertarget{check-assumptions}{%
\subsection{Check assumptions}\label{check-assumptions}}

The assumptions of linear regression can be checked with diagnostic
plots, either by passing the fitted object (\texttt{lm()} output) to
base R \texttt{plot()}, or by using the more convenient function below.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(ggfortify)}
\KeywordTok{autoplot}\NormalTok{(fit_both3)}
\end{Highlighting}
\end{Shaded}

\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-19-1.pdf}

There is no clear problem with the residuals, as we would expect from
the scatterplot with fitted lines.

\hypertarget{fitting-more-complex-models}{%
\section{Fitting more complex
models}\label{fitting-more-complex-models}}

\hypertarget{the-question-3}{%
\subsection{The Question (3)}\label{the-question-3}}

Finally in this chapter, we are going to fit a more complex linear
regression model. Here, we will discuss variable selection and introduce
the Akaike Information Criterion (AIC).

We will introduce a new dataset: The Western Collaborative Grou Study.
This classic includes data from 3154 healthy young men aged 39-59 from
the San Francisco area who were assessed for their personality type. It
aimed to capture the occrunce of coronary heart disease over the
following 8.5 years.

We will use it however to explore the relationship between systolic
blood pressure (\texttt{sbp}), weight (\texttt{weight}) and personality
type (\texttt{personality\_2L}).

Personality type is A: aggressive and B: passive.

\hypertarget{aic}{%
\subsection{AIC}\label{aic}}

The Akaike Information Criterion (AIC) is an alternative goodness-of-fit
measure. In that sense, it is similar to the R-squared, but has a
different statistical basis. It is useful because it can be used to help
guide the best fit in generalised linear models such as logistic
regression (ref: chapter 9). It is based on the likelihood but is also
penalised for the number of variables present in the model. We aim to
have as small an AIC as possible.

\hypertarget{model-fitting-principles}{%
\subsection{Model fitting principles}\label{model-fitting-principles}}

Our 4/5 principles here.

\hypertarget{get-the-data-2}{%
\subsection{Get the data}\label{get-the-data-2}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata =}\StringTok{ }\NormalTok{finalfit}\OperatorTok{::}\NormalTok{wcgs }\CommentTok{#F1 here for details}
\end{Highlighting}
\end{Shaded}

\hypertarget{check-the-data-2}{%
\subsection{Check the data}\label{check-the-data-2}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(finalfit)}
\KeywordTok{glimpse}\NormalTok{(mydata) }\CommentTok{# each variable as line, variable type, first values}
\KeywordTok{missing_glimpse}\NormalTok{(mydata) }\CommentTok{# missing data for each variable}
\KeywordTok{ff_glimpse}\NormalTok{(mydata) }\CommentTok{# summary statistics for each variable}
\end{Highlighting}
\end{Shaded}

\hypertarget{plot-the-data-3}{%
\subsection{Plot the data}\label{plot-the-data-3}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{y =}\NormalTok{ sbp, }\DataTypeTok{x =}\NormalTok{ weight, }
             \DataTypeTok{colour =}\NormalTok{ personality_2L)) }\OperatorTok{+}\StringTok{   }\CommentTok{# Personality type}
\StringTok{  }\KeywordTok{geom_point}\NormalTok{() }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_smooth}\NormalTok{(}\DataTypeTok{method =} \StringTok{"lm"}\NormalTok{, }\DataTypeTok{se =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{07_linear_regression_files/figure-latex/unnamed-chunk-23-1.pdf}

From this plot we can see that there is a weak relationship between
weight and blood pressure. In addition, there is really no meaningful
effect of personality type on blood pressure. This is important, because
as you will see below, we are about to find statistically significant
effects in a model.

\hypertarget{linear-regression-with-finalfit}{%
\subsection{Linear regression with
Finalfit}\label{linear-regression-with-finalfit}}

Finalfit is our own package and provides a convenient set of functions
for fitting regression models with results presented in final tables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent =}\StringTok{ "sbp"}
\NormalTok{explanatory =}\StringTok{ "weight"}
\NormalTok{fit_sbp1 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory, }\DataTypeTok{metrics =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Dependent is not a factor and will be treated as a continuous variable
\end{verbatim}

\begin{tabular}{llrrr}
\toprule
Dependent: Systolic BP (mmHg) &  & Mean (sd) & Coefficient (univariable) & Coefficient (multivariable)\\
\midrule
Weight (pounds) & [78,320] & 128.6 (15.1) & 0.18 (0.16 to 0.21, p<0.001) & 0.18 (0.16 to 0.21, p<0.001)\\
\bottomrule
\end{tabular}

\begin{tabular}{l}
\toprule
\\
\midrule
Number in dataframe = 3154, Number in model = 3154, Missing = 0, Log-likelihood = -12936.15, AIC = 25878.3, R-squared = 0.064, Adjusted r-squared = 0.064\\
\bottomrule
\end{tabular}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent =}\StringTok{ "sbp"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"weight"}\NormalTok{, }\StringTok{"personality_2L"}\NormalTok{)}
\NormalTok{fit_sbp2 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory, }\DataTypeTok{metrics =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Dependent is not a factor and will be treated as a continuous variable
\end{verbatim}

\begin{tabular}{llrrr}
\toprule
Dependent: Systolic BP (mmHg) &  & Mean (sd) & Coefficient (univariable) & Coefficient (multivariable)\\
\midrule
Weight (pounds) & [78,320] & 128.6 (15.1) & 0.18 (0.16 to 0.21, p<0.001) & 0.18 (0.16 to 0.20, p<0.001)\\
Personality type & B & 127.5 (14.4) & - & -\\
 & A & 129.8 (15.7) & 2.32 (1.26 to 3.37, p<0.001) & 1.99 (0.97 to 3.01, p<0.001)\\
\bottomrule
\end{tabular}

\begin{tabular}{l}
\toprule
\\
\midrule
Number in dataframe = 3154, Number in model = 3154, Missing = 0, Log-likelihood = -12928.82, AIC = 25865.6, R-squared = 0.068, Adjusted r-squared = 0.068\\
\bottomrule
\end{tabular}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent =}\StringTok{ "sbp"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"weight"}\NormalTok{, }\StringTok{"personality_2L"}\NormalTok{, }\StringTok{"age"}\NormalTok{, }\StringTok{"height"}\NormalTok{, }\StringTok{"chol"}\NormalTok{, }\StringTok{"smoking"}\NormalTok{) }
\NormalTok{fit_sbp3 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory, }\DataTypeTok{metrics =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Dependent is not a factor and will be treated as a continuous variable
\end{verbatim}

\begin{tabular}{llrrr}
\toprule
Dependent: Systolic BP (mmHg) &  & Mean (sd) & Coefficient (univariable) & Coefficient (multivariable)\\
\midrule
Weight (pounds) & [78,320] & 128.6 (15.1) & 0.18 (0.16 to 0.21, p<0.001) & 0.24 (0.21 to 0.27, p<0.001)\\
Personality type & B & 127.5 (14.4) & - & -\\
 & A & 129.8 (15.7) & 2.32 (1.26 to 3.37, p<0.001) & 1.44 (0.44 to 2.43, p=0.005)\\
Age (years) & [39,59] & 128.6 (15.1) & 0.45 (0.36 to 0.55, p<0.001) & 0.43 (0.33 to 0.52, p<0.001)\\
Height (inches) & [60,78] & 128.6 (15.1) & 0.11 (-0.10 to 0.32, p=0.302) & -0.84 (-1.08 to -0.61, p<0.001)\\
\addlinespace
Cholesterol (mg/100 ml) & [103,645] & 128.6 (15.1) & 0.04 (0.03 to 0.05, p<0.001) & 0.03 (0.02 to 0.04, p<0.001)\\
Smoking & Non-smoker & 128.6 (15.6) & - & -\\
 & Smoker & 128.7 (14.6) & 0.08 (-0.98 to 1.14, p=0.883) & 0.95 (-0.05 to 1.96, p=0.063)\\
\bottomrule
\end{tabular}

\begin{tabular}{l}
\toprule
\\
\midrule
Number in dataframe = 3154, Number in model = 3142, Missing = 12, Log-likelihood = -12772.04, AIC = 25560.1, R-squared = 0.12, Adjusted r-squared = 0.12\\
\bottomrule
\end{tabular}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent =}\StringTok{ "sbp"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"weight"}\NormalTok{, }\StringTok{"personality_2L"}\NormalTok{, }\StringTok{"age"}\NormalTok{, }\StringTok{"height"}\NormalTok{, }\StringTok{"chol"}\NormalTok{, }\StringTok{"smoking"}\NormalTok{) }
\NormalTok{explanatory_multi =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"weight"}\NormalTok{, }\StringTok{"personality_2L"}\NormalTok{, }\StringTok{"age"}\NormalTok{, }\StringTok{"height"}\NormalTok{, }\StringTok{"chol"}\NormalTok{) }
\NormalTok{fit_sbp4 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory, }
\NormalTok{           explanatory_multi, }
           \DataTypeTok{keep_models =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{metrics =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Dependent is not a factor and will be treated as a continuous variable
\end{verbatim}

\begin{tabular}{llrrrr}
\toprule
Dependent: Systolic BP (mmHg) &  & Mean (sd) & Coefficient (univariable) & Coefficient (multivariable) & Coefficient (multivariable reduced)\\
\midrule
Weight (pounds) & [78,320] & 128.6 (15.1) & 0.18 (0.16 to 0.21, p<0.001) & 0.24 (0.21 to 0.27, p<0.001) & 0.23 (0.21 to 0.26, p<0.001)\\
Personality type & B & 127.5 (14.4) & - & - & -\\
 & A & 129.8 (15.7) & 2.32 (1.26 to 3.37, p<0.001) & 1.44 (0.44 to 2.43, p=0.005) & 1.49 (0.50 to 2.49, p=0.003)\\
Age (years) & [39,59] & 128.6 (15.1) & 0.45 (0.36 to 0.55, p<0.001) & 0.43 (0.33 to 0.52, p<0.001) & 0.42 (0.33 to 0.51, p<0.001)\\
Height (inches) & [60,78] & 128.6 (15.1) & 0.11 (-0.10 to 0.32, p=0.302) & -0.84 (-1.08 to -0.61, p<0.001) & -0.83 (-1.06 to -0.59, p<0.001)\\
\addlinespace
Cholesterol (mg/100 ml) & [103,645] & 128.6 (15.1) & 0.04 (0.03 to 0.05, p<0.001) & 0.03 (0.02 to 0.04, p<0.001) & 0.03 (0.02 to 0.04, p<0.001)\\
Smoking & Non-smoker & 128.6 (15.6) & - & - & -\\
 & Smoker & 128.7 (14.6) & 0.08 (-0.98 to 1.14, p=0.883) & 0.95 (-0.05 to 1.96, p=0.063) & -\\
\bottomrule
\end{tabular}

\begin{tabular}{l}
\toprule
\\
\midrule
Number in dataframe = 3154, Number in model = 3142, Missing = 12, Log-likelihood = -12772.04, AIC = 25560.1, R-squared = 0.12, Adjusted r-squared = 0.12\\
Number in dataframe = 3154, Number in model = 3142, Missing = 12, Log-likelihood = -12773.77, AIC = 25561.5, R-squared = 0.12, Adjusted r-squared = 0.12\\
\bottomrule
\end{tabular}

More to add for each step above.

An important message here relates to the highly significant p-values in
the table above. Should we conclude that in a "multivariable regression
model controlling for weight, height, age, serum cholesterol levels and
smoking status, blood pressure was significantly elevated in those with
a Type A personality (1.44 (95\% CI 0.44 to 2.43, p=0.005) compared with
Type B. The p-value looks impressive, but the actual difference in blood
pressure is only 1.4 mmHg. Even at a population level, that seems
unlikely to be clinically significant. Which fits with our first
thoughts when we saw the scatter plot.

\hypertarget{tests-for-categorical-variables}{%
\chapter{Tests for categorical
variables}\label{tests-for-categorical-variables}}

\hypertarget{data-3}{%
\section{Data}\label{data-3}}

We are now changing to a new dataset, \texttt{melanoma}. Click on
\texttt{mydata} in your environment and have a look at the values -
you'll see that categorical variables are coded as numbers, rather than
text. You will need to recode these numbers into proper factors.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(finalfit)}
\KeywordTok{library}\NormalTok{(broom)}
\KeywordTok{library}\NormalTok{(knitr)}
\KeywordTok{library}\NormalTok{(kableExtra)}
\NormalTok{mydata =}\StringTok{ }\NormalTok{boot}\OperatorTok{::}\NormalTok{melanoma}
\KeywordTok{head}\NormalTok{(mydata) }\OperatorTok{%>%}\StringTok{ }
\StringTok{ }\KeywordTok{kable}\NormalTok{(}\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{ }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{font_size =} \DecValTok{7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{table}[H]
\centering\begingroup\fontsize{7}{9}\selectfont

\begin{tabular}{rrrrrrr}
\toprule
time & status & sex & age & year & thickness & ulcer\\
\midrule
10 & 3 & 1 & 76 & 1972 & 6.76 & 1\\
30 & 3 & 1 & 56 & 1968 & 0.65 & 0\\
35 & 2 & 1 & 41 & 1977 & 1.34 & 0\\
99 & 3 & 0 & 71 & 1968 & 2.90 & 0\\
185 & 1 & 1 & 52 & 1965 & 12.08 & 1\\
\addlinespace
204 & 1 & 1 & 28 & 1971 & 4.84 & 1\\
\bottomrule
\end{tabular}
\endgroup{}
\end{table}

\hypertarget{recap-on-factors}{%
\subsection{Recap on factors}\label{recap-on-factors}}

Press \texttt{F1} on \texttt{boot::melanoma} to see its description. Use
the information from help to change the numbers into proper factors
(e.g.~0 - female, 1 - male).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{status }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Died"}\NormalTok{  =}\StringTok{ "1"}\NormalTok{,}
             \StringTok{"Alive"}\NormalTok{ =}\StringTok{ "2"}\NormalTok{,}
             \StringTok{"Died - other causes"}\NormalTok{ =}\StringTok{ "3"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fct_relevel}\NormalTok{(}\StringTok{"Alive"}\NormalTok{) ->}\StringTok{ }\CommentTok{# move Alive to front (first factor level) }
\StringTok{  }\NormalTok{mydata}\OperatorTok{$}\NormalTok{status.factor    }\CommentTok{# so odds ratio will be relative to that}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{sex }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Female"}\NormalTok{ =}\StringTok{ "0"}\NormalTok{,}
             \StringTok{"Male"}\NormalTok{ =}\StringTok{ "1"}\NormalTok{) ->}
\StringTok{  }\NormalTok{mydata}\OperatorTok{$}\NormalTok{sex.factor}
  
\NormalTok{mydata}\OperatorTok{$}\NormalTok{ulcer }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Present"}\NormalTok{ =}\StringTok{ "1"}\NormalTok{,}
             \StringTok{"Absent"}\NormalTok{  =}\StringTok{ "0"}\NormalTok{) ->}\StringTok{ }
\StringTok{  }\NormalTok{mydata}\OperatorTok{$}\NormalTok{ulcer.factor}

\CommentTok{#the cut() function makes a continuous variable into a categorical variable}
\NormalTok{mydata}\OperatorTok{$}\NormalTok{age }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{cut}\NormalTok{(}\DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{20}\NormalTok{,}\DecValTok{40}\NormalTok{,}\DecValTok{60}\NormalTok{,}\DecValTok{95}\NormalTok{), }\DataTypeTok{include.lowest=}\OtherTok{TRUE}\NormalTok{) ->}
\StringTok{  }\NormalTok{mydata}\OperatorTok{$}\NormalTok{age.factor}
\end{Highlighting}
\end{Shaded}

\hypertarget{chi-squared-test-fishers-exact-test}{%
\section{Chi-squared test / Fisher's exact
test}\label{chi-squared-test-fishers-exact-test}}

\hypertarget{plotting}{%
\subsection{Plotting}\label{plotting}}

Always plot new data first!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ ulcer.factor, }\DataTypeTok{fill=}\NormalTok{status.factor)) }\OperatorTok{+}\StringTok{ }
\StringTok{      }\KeywordTok{geom_bar}\NormalTok{(}\DataTypeTok{position =} \StringTok{"fill"}\NormalTok{) }\OperatorTok{+}
\StringTok{      }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{      }\KeywordTok{scale_fill_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Paired"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{08_tests_categorical_files/figure-latex/unnamed-chunk-3-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ age.factor, }\DataTypeTok{fill =}\NormalTok{ status.factor)) }\OperatorTok{+}
\StringTok{    }\KeywordTok{geom_bar}\NormalTok{() }\OperatorTok{+}
\StringTok{    }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{    }\KeywordTok{scale_fill_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Paired"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{08_tests_categorical_files/figure-latex/unnamed-chunk-4-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ ulcer.factor, }\DataTypeTok{fill=}\NormalTok{status.factor)) }\OperatorTok{+}\StringTok{ }
\StringTok{    }\KeywordTok{geom_bar}\NormalTok{() }\OperatorTok{+}
\StringTok{    }\KeywordTok{theme_bw}\NormalTok{() }\OperatorTok{+}
\StringTok{    }\KeywordTok{scale_fill_brewer}\NormalTok{(}\DataTypeTok{palette =} \StringTok{"Paired"}\NormalTok{) }\OperatorTok{+}
\StringTok{    }\KeywordTok{facet_grid}\NormalTok{(sex.factor}\OperatorTok{~}\NormalTok{age.factor)}
\end{Highlighting}
\end{Shaded}

\includegraphics{08_tests_categorical_files/figure-latex/unnamed-chunk-5-1.pdf}

\hypertarget{analysis}{%
\section{Analysis}\label{analysis}}

\hypertarget{using-base-r}{%
\subsection{Using base R}\label{using-base-r}}

First lets group together those that `died of another cause' with those
`alive', to give a disease-specific mortality variable
(\texttt{fct\_collapse()} will help us).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{status.factor }\OperatorTok{%>%}\StringTok{  }
\StringTok{    }\KeywordTok{fct_collapse}\NormalTok{(}\StringTok{"Alive"}\NormalTok{ =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Alive"}\NormalTok{, }\StringTok{"Died - other causes"}\NormalTok{)) ->}
\StringTok{  }\NormalTok{mydata}\OperatorTok{$}\NormalTok{status.factor}
\end{Highlighting}
\end{Shaded}

Let's test mortality against sex.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{table}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{sex.factor)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        
##         Female Male
##   Alive     98   50
##   Died      28   29
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{chisq.test}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{sex.factor)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Pearson's Chi-squared test with Yates' continuity correction
## 
## data:  mydata$status.factor and mydata$sex.factor
## X-squared = 4.3803, df = 1, p-value = 0.03636
\end{verbatim}

Note that \texttt{chisq.test()} defaults to the Yates' continuity
correction.

It is fine to use this, but if you have a particular need not to, turn
if off with
\texttt{chisq.test(mydata\$status.factor,\ mydata\$sex.factor,\ correct=FALSE)}.

\hypertarget{using-crosstable}{%
\subsection{\texorpdfstring{Using
\texttt{CrossTable}}{Using CrossTable}}\label{using-crosstable}}

This gives lots of useful information. It is readable in R and has lots
of options, including Fisher's exact test. It is not that easy to
extract results. \newpage

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(gmodels)}
\CommentTok{# F1 CrossTable to see options}
\KeywordTok{CrossTable}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{sex.factor, }\DataTypeTok{chisq=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  
##    Cell Contents
## |-------------------------|
## |                       N |
## | Chi-square contribution |
## |           N / Row Total |
## |           N / Col Total |
## |         N / Table Total |
## |-------------------------|
## 
##  
## Total Observations in Table:  205 
## 
##  
##                      | mydata$sex.factor 
## mydata$status.factor |    Female |      Male | Row Total | 
## ---------------------|-----------|-----------|-----------|
##                Alive |        98 |        50 |       148 | 
##                      |     0.544 |     0.868 |           | 
##                      |     0.662 |     0.338 |     0.722 | 
##                      |     0.778 |     0.633 |           | 
##                      |     0.478 |     0.244 |           | 
## ---------------------|-----------|-----------|-----------|
##                 Died |        28 |        29 |        57 | 
##                      |     1.412 |     2.253 |           | 
##                      |     0.491 |     0.509 |     0.278 | 
##                      |     0.222 |     0.367 |           | 
##                      |     0.137 |     0.141 |           | 
## ---------------------|-----------|-----------|-----------|
##         Column Total |       126 |        79 |       205 | 
##                      |     0.615 |     0.385 |           | 
## ---------------------|-----------|-----------|-----------|
## 
##  
## Statistics for All Table Factors
## 
## 
## Pearson's Chi-squared test 
## ------------------------------------------------------------
## Chi^2 =  5.076334     d.f. =  1     p =  0.0242546 
## 
## Pearson's Chi-squared test with Yates' continuity correction 
## ------------------------------------------------------------
## Chi^2 =  4.380312     d.f. =  1     p =  0.03635633 
## 
## 
\end{verbatim}

\hypertarget{exercise-25}{%
\subsection{Exercise}\label{exercise-25}}

Use the 3 methods (\texttt{table}, \texttt{chisq.test},
\texttt{CrossTable}) to test \texttt{status.factor} against
\texttt{ulcer.factor}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{table}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{ulcer.factor)}
\KeywordTok{chisq.test}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{ulcer.factor)}
\end{Highlighting}
\end{Shaded}

Using \texttt{CrossTable}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{CrossTable}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{ulcer.factor, }\DataTypeTok{chisq=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{fishers-exact-test}{%
\subsection{Fisher's exact test}\label{fishers-exact-test}}

An assumption of the chi-squared test is that the `expected cell count'
is greater than 5. If it is less than 5 the test becomes unreliable and
the Fisher's exact test is recommended.

Run the following code.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(gmodels)}
\KeywordTok{CrossTable}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{age.factor, }\DataTypeTok{expected=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{chisq=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in chisq.test(t, correct = FALSE, ...): Chi-squared approximation
## may be incorrect
\end{verbatim}

\begin{verbatim}
## 
##  
##    Cell Contents
## |-------------------------|
## |                       N |
## |              Expected N |
## | Chi-square contribution |
## |           N / Row Total |
## |           N / Col Total |
## |         N / Table Total |
## |-------------------------|
## 
##  
## Total Observations in Table:  205 
## 
##  
##                      | mydata$age.factor 
## mydata$status.factor |    [4,20] |   (20,40] |   (40,60] |   (60,95] | Row Total | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
##                Alive |         6 |        30 |        66 |        46 |       148 | 
##                      |     6.498 |    26.712 |    66.420 |    48.371 |           | 
##                      |     0.038 |     0.405 |     0.003 |     0.116 |           | 
##                      |     0.041 |     0.203 |     0.446 |     0.311 |     0.722 | 
##                      |     0.667 |     0.811 |     0.717 |     0.687 |           | 
##                      |     0.029 |     0.146 |     0.322 |     0.224 |           | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
##                 Died |         3 |         7 |        26 |        21 |        57 | 
##                      |     2.502 |    10.288 |    25.580 |    18.629 |           | 
##                      |     0.099 |     1.051 |     0.007 |     0.302 |           | 
##                      |     0.053 |     0.123 |     0.456 |     0.368 |     0.278 | 
##                      |     0.333 |     0.189 |     0.283 |     0.313 |           | 
##                      |     0.015 |     0.034 |     0.127 |     0.102 |           | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
##         Column Total |         9 |        37 |        92 |        67 |       205 | 
##                      |     0.044 |     0.180 |     0.449 |     0.327 |           | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
## 
##  
## Statistics for All Table Factors
## 
## 
## Pearson's Chi-squared test 
## ------------------------------------------------------------
## Chi^2 =  2.019848     d.f. =  3     p =  0.5682975 
## 
## 
## 
\end{verbatim}

Why does it give a warning? Run it a second time including
\texttt{fisher=TRUE}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(gmodels)}
\KeywordTok{CrossTable}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{status.factor, mydata}\OperatorTok{$}\NormalTok{age.factor, }\DataTypeTok{expected=}\OtherTok{TRUE}\NormalTok{, }\DataTypeTok{chisq=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in chisq.test(t, correct = FALSE, ...): Chi-squared approximation
## may be incorrect
\end{verbatim}

\begin{verbatim}
## 
##  
##    Cell Contents
## |-------------------------|
## |                       N |
## |              Expected N |
## | Chi-square contribution |
## |           N / Row Total |
## |           N / Col Total |
## |         N / Table Total |
## |-------------------------|
## 
##  
## Total Observations in Table:  205 
## 
##  
##                      | mydata$age.factor 
## mydata$status.factor |    [4,20] |   (20,40] |   (40,60] |   (60,95] | Row Total | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
##                Alive |         6 |        30 |        66 |        46 |       148 | 
##                      |     6.498 |    26.712 |    66.420 |    48.371 |           | 
##                      |     0.038 |     0.405 |     0.003 |     0.116 |           | 
##                      |     0.041 |     0.203 |     0.446 |     0.311 |     0.722 | 
##                      |     0.667 |     0.811 |     0.717 |     0.687 |           | 
##                      |     0.029 |     0.146 |     0.322 |     0.224 |           | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
##                 Died |         3 |         7 |        26 |        21 |        57 | 
##                      |     2.502 |    10.288 |    25.580 |    18.629 |           | 
##                      |     0.099 |     1.051 |     0.007 |     0.302 |           | 
##                      |     0.053 |     0.123 |     0.456 |     0.368 |     0.278 | 
##                      |     0.333 |     0.189 |     0.283 |     0.313 |           | 
##                      |     0.015 |     0.034 |     0.127 |     0.102 |           | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
##         Column Total |         9 |        37 |        92 |        67 |       205 | 
##                      |     0.044 |     0.180 |     0.449 |     0.327 |           | 
## ---------------------|-----------|-----------|-----------|-----------|-----------|
## 
##  
## Statistics for All Table Factors
## 
## 
## Pearson's Chi-squared test 
## ------------------------------------------------------------
## Chi^2 =  2.019848     d.f. =  3     p =  0.5682975 
## 
## 
## 
\end{verbatim}

\hypertarget{summarising-multiple-factors-optional}{%
\section{Summarising multiple factors
(optional)}\label{summarising-multiple-factors-optional}}

\texttt{CrossTable} is useful for summarising single variables. We often
want to summarise more than one factor or continuous variable against
our \texttt{dependent} variable of interest. Think of Table 1 in a
journal article.

\hypertarget{summarising-factors-with-libraryfinalfit}{%
\section{\texorpdfstring{Summarising factors with
\texttt{library(finalfit)}}{Summarising factors with library(finalfit)}}\label{summarising-factors-with-libraryfinalfit}}

This is our own package which we have written and maintain. It contains
functions to summarise data for publication tables and figures, and to
easily run regression analyses. We specify a \texttt{dependent} or
outcome variable, and a set of \texttt{explanatory} or predictor
varaibles.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(finalfit)}
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summary_factorlist}\NormalTok{(}\DataTypeTok{dependent =} \StringTok{"status.factor"}\NormalTok{, }
                     \DataTypeTok{explanatory =} \KeywordTok{c}\NormalTok{(}\StringTok{"sex.factor"}\NormalTok{, }\StringTok{"ulcer.factor"}\NormalTok{, }\StringTok{"age.factor"}\NormalTok{),}
                     \DataTypeTok{p =} \OtherTok{TRUE}\NormalTok{,}
                     \DataTypeTok{column =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning in chisq.test(tab, correct = FALSE): Chi-squared approximation may
## be incorrect
\end{verbatim}

\begin{verbatim}
##          label  levels     Alive      Died      p
## 5   sex.factor  Female 98 (66.2) 28 (49.1)  0.024
## 6                 Male 50 (33.8) 29 (50.9)       
## 7 ulcer.factor  Absent 99 (66.9) 16 (28.1) <0.001
## 8              Present 49 (33.1) 41 (71.9)       
## 1   age.factor  [4,20]   6 (4.1)   3 (5.3)  0.568
## 2              (20,40] 30 (20.3)  7 (12.3)       
## 3              (40,60] 66 (44.6) 26 (45.6)       
## 4              (60,95] 46 (31.1) 21 (36.8)
\end{verbatim}

\hypertarget{summarising-factors-with-librarytidyverse}{%
\subsection{\texorpdfstring{Summarising factors with
\texttt{library(tidyverse)}}{Summarising factors with library(tidyverse)}}\label{summarising-factors-with-librarytidyverse}}

\hypertarget{example}{%
\subsection{Example}\label{example}}

\texttt{Tidyverse} gives the flexibility and power to examine millions
of rows of your data any way you wish. The following are intended as an
extension to what you have already done. These demonstrate some more
advanced approaches to combining \texttt{tidy} functions.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Calculate number of patients in each group}
\NormalTok{counted_data =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(ulcer.factor, status.factor)}

\CommentTok{# Add the total number of people in each status group}
\NormalTok{counted_data2  =}\StringTok{ }\NormalTok{counted_data }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(status.factor) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{total =} \KeywordTok{sum}\NormalTok{(n))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Calculate the percentage of n to total}
\NormalTok{counted_data3 =}\StringTok{ }\NormalTok{counted_data2 }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \KeywordTok{round}\NormalTok{(}\DecValTok{100}\OperatorTok{*}\NormalTok{n}\OperatorTok{/}\NormalTok{total, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Create a combined columns of both \texttt{n} and \texttt{percentage}
using \texttt{paste()} to add brackets around the percentage.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{counted_data4  =}\StringTok{ }\NormalTok{counted_data3 }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{count_perc =} \KeywordTok{paste0}\NormalTok{(n, }\StringTok{" ("}\NormalTok{, percentage, }\StringTok{")"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

Or combine everything together without the intermediate
\texttt{counted\_data} breaks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{count}\NormalTok{(ulcer.factor, status.factor) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{group_by}\NormalTok{(status.factor) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{total =} \KeywordTok{sum}\NormalTok{(n)) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{percentage =} \KeywordTok{round}\NormalTok{(}\DecValTok{100}\OperatorTok{*}\NormalTok{n}\OperatorTok{/}\NormalTok{total, }\DecValTok{1}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{count_perc =} \KeywordTok{paste0}\NormalTok{(n, }\StringTok{" ("}\NormalTok{, percentage, }\StringTok{")"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(}\OperatorTok{-}\NormalTok{total, }\OperatorTok{-}\NormalTok{n, }\OperatorTok{-}\NormalTok{percentage) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{spread}\NormalTok{(status.factor, count_perc)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 3
##   ulcer.factor Alive     Died     
##   <fct>        <chr>     <chr>    
## 1 Absent       99 (66.9) 16 (28.1)
## 2 Present      49 (33.1) 41 (71.9)
\end{verbatim}

\hypertarget{exercise-26}{%
\subsection{Exercise}\label{exercise-26}}

By changing one and only one word at a time in the above block (the
``Combine everything together'' section)

Reproduce this:

\begin{verbatim}
##   age.factor     Alive      Died
## 1     [4,20]   6 (4.1)   3 (5.3)
## 2    (20,40] 30 (20.3)  7 (12.3)
## 3    (40,60] 66 (44.6) 26 (45.6)
## 4    (60,95] 46 (31.1) 21 (36.8)
\end{verbatim}

And then this:

\begin{verbatim}
##   sex.factor     Alive      Died
## 1     Female 98 (66.2) 28 (49.1)
## 2       Male 50 (33.8) 29 (50.9)
\end{verbatim}

Solution: The only thing you need to change is the first variable in
\texttt{count()}, e.g., \texttt{count(age.factor,\ ...}.

\hypertarget{logistic-regression}{%
\chapter{Logistic regression}\label{logistic-regression}}

\hypertarget{what-is-logistic-regression}{%
\section{What is Logistic
Regression?}\label{what-is-logistic-regression}}

As we have seen in previously, regression analysis is a statistical
process for estimating the relationships between variables. For
instance, we may try to predict the blood pressure of a group of
patients based on their age. As age and blood pressure are on a
continuous scale, this is an example of linear regression.

\includegraphics{images/age_bp.png}

Logistic regression is an extension of this, where the variable being
predicted is \emph{categorical}. We will deal with binary logistic
regression, where the variable being predicted has two levels, e.g.~yes
or no, 0 or 1. In healthcare, this is usually done for an event (like
death) occurring or not occurring. Logistic regression can tell us the
probability of the outcome occuring.

\includegraphics{images/exam_pass.jpeg}

Logistic regression lets you adjust for the effects of confounding
factors on an outcome. When you read a paper that says it has adjusted
for confounding factors, this is the usual method which is used.

Adjusting for confounding factors allows us to isolate the true effect
of a variable upon an outcome. For example, if we wanted to know the
effects of smoking on deaths from heart attacks, we would need to also
control for things like sex and diabetes, as we know they contribute
towards heart attacks too.

Although in binary logistic regression the outcome must have two levels,
the predictor variables (also known as the explanatory variables) can be
either continuous or categorical.

Logistic regression can be performed to examine the influence of one
predictor variable, which is known as a univariable analysis. Or
multiple predictor variables, known as a multivariable analysis.

\hypertarget{definitions}{%
\section{Definitions}\label{definitions}}

\textbf{Dependent} variable (in clinical research usually synonymous to
\textbf{outcome}) - is what we are trying to explain, i.e.~we are trying
to identify the factors associated with a particular outcome. In
binomial logistic regression, the dependent variable has exactly two
levels (e.g. ``Died'' or ``Alive'', ``Yes - Complications'' or ``No
Complications'', ``Cured'' or ``Not Cured'', etc.).

\textbf{Explanatory} variables (also known as \textbf{predictors},
\textbf{confounding} variables, or \textbf{``adjusted for''}) -
patient-level information, usually including demographics (age, gender)
as well as clinical information (disease stage, tumour type).
Explanatory variables can be categorical as well as continuous, and
categorical variables can have more than two levels.

\textbf{Univariable} - analysis with only one Explanatory variable.

\textbf{Multivariable} - analysis with more than one Explanatory
variable. Synonymous to ``adjusted''.

(\textbf{Multivariate} - technically means more than one
\textbf{Dependent variable} (we will not discuss this type of analysis),
but very often used interchangeably with \textbf{Multivariable}.)

\hypertarget{odds-and-probabilities}{%
\section{Odds and probabilities}\label{odds-and-probabilities}}

Odds and probabilities can get confusing so let's get them straight:

\includegraphics{images/p_vs_odds2.png}

Odds and probabilities can be interconverted. For example, if the odds
of a patient dying from a disease are \texttt{9\ to\ 1} then the
probability of death (also known as risk) is 10\%. Odds of
\texttt{1\ to\ 1} equal 50\%.

\(Odds = \frac{p}{1-p}\), where \(p\) is the probability of the outcome
occuring (or the circle being red).

Look at the numbers and convince yourself that this works.

\hypertarget{odds-ratios}{%
\subsection{Odds ratios}\label{odds-ratios}}

For a given categorical explanatory variable (e.g.~gender), the
likelihood of an outcome/dependent occuring (e.g cancer) can be
expressed in a ratio of odds or odds ratio, e.g.~the odds of men
developing cancer is 2-times that of females, odds ratio = 2.0.

\includegraphics{images/or.png}

An alternative is a ratio of probabilites, called a risk ratio or
relative risk. Odds ratios have useful mathematical characteristics and
are the main expression of results in logistic regression analysis.

\newpage

\hypertarget{melanoma-dataset}{%
\section{Melanoma dataset}\label{melanoma-dataset}}

Malignant melanoma is a cancer of the skin. It is agressive and highly
invasive, making it difficult to treat.

It's classically divided into 4 stages of severity, based upon the depth
of the tumour:

\begin{itemize}
\tightlist
\item
  Stage I: \textless{}0.5 mm depth
\item
  Stage II: 0.5 to 1.0 mm depth
\item
  Stage III: 1.0 to 4.0 mm depth
\item
  Stage IV: \textgreater{} 4.0 mm depth
\end{itemize}

This will be important in our analysis as we will creating a new
variable based upon this.

Using logistic regression, we will investigate factors associated with
death from malignant melanoma.

\hypertarget{doing-logistic-regression-in-r}{%
\subsection{Doing logistic regression in
R}\label{doing-logistic-regression-in-r}}

There are a few different ways of doing logistic regression in R. The
\texttt{glm()} function is probably the most common and most flexible
one to use. (\texttt{glm} stands for
\texttt{generalised\ linear\ model}.)

Within the \texttt{glm()} function there are several \texttt{options} in
the function we must define to make R run a logistic regression.

\texttt{data} - you must define the dataframe to be used in the
regression.

\texttt{family} - this tells R to treat the analysis as a logisitic
regression. For our purposes, \texttt{family} will always be
\texttt{"binomial"} (as binary data follow this distribution).

\texttt{x\ \textasciitilde{}\ a\ +\ b\ +\ c} - this is the formula for
the logistic regression, with \texttt{x} being the outcome and
\texttt{a}, \texttt{b} and \texttt{c} being predictor variables.

Note the outcome is separated from the rest of the formula and sits on
the left hand side of a \texttt{\textasciitilde{}}. The confounding
variables are on the right side, separated by a \texttt{+} sign.

The final \texttt{glm()} function takes the following form:

\texttt{glm(x\ \textasciitilde{}\ a\ +\ b\ +\ c\ +\ d,\ data\ =\ data,\ family\ =\ "binomial")}

\hypertarget{setting-up-your-data}{%
\section{Setting up your data}\label{setting-up-your-data}}

The most important step to ensure a good basis to start from is to
ensure your variables are well structured and your outcome variable has
exactly two outcomes.

We will need to make sure our outcome variables and predictor variables
(the ones we want to adjust for) are suitably prepared.

In this example, the outcome variable called \texttt{status.factor}
describes whether patients died or not and will be our (dependent)
variable of interest.

\hypertarget{worked-example}{%
\subsection{Worked Example}\label{worked-example}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}

\KeywordTok{load}\NormalTok{(}\StringTok{"melanoma_factored.rda"}\NormalTok{)}
\CommentTok{#Load in data from the previous session}
\end{Highlighting}
\end{Shaded}

Here \texttt{status.factor} has three levels: \texttt{Died},
\texttt{Died\ -\ other\ causes} and \texttt{Alive}. This is not useful
for us, as logistic regression requires outcomes to be binary (exactly
two levels).

We want to find out which variables predict death from melanoma. So we
should create a new factor variable, \texttt{died\_melanoma.factor}.
This will have two outcomes, \texttt{Yes} (did die from melanoma) or
\texttt{No} (did not die from melanoma).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{status.factor }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fct_collapse}\NormalTok{(}\StringTok{"Yes"}\NormalTok{ =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Died"}\NormalTok{),}
               \StringTok{"No"}\NormalTok{  =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"Alive"}\NormalTok{, }\StringTok{"Died - other causes"}\NormalTok{)) ->}
\StringTok{  }\NormalTok{mydata}\OperatorTok{$}\NormalTok{died_melanoma.factor}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{died_melanoma.factor }\OperatorTok{%>%}\StringTok{ }\KeywordTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "No"  "Yes"
\end{verbatim}

\hypertarget{creating-categories}{%
\section{Creating categories}\label{creating-categories}}

Now that we have set up our outcome variable, we should ensure our
predictor variables are prepared too.

Remember the stages of melanoma? This is an important predictor of
melanoma Mortality based upon the scientific literature.

We should take this into account in our model.

\hypertarget{exercise-27}{%
\subsection{Exercise}\label{exercise-27}}

Create a new variable called \texttt{stage.factor} to encompass the
stages of melanoma based upon the thickness. In this data, the
\texttt{thickness} variable is measured in millimetres too.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#the cut() function makes a continuous variable into a categorical variable}
\NormalTok{mydata}\OperatorTok{$}\NormalTok{thickness }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{cut}\NormalTok{(}\DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{, }\KeywordTok{max}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{thickness, }\DataTypeTok{na.rm=}\NormalTok{T)),}
            \DataTypeTok{include.lowest =}\NormalTok{ T) ->}
\NormalTok{mydata}\OperatorTok{$}\NormalTok{stage.factor}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{stage.factor }\OperatorTok{%>%}\StringTok{ }\KeywordTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "[0,0.5]"  "(0.5,1]"  "(1,4]"    "(4,17.4]"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata}\OperatorTok{$}\NormalTok{stage.factor }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Stage I"}\NormalTok{   =}\StringTok{ "[0,0.5]"}\NormalTok{,}
             \StringTok{"Stage II"}\NormalTok{  =}\StringTok{ "(0.5,1]"}\NormalTok{,}
             \StringTok{"Stage III"}\NormalTok{ =}\StringTok{ "(1,4]"}\NormalTok{,}
             \StringTok{"Stage IV"}\NormalTok{  =}\StringTok{ "(4,17.4]"}
\NormalTok{    ) ->}\StringTok{ }\NormalTok{mydata}\OperatorTok{$}\NormalTok{stage.factor}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{stage.factor }\OperatorTok{%>%}\StringTok{ }\KeywordTok{levels}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "Stage I"   "Stage II"  "Stage III" "Stage IV"
\end{verbatim}

\hypertarget{always-plot-your-data-first}{%
\subsection{Always plot your data
first!}\label{always-plot-your-data-first}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{source}\NormalTok{(}\StringTok{"1_source_theme.R"}\NormalTok{)}

\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ sex.factor)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =}\NormalTok{ sex.factor))}
\end{Highlighting}
\end{Shaded}

\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-4-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ ulcer.factor)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =}\NormalTok{ ulcer.factor))}
\end{Highlighting}
\end{Shaded}

\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-5-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ stage.factor)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_bar}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =}\NormalTok{ stage.factor))}
\end{Highlighting}
\end{Shaded}

\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-6-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{ggplot}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ age)) }\OperatorTok{+}
\StringTok{  }\KeywordTok{geom_histogram}\NormalTok{(}\KeywordTok{aes}\NormalTok{(}\DataTypeTok{fill =}\NormalTok{ age))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
\end{verbatim}

\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-7-1.pdf}

Now we are ready for some modelling!

\hypertarget{basic-one-explanatory-variable-predictor}{%
\section{Basic: One explanatory variable
(predictor)}\label{basic-one-explanatory-variable-predictor}}

Lets find out what the influence of each predictor/confounding variable
is on mortality from melanoma, which may help inform a more complicated
regression, with multiple predictors/confounders.

We'll start with whether the patient was male or female:

\hypertarget{worked-example-1}{%
\subsection{Worked example}\label{worked-example-1}}

First we need to create a regression model using \texttt{glm()}. We will
then summarise it using \texttt{summary()}

Note, we need to use the \texttt{family} option. Specifying
\texttt{\textquotesingle{}binomial\textquotesingle{}} in \texttt{family}
tells \texttt{glm()} to switch to logistic regression.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Create a model}

\KeywordTok{glm}\NormalTok{(died_melanoma.factor }\OperatorTok{~}\StringTok{ }\NormalTok{sex.factor, }\DataTypeTok{data =}\NormalTok{ mydata, }\DataTypeTok{family =} \StringTok{"binomial"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:  glm(formula = died_melanoma.factor ~ sex.factor, family = "binomial", 
##     data = mydata)
## 
## Coefficients:
##    (Intercept)  sex.factorMale  
##         -1.253           0.708  
## 
## Degrees of Freedom: 204 Total (i.e. Null);  203 Residual
## Null Deviance:       242.4 
## Residual Deviance: 237.4     AIC: 241.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model1 =}\StringTok{ }\KeywordTok{glm}\NormalTok{(died_melanoma.factor }\OperatorTok{~}\StringTok{ }\NormalTok{sex.factor, }\DataTypeTok{data =}\NormalTok{ mydata, }\DataTypeTok{family =} \StringTok{"binomial"}\NormalTok{)}

\KeywordTok{summary}\NormalTok{(model1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## glm(formula = died_melanoma.factor ~ sex.factor, family = "binomial", 
##     data = mydata)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -0.9565  -0.7090  -0.7090   1.4157   1.7344  
## 
## Coefficients:
##                Estimate Std. Error z value Pr(>|z|)    
## (Intercept)     -1.2528     0.2143  -5.846 5.03e-09 ***
## sex.factorMale   0.7080     0.3169   2.235   0.0254 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 242.35  on 204  degrees of freedom
## Residual deviance: 237.35  on 203  degrees of freedom
## AIC: 241.35
## 
## Number of Fisher Scoring iterations: 4
\end{verbatim}

Now we have created the model - fantastic!

But this doesn't mean a lot to humans reading a paper - or us in fact.

The estimate output of \texttt{summary(model\_1)} represents the
logarithm of the odds ratio. The odds ratio would be a lot easier to
understand.

Therefore, to sort that out we should exponentiate the output of the
model! The \texttt{exp()} function will do this.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{exp}\NormalTok{(model1}\OperatorTok{$}\NormalTok{coefficients)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    (Intercept) sex.factorMale 
##      0.2857143      2.0300000
\end{verbatim}

This gives us an odds ratio of 2.03 for males. That is to say, males are
twice as likely to die from melanoma than females.

Now a confidence interval might be handy. As this will be the logarithm
of the confidence interval, we should exponentiate it to make it
understandable.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{exp}\NormalTok{(}\KeywordTok{confint}\NormalTok{(model1))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Waiting for profiling to be done...
\end{verbatim}

\begin{verbatim}
##                    2.5 %    97.5 %
## (Intercept)    0.1843592 0.4284939
## sex.factorMale 1.0914854 3.7938450
\end{verbatim}

The 2.5\% is the lower bound and the 97.5\% is the upper bound of the
95\% confidence interval.

So we can therefore say that being male doubles your chances of dying
from melanoma with an Odds Ratio of 2.03 (95\% confidence interval of
1.09 to 3.79)

\hypertarget{exercise-28}{%
\subsection{Exercise}\label{exercise-28}}

Repeat this for all the variables contained within the data,
particulary:

\texttt{stage.factor}, \texttt{age}, \texttt{ulcer.factor},
\texttt{thickness} and \texttt{age.factor}.

Write their odds ratios and 95\% confidence intervals down for the next
section!

Congratulations on building your first regression model in R!

\hypertarget{finalfit-package}{%
\section{Finalfit package}\label{finalfit-package}}

We have developed our \texttt{finalfit} package to help with advanced
regression modelling. We will introduce it here, but not go into detail.

See www.finalfit.org for more information and updates.

\hypertarget{summarise-a-list-of-variables-by-another-variable}{%
\section{Summarise a list of variables by another
variable}\label{summarise-a-list-of-variables-by-another-variable}}

We can use the \texttt{finalfit} package to summarise a list of
variables by another variable. This is very useful for ``Table 1'' in
many studies.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(finalfit)}
\NormalTok{dependent   =}\StringTok{ "died_melanoma.factor"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"age"}\NormalTok{, }\StringTok{"sex.factor"}\NormalTok{)}

\NormalTok{table_result =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summary_factorlist}\NormalTok{(dependent, explanatory, }\DataTypeTok{p =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{tabular}{l|l|r|r|r}
\hline
label & levels & No & Yes & p\\
\hline
age & Mean (SD) & 51.5 (16.1) & 55.1 (17.9) & 0.189\\
\hline
sex.factor & Female & 98 (77.8) & 28 (22.2) & 0.024\\
\hline
 & Male & 50 (63.3) & 29 (36.7) & \\
\hline
\end{tabular}

\hypertarget{finalfit-function-for-logistic-regression}{%
\section{\texorpdfstring{\texttt{finalfit} function for logistic
regression}{finalfit function for logistic regression}}\label{finalfit-function-for-logistic-regression}}

We can then use the \texttt{finalfit} function to run a logistic
regression analysis with similar syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent   =}\StringTok{ "died_melanoma.factor"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"sex.factor"}\NormalTok{)}

\NormalTok{model2 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory)}
\end{Highlighting}
\end{Shaded}

\begin{tabular}{l|l|r|r|r|r}
\hline
Dependent: died\_melanoma.factor &  & No & Yes & OR (univariable) & OR (multivariable)\\
\hline
sex.factor & Female & 98 (66.2) & 28 (49.1) & - & -\\
\hline
 & Male & 50 (33.8) & 29 (50.9) & 2.03 (1.09-3.79, p=0.025) & 2.03 (1.09-3.79, p=0.025)\\
\hline
\end{tabular}

\newpage

\hypertarget{adjusting-for-multiple-variables-in-r}{%
\section{Adjusting for multiple variables in
R}\label{adjusting-for-multiple-variables-in-r}}

Your first models only included one variable. It's time to scale them
up.

Multivariable models take multiple variables and estimates how each
variable predicts an event. It adjusts for the effects of each one, so
you end up with a model that calculates the adjusted effect estimate
(i.e.~the odds ratio), upon an outcome.

When you see the term `adjusted' in scientific papers, this is what it
means.

\hypertarget{worked-example-2}{%
\subsection{Worked Example}\label{worked-example-2}}

Lets adjust for \texttt{age} (as a continuous variable),
\texttt{sex.factor} and \texttt{stage.factor}. Then output them as odds
ratios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dependent   =}\StringTok{ "died_melanoma.factor"}
\NormalTok{explanatory =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"age"}\NormalTok{, }\StringTok{"sex.factor"}\NormalTok{, }\StringTok{"stage.factor"}\NormalTok{)}

\NormalTok{model3 =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory)}
\end{Highlighting}
\end{Shaded}

\begin{tabular}{l|l|r|r|r|r}
\hline
Dependent: died\_melanoma.factor &  & No & Yes & OR (univariable) & OR (multivariable)\\
\hline
age & Mean (SD) & 51.5 (16.1) & 55.1 (17.9) & 1.01 (0.99-1.03, p=0.163) & 1.01 (0.99-1.03, p=0.534)\\
\hline
sex.factor & Female & 98 (66.2) & 28 (49.1) & - & -\\
\hline
 & Male & 50 (33.8) & 29 (50.9) & 2.03 (1.09-3.79, p=0.025) & 1.62 (0.81-3.21, p=0.167)\\
\hline
stage.factor & Stage I & 18 (12.2) & 1 (1.8) & - & -\\
\hline
 & Stage II & 32 (21.6) & 5 (8.8) & 2.81 (0.41-56.12, p=0.362) & 2.83 (0.40-56.96, p=0.363)\\
\hline
 & Stage III & 75 (50.7) & 29 (50.9) & 6.96 (1.34-128.04, p=0.065) & 7.17 (1.37-132.38, p=0.061)\\
\hline
 & Stage IV & 23 (15.5) & 22 (38.6) & 17.22 (3.13-322.85, p=0.008) & 14.30 (2.54-270.31, p=0.014)\\
\hline
\end{tabular}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{or_plot}\NormalTok{(mydata, dependent, explanatory)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Waiting for profiling to be done...
## Waiting for profiling to be done...
## Waiting for profiling to be done...
\end{verbatim}

\begin{verbatim}
## Warning: Removed 2 rows containing missing values (geom_errorbarh).
\end{verbatim}

\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-17-1.pdf}

When we enter age into regression models, the effect estimate is
provided in terms of per unit increase. So in this case it's expressed
in terms of an odds ratio per year increase (i.e.~for every year in age
gained odds of death increases by 1.02).

\hypertarget{exercise-29}{%
\subsection{Exercise}\label{exercise-29}}

Create a regression that includes \texttt{ulcer.factor}.

\newpage

\hypertarget{advanced-fitting-the-best-model}{%
\section{Advanced: Fitting the best
model}\label{advanced-fitting-the-best-model}}

Now we have our preliminary model. We could leave it there.

However, when you publish research, you are often asked to supply a
measure of how well the model fitted the data.

There are different approaches to model fitting. Come to our course
HealthyR-Advanced: Practical Logistic Regression. At this we describe
use of the Akaike Information Criterion (AIC) and the C-statistic.

The C-statistic describes discrimination and anything over 0.60 is
considered good. The closer to 1.00 the C-statistic is, the better the
fit.

The AIC measure model fit with lower values indicating better fit.

These metrics are available here:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{finalfit}\NormalTok{(dependent, explanatory, }\DataTypeTok{metrics=}\OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Waiting for profiling to be done...
## Waiting for profiling to be done...
## Waiting for profiling to be done...
## Waiting for profiling to be done...
\end{verbatim}

\begin{verbatim}
## Setting levels: control = 0, case = 1
\end{verbatim}

\begin{verbatim}
## Setting direction: controls < cases
\end{verbatim}

\begin{verbatim}
## [[1]]
##   Dependent: died_melanoma.factor                    No         Yes
## 1                             age Mean (SD) 51.5 (16.1) 55.1 (17.9)
## 2                      sex.factor    Female   98 (66.2)   28 (49.1)
## 3                                      Male   50 (33.8)   29 (50.9)
## 4                    stage.factor   Stage I   18 (12.2)     1 (1.8)
## 5                                  Stage II   32 (21.6)     5 (8.8)
## 6                                 Stage III   75 (50.7)   29 (50.9)
## 7                                  Stage IV   23 (15.5)   22 (38.6)
##               OR (univariable)           OR (multivariable)
## 1    1.01 (0.99-1.03, p=0.163)    1.01 (0.99-1.03, p=0.534)
## 2                            -                            -
## 3    2.03 (1.09-3.79, p=0.025)    1.62 (0.81-3.21, p=0.167)
## 4                            -                            -
## 5   2.81 (0.41-56.12, p=0.362)   2.83 (0.40-56.96, p=0.363)
## 6  6.96 (1.34-128.04, p=0.065)  7.17 (1.37-132.38, p=0.061)
## 7 17.22 (3.13-322.85, p=0.008) 14.30 (2.54-270.31, p=0.014)
## 
## [[2]]
## [1] "Number in dataframe = 205, Number in model = 205, Missing = 0, AIC = 232.3, C-statistic = 0.708, H&L = Chi-sq(8) 3.63 (p=0.889)"
\end{verbatim}

\hypertarget{extra-material-diagnostics-plots}{%
\subsection{Extra material: Diagnostics
plots}\label{extra-material-diagnostics-plots}}

While outwith the objectives of this course, diagnostic plots for
\texttt{glm} models can be produced by:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(model1)}
\end{Highlighting}
\end{Shaded}

\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-19-1.pdf}
\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-19-2.pdf}
\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-19-3.pdf}
\includegraphics{09_logistic_regression_files/figure-latex/unnamed-chunk-19-4.pdf}

\hypertarget{time-to-event-data-and-survival}{%
\chapter{Time-to-event data and
survival}\label{time-to-event-data-and-survival}}

\hypertarget{data-4}{%
\section{Data}\label{data-4}}

The \texttt{boot::melanoma} dataset was introduced in chapter 7.

In the previous session, we used logistic regression to investigate
death by calculating odds ratios for different factors at a single point
in time.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(broom)}
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(survminer)}
\NormalTok{mydata =}\StringTok{ }\NormalTok{boot}\OperatorTok{::}\NormalTok{melanoma}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{status }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Died"}\NormalTok{ =}\StringTok{ "1"}\NormalTok{,}
                         \StringTok{"Alive"}\NormalTok{ =}\StringTok{ "2"}\NormalTok{,}
                         \StringTok{"Died - other causes"}\NormalTok{ =}\StringTok{ "3"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_relevel}\NormalTok{(}\StringTok{"Alive"}\NormalTok{) ->}\StringTok{ }\CommentTok{# move Alive to front (first factor level) }
\StringTok{    }\NormalTok{mydata}\OperatorTok{$}\NormalTok{status.factor    }\CommentTok{# so OR will be relative to that}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{sex }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Female"}\NormalTok{ =}\StringTok{ "0"}\NormalTok{,}
                         \StringTok{"Male"}\NormalTok{   =}\StringTok{ "1"}\NormalTok{) ->}
\StringTok{    }\NormalTok{mydata}\OperatorTok{$}\NormalTok{sex.factor}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{ulcer }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{factor}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{fct_recode}\NormalTok{(}\StringTok{"Present"}\NormalTok{ =}\StringTok{ "1"}\NormalTok{,}
                         \StringTok{"Absent"}\NormalTok{ =}\StringTok{ "0"}\NormalTok{) ->}\StringTok{ }
\StringTok{    }\NormalTok{mydata}\OperatorTok{$}\NormalTok{ulcer.factor}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{age }\OperatorTok{%>%}\StringTok{ }
\StringTok{    }\KeywordTok{cut}\NormalTok{(}\DataTypeTok{breaks =} \KeywordTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{,}\DecValTok{20}\NormalTok{,}\DecValTok{40}\NormalTok{,}\DecValTok{60}\NormalTok{,}\DecValTok{95}\NormalTok{), }\DataTypeTok{include.lowest=}\OtherTok{TRUE}\NormalTok{) ->}
\StringTok{    }\NormalTok{mydata}\OperatorTok{$}\NormalTok{age.factor}
\end{Highlighting}
\end{Shaded}

\hypertarget{kaplan-meier-survival-estimator}{%
\section{Kaplan-Meier survival
estimator}\label{kaplan-meier-survival-estimator}}

The Kaplan-Meier (KM) survival estimator is a non-parametric statistic
used to estimate the survival function from time-to-event data.

`Time' is time from event to last known status. This status could be the
event, for instance death. Or could be when the patient was last seen,
for instance at a clinic. In this circumstance the patient is considered
`censored'.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{survival_object =}\StringTok{ }\KeywordTok{Surv}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{time, mydata}\OperatorTok{$}\NormalTok{status.factor }\OperatorTok{==}\StringTok{ "Died"}\NormalTok{)}

\CommentTok{# It is often useful to convert days into years}
\NormalTok{survival_object =}\StringTok{ }\KeywordTok{Surv}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{time}\OperatorTok{/}\DecValTok{365}\NormalTok{, mydata}\OperatorTok{$}\NormalTok{status.factor }\OperatorTok{==}\StringTok{ "Died"}\NormalTok{)}

\CommentTok{# Investigate this:}
\KeywordTok{head}\NormalTok{(survival_object) }\CommentTok{# + marks censoring in this case "Died of other causes"}
\CommentTok{# Or that the follow-up ended and the patient is censored.}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.02739726+ 0.08219178+ 0.09589041+ 0.27123288+ 0.50684932  0.55890411
\end{verbatim}

\hypertarget{km-analysis-for-whole-cohort}{%
\subsection{KM analysis for whole
cohort}\label{km-analysis-for-whole-cohort}}

\hypertarget{model}{%
\subsection{Model}\label{model}}

The survival object is the first step to performing univariable and
multivariable survival analyses. A univariable model can then be fitted.

If you want to plot survival stratified by a single grouping variable,
you can substitute ``survival\_object \textasciitilde{} 1'' by
``survival\_object \textasciitilde{} factor''

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# For all patients}
\NormalTok{my_survfit =}\StringTok{ }\KeywordTok{survfit}\NormalTok{(survival_object }\OperatorTok{~}\StringTok{ }\DecValTok{1}\NormalTok{, }\DataTypeTok{data =}\NormalTok{ mydata)}
\NormalTok{my_survfit }\CommentTok{# 205 patients, 57 events}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call: survfit(formula = survival_object ~ 1, data = mydata)
## 
##       n  events  median 0.95LCL 0.95UCL 
##     205      57      NA      NA      NA
\end{verbatim}

\hypertarget{life-table}{%
\subsection{Life table}\label{life-table}}

A life table is the tabular form of a KM plot, which you may be familiar
with. It shows survival as a proportion, together with confidence
limits. The whole table is shown with, \texttt{summary(my\_survfit)}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{summary}\NormalTok{(my_survfit, }\DataTypeTok{times =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call: survfit(formula = survival_object ~ 1, data = mydata)
## 
##  time n.risk n.event survival std.err lower 95% CI upper 95% CI
##     0    205       0    1.000  0.0000        1.000        1.000
##     1    193       6    0.970  0.0120        0.947        0.994
##     2    183       9    0.925  0.0187        0.889        0.962
##     3    167      15    0.849  0.0255        0.800        0.900
##     4    160       6    0.818  0.0274        0.766        0.874
##     5    122       9    0.769  0.0303        0.712        0.831
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# 5 year survival is 77%}

\CommentTok{# Help is at hand}
\KeywordTok{help}\NormalTok{(summary.survfit)}
\end{Highlighting}
\end{Shaded}

\hypertarget{km-plot}{%
\subsection{KM plot}\label{km-plot}}

A KM plot can easily be generated using the \texttt{survminer} package.

For more information on how the survminer package draws this plot, or
how to modify it:
\url{http://www.sthda.com/english/wiki/survminer-r-package-survival-data-analysis-and-visualization}
and \url{https://github.com/kassambara/survminer}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survminer)}
\NormalTok{my_survplot =}\StringTok{ }\KeywordTok{ggsurvplot}\NormalTok{(my_survfit, }\DataTypeTok{data =}\NormalTok{ mydata,                 }
           \DataTypeTok{risk.table =} \OtherTok{TRUE}\NormalTok{,}
           \DataTypeTok{ggtheme =} \KeywordTok{theme_bw}\NormalTok{(),}
           \DataTypeTok{palette =} \StringTok{'Dark2'}\NormalTok{,}
           \DataTypeTok{conf.int =} \OtherTok{TRUE}\NormalTok{,}
           \DataTypeTok{pval=}\OtherTok{FALSE}\NormalTok{)}
\NormalTok{my_survplot}
\end{Highlighting}
\end{Shaded}

\includegraphics{10_survival_files/figure-latex/unnamed-chunk-5-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Note can also take `ggplot()` options. }
\NormalTok{my_survplot}\OperatorTok{$}\NormalTok{plot }\OperatorTok{+}\StringTok{ }
\StringTok{    }\KeywordTok{annotate}\NormalTok{(}\StringTok{'text'}\NormalTok{, }\DataTypeTok{x =} \DecValTok{5}\NormalTok{, }\DataTypeTok{y =} \FloatTok{0.25}\NormalTok{, }\DataTypeTok{label=}\StringTok{'Whole cohort'}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Here is an alternative plot in base R to compare. Not only does this
produce a more basic survival plot, but tailoring the plot can be more
difficult to achieve.

Furthermore, appending a life table (`risk.table') alongside the plot
can also be difficult, yet this is essential for interpretation.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot}\NormalTok{(my_survfit, }\DataTypeTok{mark.time=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{conf.int=}\OtherTok{TRUE}\NormalTok{, }
         \DataTypeTok{xlab=}\StringTok{"Time (years)"}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Survival"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{10_survival_files/figure-latex/unnamed-chunk-7-1.pdf}

\hypertarget{exercise-30}{%
\subsection{Exercise}\label{exercise-30}}

Using the above scripts, perform a univariable Kaplan Meier analysis to
determine if \texttt{ulcer.factor} influences overall survival. Hint:
\texttt{survival\_object\ \textasciitilde{}\ ulcer.factor}.

Try modifying the plot produced (see Help for ggsurvplot). For example:

\begin{itemize}
\tightlist
\item
  Add in a medial survival lines: \texttt{surv.median.line="hv"}
\item
  Alter the plot legend:
  \texttt{legend.title\ =\ "Ulcer\ Present",\ legend.labs\ =\ c("No",\ "Yes")}
\item
  Change the y-axis to a percentage:
  \texttt{ylab\ =\ "Probability\ of\ survival\ (\%)",\ surv.scale\ =\ "percent"}
\item
  Display follow-up up to 10 years, and change the scale to 1 year:
  \texttt{xlim\ =\ c(0,10),\ break.time.by\ =\ 1)}
\end{itemize}

\includegraphics{10_survival_files/figure-latex/unnamed-chunk-8-1.pdf}

\hypertarget{log-rank-test}{%
\subsection{Log-rank test}\label{log-rank-test}}

Two KM survival curves can be compared using the log-rank test. Note
survival curves can also be compared using a Wilcoxon test that may be
appropriate in some circumstances.

This can easily be performed in \texttt{library(survival)} using the
function \texttt{survdiff()}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{survdiff}\NormalTok{(survival_object }\OperatorTok{~}\StringTok{ }\NormalTok{ulcer.factor, }\DataTypeTok{data =}\NormalTok{ mydata)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## survdiff(formula = survival_object ~ ulcer.factor, data = mydata)
## 
##                        N Observed Expected (O-E)^2/E (O-E)^2/V
## ulcer.factor=Absent  115       16     35.8      10.9      29.6
## ulcer.factor=Present  90       41     21.2      18.5      29.6
## 
##  Chisq= 29.6  on 1 degrees of freedom, p= 5e-08
\end{verbatim}

Is there a signficiant difference between survival curves?

\hypertarget{cox-proportional-hazard-regression}{%
\section{Cox proportional hazard
regression}\label{cox-proportional-hazard-regression}}

\hypertarget{model-1}{%
\subsection{Model}\label{model-1}}

Multivariable survival analysis can be complex with parametric and
semi-parametric methods available. The latter is performed using a Cox
proportional hazard regression analysis.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Note several variables are now introduced into the model. }
\CommentTok{# Variables should be selected carefully based on published methods.  }

\NormalTok{my_hazard =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(survival_object}\OperatorTok{~}\NormalTok{sex.factor}\OperatorTok{+}\NormalTok{ulcer.factor}\OperatorTok{+}\NormalTok{age.factor, }\DataTypeTok{data=}\NormalTok{mydata)}
\KeywordTok{summary}\NormalTok{(my_hazard)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## coxph(formula = survival_object ~ sex.factor + ulcer.factor + 
##     age.factor, data = mydata)
## 
##   n= 205, number of events= 57 
## 
##                         coef exp(coef) se(coef)      z Pr(>|z|)    
## sex.factorMale       0.48249   1.62011  0.26835  1.798   0.0722 .  
## ulcer.factorPresent  1.38972   4.01372  0.29772  4.668 3.04e-06 ***
## age.factor(20,40]   -0.40628   0.66613  0.69339 -0.586   0.5579    
## age.factor(40,60]   -0.04513   0.95588  0.61334 -0.074   0.9414    
## age.factor(60,95]    0.17889   1.19588  0.62160  0.288   0.7735    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
##                     exp(coef) exp(-coef) lower .95 upper .95
## sex.factorMale         1.6201     0.6172    0.9575     2.741
## ulcer.factorPresent    4.0137     0.2491    2.2394     7.194
## age.factor(20,40]      0.6661     1.5012    0.1711     2.593
## age.factor(40,60]      0.9559     1.0462    0.2873     3.180
## age.factor(60,95]      1.1959     0.8362    0.3537     4.044
## 
## Concordance= 0.735  (se = 0.04 )
## Rsquare= 0.153   (max possible= 0.937 )
## Likelihood ratio test= 34.08  on 5 df,   p=2e-06
## Wald test            = 30.19  on 5 df,   p=1e-05
## Score (logrank) test = 35.21  on 5 df,   p=1e-06
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(broom)}
\KeywordTok{tidy}\NormalTok{(my_hazard)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 7
##   term            estimate std.error statistic   p.value conf.low conf.high
##   <chr>              <dbl>     <dbl>     <dbl>     <dbl>    <dbl>     <dbl>
## 1 sex.factorMale    0.482      0.268    1.80     7.22e-2  -0.0435     1.01 
## 2 ulcer.factorPr~   1.39       0.298    4.67     3.04e-6   0.806      1.97 
## 3 age.factor(20,~  -0.406      0.693   -0.586    5.58e-1  -1.77       0.953
## 4 age.factor(40,~  -0.0451     0.613   -0.0736   9.41e-1  -1.25       1.16 
## 5 age.factor(60,~   0.179      0.622    0.288    7.74e-1  -1.04       1.40
\end{verbatim}

The interpretation of the results of model fitting are beyond the aims
of this course. The exponentiated coefficient (\texttt{exp(coef)})
represents the hazard ratio. Therefore, patients with ulcers are 4-times
more likely to die at any given time than those without ulcers.

\hypertarget{assumptions-1}{%
\subsection{Assumptions}\label{assumptions-1}}

The CPH model presumes `constant hazards'. That means that the risk
associated with any given variable (like ulcer status) shouldn't get
worse or better over time. This can be checked.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ph =}\StringTok{ }\KeywordTok{cox.zph}\NormalTok{(my_hazard)}
\NormalTok{ph}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                        rho chisq      p
## sex.factorMale      -0.104 0.647 0.4212
## ulcer.factorPresent -0.238 3.135 0.0766
## age.factor(20,40]    0.110 0.716 0.3976
## age.factor(40,60]    0.194 2.222 0.1361
## age.factor(60,95]    0.146 1.257 0.2622
## GLOBAL                  NA 6.949 0.2244
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# GLOBAL shows no overall violation of assumptions. }
\CommentTok{# Ulcer.status is borderline significant}

\CommentTok{# Plot Schoenfield residuals to evaluate PH}
\KeywordTok{plot}\NormalTok{(ph, }\DataTypeTok{var=}\DecValTok{2}\NormalTok{) }\CommentTok{# ulcer.status is variable 2}
\end{Highlighting}
\end{Shaded}

\includegraphics{10_survival_files/figure-latex/unnamed-chunk-11-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# help(plot.cox.zph)}
\end{Highlighting}
\end{Shaded}

Hazard decreases a little between 2 and 5 years, but is acceptable.

\hypertarget{exercise-31}{%
\subsection{Exercise}\label{exercise-31}}

Create a new CPH model, but now include the variable \texttt{thickness}
as a variable. How would you interpret the output? Is it an independent
predictor of overall survival in this model? Are CPH assumptions
maintained?

\hypertarget{dates-in-r}{%
\section{Dates in R}\label{dates-in-r}}

\hypertarget{converting-dates-to-survival-time}{%
\subsection{Converting dates to survival
time}\label{converting-dates-to-survival-time}}

In the melanoma example dataset, we already had the time in a convenient
format for survial analysis - survival time in days since the operation.
This section shows how to convert dates into ``days from event''. First
we will generate a dummy operation date and censoring date based on the
melanoma data.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(lubridate)}
\NormalTok{first_date =}\StringTok{ }\KeywordTok{ymd}\NormalTok{(}\StringTok{"1966-01-01"}\NormalTok{)           }\CommentTok{# let's create made-up dates for the operations}
\NormalTok{last_date =}\StringTok{ }\NormalTok{first_date }\OperatorTok{+}\StringTok{ }\KeywordTok{days}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(mydata)}\OperatorTok{-}\DecValTok{1}\NormalTok{) }\CommentTok{# assume tone every day from 1-Jan 1966}
\NormalTok{operation_date =}\StringTok{ }\KeywordTok{seq}\NormalTok{(}\DataTypeTok{from =}\NormalTok{ first_date, }\DataTypeTok{to =}\NormalTok{ last_date, }\DataTypeTok{by =} \StringTok{"1 day"}\NormalTok{) }\CommentTok{# create dates}

\NormalTok{mydata}\OperatorTok{$}\NormalTok{operation_date =}\StringTok{ }\NormalTok{operation_date }\CommentTok{# add the created sequence to melanoma dataset}
\end{Highlighting}
\end{Shaded}

Now we will to create a `censoring' date by adding \texttt{time} from
the melanoma dataset to our made up operation date.

Remember the censoring date is either when an event occurred
(e.g.~death) or the last known alive status of the patient.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{censoring_date =}\NormalTok{ operation_date }\OperatorTok{+}\StringTok{ }\KeywordTok{days}\NormalTok{(time))}

\CommentTok{# (Same as doing:):}
\NormalTok{mydata}\OperatorTok{$}\NormalTok{censoring_date =}\StringTok{ }\NormalTok{mydata}\OperatorTok{$}\NormalTok{operation_date }\OperatorTok{+}\StringTok{ }\KeywordTok{days}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{time)}
\end{Highlighting}
\end{Shaded}

Now consider if we only had the \texttt{operation\ date} and
\texttt{censoring\ date}. We want to create the \texttt{time} variable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mydata =}\StringTok{ }\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{time_days =}\NormalTok{ censoring_date }\OperatorTok{-}\StringTok{ }\NormalTok{operation_date)}
\end{Highlighting}
\end{Shaded}

The \texttt{Surv()} function expects a number (\texttt{numeric}
variable), rather than a \texttt{date} object, so we'll convert it:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Surv(mydata$time_days, mydata$status==1) # this doesn't work}

\NormalTok{mydata }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{time_days_numeric =} \KeywordTok{as.numeric}\NormalTok{(time_days))  ->}
\StringTok{  }\NormalTok{mydata}

\NormalTok{survival_object =}\StringTok{ }\KeywordTok{Surv}\NormalTok{(mydata}\OperatorTok{$}\NormalTok{time_days_numeric, mydata}\OperatorTok{$}\NormalTok{status.factor }\OperatorTok{==}\StringTok{ "Died"}\NormalTok{) }\CommentTok{# this works as expected}
\end{Highlighting}
\end{Shaded}

\hypertarget{solutions-3}{%
\section{Solutions}\label{solutions-3}}

\textbf{9.2.2}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Fit survival model}
\NormalTok{my_survfit.solution =}\StringTok{ }\KeywordTok{survfit}\NormalTok{(survival_object }\OperatorTok{~}\StringTok{ }\NormalTok{ulcer.factor, }\DataTypeTok{data =}\NormalTok{ mydata)}

\CommentTok{# Show results}
\NormalTok{my_survfit.solution}
\KeywordTok{summary}\NormalTok{(my_survfit.solution, }\DataTypeTok{times=}\KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{))}

\CommentTok{# Plot results}
\NormalTok{my_survplot.solution =}\StringTok{ }\KeywordTok{ggsurvplot}\NormalTok{(my_survfit.solution,}
                         \DataTypeTok{data =}\NormalTok{ mydata,}
                         \DataTypeTok{palette =} \StringTok{'Dark2'}\NormalTok{,}
                         \DataTypeTok{risk.table =} \OtherTok{TRUE}\NormalTok{,}
                         \DataTypeTok{ggtheme =} \KeywordTok{theme_bw}\NormalTok{(),}
                         \DataTypeTok{conf.int =} \OtherTok{TRUE}\NormalTok{,}
                         \DataTypeTok{pval=}\OtherTok{TRUE}\NormalTok{,}
                         
                         \CommentTok{# Add in a medial survival line.}
                         \DataTypeTok{surv.median.line=}\StringTok{"hv"}\NormalTok{,}

                         \CommentTok{# Alter the plot legend (change the names)}
                         \DataTypeTok{legend.title =} \StringTok{"Ulcer Present"}\NormalTok{, }
                         \DataTypeTok{legend.labs =} \KeywordTok{c}\NormalTok{(}\StringTok{"No"}\NormalTok{, }\StringTok{"Yes"}\NormalTok{),}
                        
                         \CommentTok{# Change the y-axis to a percentage}
                         \DataTypeTok{ylab =} \StringTok{"Probability of survival (%)"}\NormalTok{,}
                         \DataTypeTok{surv.scale =} \StringTok{"percent"}\NormalTok{,}

                         \CommentTok{# Display follow-up up to 10 years, and change the scale to 1 year}
                         \DataTypeTok{xlab =} \StringTok{"Time (years)"}\NormalTok{,}
                         \CommentTok{# present narrower X axis, but not affect survival estimates.}
                         \DataTypeTok{xlim =} \KeywordTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{10}\NormalTok{),}
                         \CommentTok{# break X axis in time intervals by 1 year}
                         \DataTypeTok{break.time.by =} \DecValTok{1}\NormalTok{)    }

\NormalTok{my_survplot.solution}
\end{Highlighting}
\end{Shaded}

\textbf{9.3.3}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Fit model}
\NormalTok{my_hazard =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(survival_object}\OperatorTok{~}\NormalTok{sex.factor}\OperatorTok{+}\NormalTok{ulcer.factor}\OperatorTok{+}\NormalTok{age.factor}\OperatorTok{+}\NormalTok{thickness, }\DataTypeTok{data=}\NormalTok{mydata)}
\KeywordTok{summary}\NormalTok{(my_hazard)}

\CommentTok{# Melanoma thickness has a HR 1.12 (1.04 to 1.21). }
\CommentTok{# This is interpretted as a 12% increase in the}
\CommentTok{# risk of death at any time for each 1 mm increase in thickness. }

\CommentTok{# Check assumptions}
\NormalTok{ph =}\StringTok{ }\KeywordTok{cox.zph}\NormalTok{(my_hazard)}
\NormalTok{ph}
\CommentTok{# GLOBAL shows no overall violation of assumptions. }
\CommentTok{# Plot Schoenfield residuals to evaluate PH}
\KeywordTok{plot}\NormalTok{(ph, }\DataTypeTok{var=}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{part-workflow}{%
\part{Workflow}\label{part-workflow}}

\hypertarget{notebooks-and-markdown}{%
\chapter{Notebooks and markdown}\label{notebooks-and-markdown}}

\hypertarget{missing-data}{%
\chapter{Missing data}\label{missing-data}}

\hypertarget{encryption}{%
\chapter{Encryption}\label{encryption}}

\hypertarget{exporting-tables-and-plots}{%
\chapter{Exporting tables and plots}\label{exporting-tables-and-plots}}

\hypertarget{rstudio-settings-good-practise}{%
\chapter{RStudio settings, good
practise}\label{rstudio-settings-good-practise}}

\hypertarget{script-vs-console}{%
\section{Script vs Console}\label{script-vs-console}}

Throughout this course, don't copy or type code directly into the
Console. We will only be using the Console for viewing output, warnings,
and errors. All code should be in a script and executed (=run) using
Ctrl+Enter (line or section) or Ctrl+Shift+Enter (whole script). Make
sure you are always working in a project (the right-top corner of your
RStudio interface should say ``HealthyR'').

\hypertarget{starting-with-a-blank-canvas}{%
\section{Starting with a blank
canvas}\label{starting-with-a-blank-canvas}}

In the first session we loaded some data that we then plotted. When we
import data, R stores it and displays it in the Environment tab.

It's good practice to restart R before commencing new work. This is to
avoid accidentally using the wrong data or functions stored in the
environment.\\
Restarting R only takes a second!

\begin{itemize}
\tightlist
\item
  Restart R (Ctrl+Shift+F10 or select it from Session -\textgreater{}
  Restart R).
\end{itemize}

RStudio has a default setting that is no longer considered best
practice. You should do this once:

\begin{itemize}
\tightlist
\item
  Go to Tools -\textgreater{} Global Options -\textgreater{} General and
  set ``Save .RData on exit'' to Never. This does not mean you can't or
  shouldn't save your work in .RData files. But it is best to do it
  consciously and load exactly what you need to load, rather than
  letting R always save and load everything for you, as this could also
  include broken data or objects.
\end{itemize}

\bibliography{book.bib,packages.bib}

\backmatter
\printindex

\end{document}
